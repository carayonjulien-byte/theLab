<!doctype html>

<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ToDoGolf Lab — Analyse Radar</title>
  <style>
    :root { --bg:#0b1020; --card:#121935; --muted:#8ea0ff; --accent:#4de2c9; --text:#eef2ff; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020 0%,#0c1230 100%);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    .wrap{max-width:960px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.35);padding:20px}
    h1{font-size:28px;margin:0 0 8px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label{font-weight:600}
    input[type="text"],input[type="number"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1530;color:var(--text)}
    input[type="file"]{display:block}
    button{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;font-weight:700}
    .primary{background:var(--accent);color:#062822}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,.16);color:var(--text)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid rgba(255,255,255,.16);border-radius:999px}
    .drop{border:2px dashed rgba(255,255,255,.18);border-radius:16px;padding:20px;text-align:center;background:#0f1530}
    .drop.drag{border-color:var(--accent);background:#0d1a3a}
    .preview{max-width:100%;max-height:360px;border-radius:12px;border:1px solid rgba(255,255,255,.12)}
    .table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.09);text-align:right}
    .table th:first-child,.table td:first-child{text-align:left}
    .badge{background:#0f2048;border:1px solid rgba(255,255,255,.16);padding:3px 8px;border-radius:8px}
    .hint{font-size:12px;color:#aab4ff}
    #status{white-space:pre-wrap}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:16px">
      <h1>ToDoGolf Lab — Analyse Radar</h1>
      <div class="muted">Importer une photo, renseigner la distance cible, et récupérer le CSV.</div>
    </div><div class="card">
  <div class="grid">
    <div>
      <div id="drop" class="drop">
        <strong>Glissez-déposez</strong> votre image ici<br>
        ou <br>
        <input id="file" type="file" accept="image/*" />
        <div class="hint" style="margin-top:8px">Formats: JPG/PNG. Taille max conseillée: &lt; 10 Mo</div>
      </div>
      <div style="margin-top:12px" class="row">
        <img id="preview" class="preview hidden" alt="aperçu image" />
      </div>
    </div>
    <div>
      <div class="row">
        <label for="centre">Distance cible (m)</label>
        <input id="centre" type="number" step="0.1" placeholder="ex: 100" />
      </div>
      <div class="row" style="margin-top:8px">
        <label for="club">Club (optionnel)</label>
        <input id="club" type="text" placeholder="ex: Fer7" />
      </div>
      <div class="row" style="margin-top:8px">
        <label for="api">API URL</label>
        <input id="api" type="text" placeholder="ex: https://todogolf-analyse.onrender.com" />
      </div>
      <div class="row" style="margin-top:8px">
        <label for="apikey">Clé API (optionnel)</label>
        <input id="apikey" type="text" placeholder="X-API-Key si activée côté serveur" />
      </div>
      <div class="row" style="margin-top:16px; gap:8px">
        <button id="analyze" class="primary">Analyser l'image</button>
        <button id="showMask" class="ghost" type="button">Voir le masque</button>
        <button id="downloadCsv" class="ghost" type="button" disabled>Télécharger CSV</button>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="pill"><span id="counter">0</span> coups</span>
        <span class="pill">échelle: <span id="scale" class="badge">—</span></span>
      </div>
    </div>
  </div>
</div>

<div class="card" style="margin-top:16px">
  <h3 style="margin-top:0">Résultats</h3>
  <div id="status" class="muted">Aucun résultat pour l’instant.</div>
  <div style="overflow:auto; margin-top:10px">
    <table id="results" class="table hidden">
      <thead>
        <tr>
          <th>#</th>
          <th>Distance totale (m)</th>
          <th>Latéral (m)</th>
          <th>Profondeur (m)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

  </div><script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const fileEl = $("file");
  const dropEl = $("drop");
  const preview = $("preview");
  const btnAnalyze = $("analyze");
  const btnCsv = $("downloadCsv");
  const btnMask = $("showMask");
  const tbl = $("results");
  const tbody = tbl.querySelector("tbody");
  const status = $("status");
  const counter = $("counter");
  const scale = $("scale");
  const apiUrl = $("api");
  const apikey = $("apikey");
  const centre = $("centre");
  const club = $("club");

  // defaults (tu peux préremplir ici pour gagner du temps en dev)
  apiUrl.value = apiUrl.value || "https://todogolf-analyse.onrender.com";

  let lastJson = null;

  function setStatus(msg){ status.textContent = msg; }
  function showTable(show){ tbl.classList.toggle("hidden", !show); }
  function showPreview(file){
    if(!file){ preview.classList.add("hidden"); return; }
    const url = URL.createObjectURL(file);
    preview.src = url;
    preview.onload = ()=> URL.revokeObjectURL(url);
    preview.classList.remove("hidden");
  }

  // Drag & drop UX
  ["dragenter","dragover"].forEach(ev=>dropEl.addEventListener(ev, e=>{e.preventDefault();dropEl.classList.add("drag");}));
  ;["dragleave","drop"].forEach(ev=>dropEl.addEventListener(ev, e=>{e.preventDefault();dropEl.classList.remove("drag");}));
  dropEl.addEventListener("drop", (e)=>{ const f=e.dataTransfer.files?.[0]; if(f){ fileEl.files = e.dataTransfer.files; showPreview(f);} });
  fileEl.addEventListener("change", (e)=>{ const f=e.target.files?.[0]; showPreview(f); });

  async function analyze(){
    const file = fileEl.files?.[0];
    if(!file){ alert("Choisis une image d'abord" ); return; }
    const base = apiUrl.value.replace(/\/$/,"");
    const url = base + "/analyze";

    const fd = new FormData();
    fd.append("image", file);
    if(centre.value) fd.append("centre_distance", centre.value);
    if(club.value) fd.append("club", club.value);

    const headers = {};
    if(apikey.value) headers["X-API-Key"] = apikey.value;

    setStatus("Analyse en cours…");
    btnAnalyze.disabled = true; btnCsv.disabled = true; showTable(false);

    try{
      const res = await fetch(url, { method:"POST", body: fd, headers });
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch(e){ throw new Error("Réponse non JSON: \n" + text.slice(0,500)); }
      if(!res.ok){
        throw new Error((json && json.error) ? json.error : ("Erreur API: status " + res.status));
      }
      lastJson = json;
      hydrateResults(json);
      setStatus("Analyse OK. " + (json.nb_coups ?? 0) + " coup(s) détecté(s).\n" + (json.debug ? ("échelle: " + (json.debug.ring_step_m||"?") + " m") : ""));
      btnCsv.disabled = (json.nb_coups||0) === 0;
    }catch(err){
      console.error(err);
      setStatus("❌ " + err.message);
      lastJson = null; btnCsv.disabled = true; showTable(false);
    }finally{
      btnAnalyze.disabled = false;
    }
  }

  function hydrateResults(json){
    const coups = json.coups || [];
    counter.textContent = String(coups.length);
    scale.textContent = json?.debug?.ring_step_m ? (json.debug.ring_step_m + " m/anneau") : "—";

    tbody.innerHTML = "";
    coups.forEach((c, i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${toNum(c.distance_totale_m)}</td>
        <td>${toNum(c.ecart_lateral_m)}</td>
        <td>${toNum(c.ecart_profondeur_m)}</td>
      `;
      tbody.appendChild(tr);
    });
    showTable(coups.length>0);
  }

  function toNum(v){
    if(v===null||v===undefined||v!==v) return "";
    const n = typeof v === 'number' ? v : Number(String(v).replace(',', '.'));
    return isFinite(n) ? n.toFixed(1) : String(v);
  }

  function toCsv(json){
    const coups = json?.coups || [];
    const rows = [];
    // header + meta première ligne
    rows.push(["club","centre_distance","nb_coups","ring_step_m"].join(","));
    rows.push([
      safe(json.club),
      safe(json.centre_distance),
      safe(json.nb_coups),
      safe(json?.debug?.ring_step_m)
    ].join(","));

    rows.push("");
    rows.push(["index","distance_totale_m","ecart_lateral_m","ecart_profondeur_m"].join(","));
    coups.forEach((c,i)=>{
      rows.push([i+1, c.distance_totale_m, c.ecart_lateral_m, c.ecart_profondeur_m].join(","));
    });
    return rows.join("\n");
  }

  function safe(v){ return (v===undefined||v===null)?"":String(v).replaceAll("\n"," ").replaceAll(",","."); }

  function downloadCsv(){
    if(!lastJson) return;
    const csv = toCsv(lastJson);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `todogolf-analyse-${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function showMask(){
    const file = fileEl.files?.[0];
    if(!file){ alert("Choisis une image d'abord"); return; }
    const base = apiUrl.value.replace(/\/$/,"");
    const url = base + "/mask";
    const fd = new FormData();
    fd.append("image", file);
    const headers = {};
    if(apikey.value) headers["X-API-Key"] = apikey.value;

    setStatus("Génération du masque…");
    try{
      const res = await fetch(url, { method:"POST", body: fd, headers });
      if(!res.ok) throw new Error("Erreur masque: status "+res.status);
      const blob = await res.blob();
      const urlObj = URL.createObjectURL(blob);
      preview.src = urlObj; preview.classList.remove("hidden");
      setStatus("Masque affiché ci‑dessus.");
    }catch(err){
      console.error(err); setStatus("❌ " + err.message);
    }
  }

  btnAnalyze.addEventListener("click", (e)=>{ e.preventDefault(); analyze(); });
  btnCsv.addEventListener("click", (e)=>{ e.preventDefault(); downloadCsv(); });
  btnMask.addEventListener("click", (e)=>{ e.preventDefault(); showMask(); });
})();
</script></body>
  </html>
