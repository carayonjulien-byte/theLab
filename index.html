<!doctype html>

<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Lab2DoGolf â€“ Capture & Analyse</title>
  <style>
    :root { --gap: 14px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: var(--gap); background:#0d0f12; color:#e7e8ea; }
    .wrap { max-width: 720px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .card { background:#14181d; border:1px solid #1e242c; border-radius: 14px; padding: 14px; }
    .row { margin-top: var(--gap); }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    label { font-size: 13px; color:#b8c0cc; margin-bottom:6px; display:block; }
    input[type=text], input[type=number] { width:100%; padding:12px 14px; border:1px solid #26303b; border-radius:12px; font-size:16px; background:#0e1318; color:#e7e8ea; }
    button, label[role=button] { display:inline-block; text-align:center; padding:12px 14px; border-radius:12px; border:1px solid #26303b; background:#1a2330; color:#e7e8ea; font-weight:600; cursor:pointer; }
    .primary { background:#2a6df2; border-color:#2a6df2; color:#fff; }
    .ghost { background:#11171e; }
    video, img { width: 100%; max-height: 60vh; object-fit: contain; background:#000; border-radius: 12px; }
    .hint { font-size: 12px; color:#9aa5b1; margin-top: 6px; }
    .result { background:#14181d; border:1px solid #1e242c; border-radius:14px; padding:14px; line-height:1.45; }
    .result h3 { margin: 0 0 8px 0; font-size: 18px; }
    .result .kv { display:flex; justify-content:space-between; padding:8px 0; border-top:1px dashed #26303b; }
    .result .kv:first-of-type { border-top: none; }
    .error { color:#ff6b6b; }
    .hidden{ display:none !important; }@media (max-width: 720px){
  .grid-2{grid-template-columns:1fr}
  .wrap{margin:16px auto}
  video, img{max-height:50vh}
  .row > button, .row > label[role="button"], .primary, .ghost{width:100%}
}

  </style>
</head>
<body>
  <div class="wrap">
    <h1>Lab2DoGolf â€“ Capture & Analyse</h1><div class="card">
  <div class="grid-2">
    <div class="row">
      <label for="dateText">Date (JJ/MM/AAAA)</label>
      <input id="dateText" type="text" inputmode="numeric" placeholder="JJ/MM/AAAA" maxlength="10" required />
      <div class="hint">PrÃ©remplie Ã  aujourd'hui</div>
    </div>
    <div class="row">
      <label for="club">Club</label>
      <input id="club" type="text" placeholder="ex: Fer7" required />
    </div>
  </div>

  <div class="grid-2">
    <div class="row">
      <label for="targetDist">Distance cible (m)</label>
      <input id="targetDist" type="number" step="1" min="0" value="100" required />
    </div>
  </div>

  <div class="row">
    <label role="button" for="file" class="ghost">ğŸ–¼ï¸ Importer une photo</label>
    <input id="file" type="file" accept="image/*" capture="environment" style="display:none;" />
  </div>

  <div class="row">
    <button id="openCam" class="ghost" type="button">ğŸ“· Prendre une photo</button>
  </div>

  <div id="camWrap" class="hidden row">
    <video id="video" playsinline autoplay muted></video>
    <div class="row" style="display:flex; gap:8px;">
      <button id="snap" class="primary" type="button">âœ… Capturer</button>
      <button id="closeCam" class="ghost" type="button">âœ–ï¸ Fermer</button>
    </div>
  </div>

  <div class="row">
    <img id="preview" class="hidden" alt="aperÃ§u image" />
  </div>

  <div class="grid-2 row">
    <button id="analyzeBtn" class="primary" type="button">ğŸ§  Analyser lâ€™image</button>
    <button id="maskBtn" class="ghost" type="button">ğŸŸ¦ Voir le masque</button>
  </div>

  <div class="row error" id="errorBox" hidden></div>
</div>

<div class="row result hidden" id="resultCard">
  <h3>RÃ©sultat dâ€™analyse</h3>
  <div class="kv"><div>Coup</div><div id="rCoup">â€”</div></div>
  <div class="kv"><div>Distance totale</div><div id="rDist">â€”</div></div>
  <div class="kv"><div>Ã‰cart latÃ©ral</div><div id="rLat">â€”</div></div>
  <div class="kv"><div>Ã‰cart profondeur</div><div id="rProf">â€”</div></div>
  <div class="kv"><div>Date</div><div id="rDate">â€”</div></div>
  <div class="kv"><div>Club</div><div id="rClub">â€”</div></div>
  <div class="kv"><div>Distance cible</div><div id="rTarget">â€”</div></div>
  <div class="row"><button id="csvBtn" class="ghost" type="button">â¬‡ï¸ TÃ©lÃ©charger CSV</button></div>
</div>

  </div>  <script>
  const API_BASE = "https://todogolf-analyse.onrender.com";
  const $ = (id)=> document.getElementById(id);
  const fileEl=$("file"),openCam=$("openCam"),camWrap=$("camWrap"),videoEl=$("video"),btnSnap=$("snap"),btnCloseCam=$("closeCam"),preview=$("preview"),analyzeBtn=$("analyzeBtn"),maskBtn=$("maskBtn"),errorBox=$("errorBox"),resultCard=$("resultCard"),rCoup=$("rCoup"),rDist=$("rDist"),rLat=$("rLat"),rProf=$("rProf"),rDate=$("rDate"),rClub=$("rClub"),rTarget=$("rTarget"),csvBtn=$("csvBtn"),dateText=$("dateText"),club=$("club"),targetDist=$("targetDist");
  let stream=null,currentBlob=null,lastJson=null;
  function setStatus(msg){if(!errorBox)return;errorBox.textContent=msg;errorBox.hidden=false;setTimeout(()=>errorBox.hidden=true,4000);}
  function show(el,on=true){el.classList[on?'remove':'add']('hidden');}
  function clampSize(w,h,max=1600){if(Math.max(w,h)<=max)return[Math.round(w),Math.round(h)];const s=max/Math.max(w,h);return[Math.round(w*s),Math.round(h*s)];}
  function todayStr(){const d=new Date();const dd=String(d.getDate()).padStart(2,'0');const mm=String(d.getMonth()+1).padStart(2,'0');const yyyy=d.getFullYear();return`${dd}/${mm}/${yyyy}`;}
  if(dateText&&!dateText.value)dateText.value=todayStr();
  dateText?.addEventListener('input',e=>{let v=e.target.value.replace(/\D/g,'').slice(0,8);if(v.length>=5)v=v.replace(/^(\d{2})(\d{2})(\d{1,4})$/,'$1/$2/$3');else if(v.length>=3)v=v.replace(/^(\d{2})(\d{1,2})$/,'$1/$2');e.target.value=v;});
  function showPreview(fileOrBlob){if(!fileOrBlob){preview.classList.add("hidden");return;}const url=URL.createObjectURL(fileOrBlob);preview.src=url;preview.onload=()=>URL.revokeObjectURL(url);preview.classList.remove("hidden");}
  function safe(v){if(v==null)return'';if(typeof v==='number'&&!Number.isFinite(v))return'';return String(v).replace(/[\n\r,]/g,' ');}
  function toCsv(json){const coups=json?.coups||[];const rows=[];rows.push(['index','date_text','club','centre_distance','distance_totale_m','ecart_lateral_m','ecart_profondeur_m'].join(','));const dateVal=dateText?.value||'';const clubVal=safe(json.club);const centreVal=safe(json.centre_distance);coups.forEach((c,i)=>{rows.push([i+1,safe(dateVal),clubVal,centreVal,safe(c.distance_totale_m),safe(c.ecart_lateral_m),safe(c.ecart_profondeur_m)].join(','));});return rows.join('\n');}
  fileEl.addEventListener('change',e=>{const file=e.target.files&&e.target.files[0];if(!file)return;currentBlob=file;showPreview(currentBlob);show(resultCard,false);});
  openCam.addEventListener('click',async()=>{try{stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});videoEl.srcObject=stream;show(camWrap,true);preview.classList.add('hidden');setStatus('CamÃ©ra ouverte.');}catch(err){setStatus('âŒ CamÃ©ra indisponible : '+err.message);}});
  btnCloseCam.addEventListener('click',()=>{if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}show(camWrap,false);setStatus('CamÃ©ra fermÃ©e.');});
  btnSnap.addEventListener('click',async()=>{if(!stream)return;const vw=videoEl.videoWidth,vh=videoEl.videoHeight;const[tw,th]=clampSize(vw,vh,1600);const canvas=document.createElement('canvas');canvas.width=tw;canvas.height=th;const ctx=canvas.getContext('2d');ctx.drawImage(videoEl,0,0,tw,th);currentBlob=await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.9));if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}show(camWrap,false);showPreview(currentBlob);setStatus('Photo capturÃ©e.');});
  async function analyze(){if(!dateText.value||!club.value||!targetDist.value){setStatus('Remplissez la date, le club et la distance cible.');return;}const file=currentBlob||fileEl.files?.[0];if(!file){setStatus("Ajoute ou capture une photo d'abord.");return;}const url=API_BASE+'/analyze';const fd=new FormData();fd.append('file', file, (file.name||'capture.jpg'));fd.append('date_text',dateText.value);fd.append('club',club.value);fd.append('centre_distance',targetDist.value);try{const res=await fetch(url,{method:'POST',body:fd});if(!res.ok){let t='';try{t=await res.text();}catch(_){}throw new Error('HTTP '+res.status+(t?' â€“ '+t:''));}const data=await res.json();lastJson=data;rCoup.textContent=safe(data.coup);rDist.textContent=safe(data.distance_totale_m)+' m';rLat.textContent=safe(data.ecart_lateral_m)+' m';rProf.textContent=safe(data.ecart_profondeur_m)+' m';rDate.textContent=dateText.value;rClub.textContent=club.value;rTarget.textContent=targetDist.value+' m';show(resultCard,true);}catch(err){setStatus('Analyse impossible : '+err.message);}}
  analyzeBtn.addEventListener('click',analyze);
  async function showMask(){const file=currentBlob||fileEl.files?.[0];if(!file){setStatus("Ajoute ou capture une photo d'abord.");return;}const url=API_BASE+'/mask';const fd=new FormData();fd.append('file', file, (file.name||'capture.jpg'));try{const res=await fetch(url,{method:'POST',body:fd});if(!res.ok){let t='';try{t=await res.text();}catch(_){}throw new Error('HTTP '+res.status+(t?' â€“ '+t:''));}const blob=await res.blob();showPreview(blob);}catch(err){setStatus('Masque indisponible : '+err.message);}}
  maskBtn.addEventListener('click',showMask);
  function downloadCsv(name,content){const blob=new Blob([content],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}
  csvBtn.addEventListener('click',()=>{if(!lastJson){setStatus('Fais une analyse d\'abord.');return;}const csv=toCsv(lastJson);const d=new Date();const yyyy=d.getFullYear();const mm=String(d.getMonth()+1).padStart(2,'0');const dd=String(d.getDate()).padStart(2,'0');const name=`todogolf-analyse-${yyyy}-${mm}-${dd}.csv`;downloadCsv(name,csv);});
  </script></body>
</html>
