<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Lab2DoGolf ‚Äì Capture</title>
  <style>
    :root { --gap: 14px; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: var(--gap); background:#f7f7f8; }
    .wrap { max-width: 720px; margin: 0 auto; }
    .actions { display: grid; gap: var(--gap); grid-template-columns: 1fr 1fr; }
    button, label[role="button"] {
      display: inline-block; text-align: center; padding: 14px 16px; border-radius: 14px;
      border: none; background:#111; color:#fff; font-weight:600; font-size:16px;
    }
    input[type=file]{ display:none; }
    video, img { width: 100%; max-height: 60vh; object-fit: contain; background:#000; border-radius: 12px; }
    .hint { font-size: 13px; color:#555; margin-top: 6px; }
    .row { margin-top: var(--gap); }
    .field { display:flex; flex-direction:column; gap:8px; }
    .text-input {
      width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:12px; font-size:16px; background:#fff;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Lab2DoGolf ‚Äì Capture</h1>

    <!-- Champ texte Date (JJ/MM/AAAA) -->
    <div class="row field">
      <label for="dateText">Date (JJ/MM/AAAA)</label>
      <input id="dateText" class="text-input" inputmode="numeric" autocomplete="off" placeholder="JJ/MM/AAAA" maxlength="10">
      <div class="hint">Format libre texte avec auto-mise en forme. Exemple : 12/11/2025</div>
    </div>

    <div class="row actions">
      <button id="openCamBtn">üì∑ Prendre une photo</button>
      <label role="button" for="file" id="fileBtn">üñºÔ∏è Importer une photo</label>
      <input id="file" type="file" accept="image/*" capture="environment">
    </div>
    <p class="hint">Astuce : si la cam√©ra ne s‚Äôouvre pas, utilisez ‚ÄúImporter une photo‚Äù ‚Äî sur iPhone, iOS propose ‚ÄúPrendre une photo‚Äù.</p>

    <div class="row" id="liveWrap" hidden>
      <video id="video" playsinline autoplay></video>
      <div class="actions" style="margin-top:var(--gap);">
        <button id="snapBtn">‚úÖ Capturer</button>
        <button id="closeCamBtn" style="background:#555;">‚úñÔ∏è Fermer</button>
      </div>
    </div>

    <div class="row" id="previewWrap" hidden>
      <img id="preview" alt="Pr√©visualisation"/>
      <div class="hint">Image compress√©e pour upload rapide (max 1600 px).</div>
      <div class="hint" id="dateEcho"></div>
    </div>
  </div>

  <script>
    const openCamBtn  = document.getElementById('openCamBtn');
    const closeCamBtn = document.getElementById('closeCamBtn');
    const snapBtn     = document.getElementById('snapBtn');
    const fileInput   = document.getElementById('file');
    const video       = document.getElementById('video');
    const liveWrap    = document.getElementById('liveWrap');
    const previewWrap = document.getElementById('previewWrap');
    const previewImg  = document.getElementById('preview');
    const dateInput   = document.getElementById('dateText');
    const dateEcho    = document.getElementById('dateEcho');

    let stream;

    // --- Auto-format JJ/MM/AAAA sur un champ texte ---
    dateInput.addEventListener('input', (e)=>{
      let v = e.target.value.replace(/\D/g,'').slice(0,8); // chiffres uniquement, max 8
      if (v.length >= 5) v = v.replace(/^(\d{2})(\d{2})(\d{1,4})$/, '$1/$2/$3');
      else if (v.length >= 3) v = v.replace(/^(\d{2})(\d{1,2})$/, '$1/$2');
      e.target.value = v;
    });

    function maxSize(w, h, max=1600){
      if (Math.max(w,h) <= max) return [w,h];
      const scale = max / Math.max(w,h);
      return [Math.round(w*scale), Math.round(h*scale)];
    }

    async function blobFromImageBitmap(bitmap, type='image/jpeg', quality=0.85){
      const canvas = document.createElement('canvas');
      const [tw, th] = maxSize(bitmap.width, bitmap.height, 1600);
      canvas.width = tw; canvas.height = th;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, tw, th);
      return await new Promise(res => canvas.toBlob(res, type, quality));
    }

    async function blobFromFile(file){
      try {
        const bitmap = await createImageBitmap(file, { imageOrientation: 'from-image' });
        return await blobFromImageBitmap(bitmap);
      } catch {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();
        const canvas = document.createElement('canvas');
        const [tw, th] = maxSize(img.naturalWidth, img.naturalHeight, 1600);
        canvas.width = tw; canvas.height = th;
        canvas.getContext('2d').drawImage(img, 0, 0, tw, th);
        return await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.85));
      }
    }

    function show(el, on=true){ el.hidden = !on; }
    function echoDate(){
      const d = dateInput.value.trim();
      dateEcho.textContent = d ? `Date associ√©e : ${d}` : '';
    }

    // File input path
    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const outBlob = await blobFromFile(file);
      const url = URL.createObjectURL(outBlob);
      previewImg.src = url;
      show(previewWrap, true);
      echoDate();

      // Exemple d‚Äôenvoi (si tu en as besoin) :
      // const fd = new FormData();
      // fd.append('file', outBlob, 'photo.jpg');
      // fd.append('date_text', dateInput.value);
      // fetch('/upload', { method: 'POST', body: fd });
    });

    // Camera path
    openCamBtn.addEventListener('click', async ()=>{
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } }, audio: false
        });
        video.srcObject = stream;
        show(liveWrap, true);
        show(previewWrap, false);
      } catch (err){
        alert("Impossible d'ouvrir la cam√©ra. Essayez ‚ÄúImporter une photo‚Äù.\n" + err.message);
      }
    });

    closeCamBtn.addEventListener('click', ()=>{
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      show(liveWrap, false);
    });

    snapBtn.addEventListener('click', async ()=>{
      if(!stream) return;
      const vw = video.videoWidth, vh = video.videoHeight;
      const [tw, th] = maxSize(vw, vh, 1600);
      const canvas = document.createElement('canvas');
      canvas.width = tw; canvas.height = th;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, tw, th);
      const outBlob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.85));
      const url = URL.createObjectURL(outBlob);
      previewImg.src = url;
      show(previewWrap, true);
      echoDate();

      // Exemple d‚Äôenvoi :
      // const fd = new FormData();
      // fd.append('file', outBlob, 'photo.jpg');
      // fd.append('date_text', dateInput.value);
      // fetch('/upload', { method: 'POST', body: fd });
    });

    // Petite am√©lioration UX iOS
    document.addEventListener('gesturestart', e => e.preventDefault());
  </script>
</body>
</html>
