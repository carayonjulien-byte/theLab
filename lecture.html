<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Lab by ToDoGolf ‚Äì Lecture Radar</title>
  <style>
    :root {
      --gap: 14px;
      --primary: #00503a;
      --bg: #050608;
      --card: #0f1419;
      --border: #182028;
      --text: #e7e8ea;
      --muted: #b8c0cc;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
    }
    .hidden { display:none !important; }

    /* Topbar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(to bottom, #050608, rgba(5,6,8,0.9));
      border-bottom: 1px solid #121822;
      padding: 10px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .top-left {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-dot {
      width:20px;
      height:20px;
      border-radius:999px;
      background:var(--primary);
      box-shadow:0 0 12px rgba(0,80,58,0.7);
    }
    .top-title {
      font-weight:600;
      font-size:15px;
    }
    .top-sub {
      font-size:11px;
      color:#8b9aaa;
    }
    .btn-top {
      border-radius:999px;
      border:1px solid #26303b;
      background:#0b1016;
      padding:6px 10px;
      font-size:12px;
      color:var(--text);
      cursor:pointer;
      text-decoration:none;
    }
    .btn-top:hover { background:#101822; }

    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 40px;
    }

    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,0.4);
    }
    .row { margin-top: var(--gap); }
    .grid-2 {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:var(--gap);
    }
    label {
      font-size: 13px;
      color:#b8c0cc;
      margin-bottom:6px;
      display:block;
    }
    input[type=text],
    input[type=number] {
      width:100%;
      padding:12px 14px;
      border:1px solid #26303b;
      border-radius:12px;
      font-size:16px;
      background:#05080c;
      color:var(--text);
    }
    button,
    label[role=button] {
      display:inline-block;
      text-align:center;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid #26303b;
      background:#11171e;
      color:var(--text);
      font-weight:600;
      cursor:pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s;
    }
    button:active,
    label[role=button]:active {
      transform: scale(0.97);
      box-shadow:none;
    }
    button:disabled {
      opacity:0.55;
      cursor:not-allowed;
      box-shadow:none;
    }
    .primary {
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
      box-shadow:0 6px 16px rgba(0,80,58,0.5);
    }
    .primary:hover:not(:disabled) {
      background:#046046;
    }
    .ghost {
      background:#0b1016;
    }
    img {
      width: 100%;
      max-height: 60vh;
      object-fit: contain;
      background:#000;
      border-radius: 16px;
      border:1px solid #1b232c;
    }
    .hint {
      font-size: 12px;
      color:#9aa5b1;
      margin-top: 6px;
    }

    .result {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      line-height:1.45;
      box-shadow: 0 8px 22px rgba(0,0,0,0.4);
    }
    .result h3 { margin: 0 0 8px 0; font-size: 18px; }
    .result .kv {
      display:flex;
      justify-content:space-between;
      padding:8px 0;
      border-top:1px dashed #26303b;
      font-size:14px;
    }
    .result .kv:first-of-type { border-top: none; }
    .result-subtitle {
      margin-top: 10px;
      font-size: 13px;
      color:#9aa5b1;
    }
    .shots-list {
      margin-top: 8px;
      border-top:1px dashed #26303b;
      padding-top:8px;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:13px;
    }
    .shot-row {
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .shot-left { font-weight:600; }
    .shot-right { opacity:0.9; }

    /* Stepper */
    .stepper {
      display:flex;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    .step {
      flex:1;
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#0a0f13;
      color:#8b9aaa;
      border:1px solid #1a2530;
      cursor:pointer;
      user-select:none;
    }
    .step-index {
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid currentColor;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:700;
    }
    .step-texts { display:flex; flex-direction:column; gap:2px; }
    .step-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
    }
    .step-sub { font-size:12px; opacity:0.9; }
    .step--active {
      background:var(--primary);
      color:#ffffff;
      border-color:var(--primary);
    }
    .step--disabled {
      opacity:0.5;
      cursor:not-allowed;
    }

    .tab-content { margin-top: var(--gap); }

    .btn-row-2 {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }

    /* Loader */
    #loaderBox {
      font-size:13px;
      color:#cbd5f5;
    }
    .loader {
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      background:#0b1016;
      border-radius:999px;
      border:1px solid #1b242f;
      width: fit-content;
    }
    .spinner {
      width:14px;
      height:14px;
      border-radius:50%;
      border:2px solid rgba(148,163,184,0.35);
      border-top-color:#f9fafb;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Status bar */
    #statusBox {
      font-size: 13px;
      padding: 10px 14px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }
    .status--info {
      display:block;
      background: rgba(0, 80, 58, 0.15);
      border: 1px solid #00503a;
      color: #b6f7d2;
    }
    .status--error {
      display:block;
      background: rgba(255, 80, 80, 0.12);
      border: 1px solid #ff6b6b;
      color: #ff9b9b;
    }

    @media (max-width:720px){
      .grid-2{grid-template-columns:1fr}
      img{max-height:50vh}
      .row > button,
      .row > label[role=button],
      .primary,
      .ghost{width:100%}
      .btn-row-2{grid-template-columns:1fr}
    }

    .page-title {
      font-size:22px;
      font-weight:600;
      margin:10px 0 10px;
    }
    .page-subtitle {
      font-size:13px;
      color:#9aa5b1;
      margin-bottom:10px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="top-left">
      <div class="brand-dot"></div>
      <div>
        <div class="top-title">Lab by ToDoGolf</div>
        <div class="top-sub">Lecture radar ‚Äì Masque & analyse</div>
      </div>
    </div>
    <div>
      <a href="index.html" class="btn-top">‚Üê Accueil</a>
    </div>
  </div>

  <div class="wrap">
    <div class="page-title">Lecture Radar</div>
    <div class="page-subtitle">√âtape 1 : photo ‚Ä¢ √âtape 2 : analyse du coup</div>

    <div class="card">
      <!-- Stepper -->
      <div class="stepper">
        <div id="step1" class="step">
          <div class="step-index">1</div>
          <div class="step-texts">
            <div class="step-label">√âtape 1</div>
            <div class="step-sub">Photo</div>
          </div>
        </div>
        <div id="step2" class="step step--disabled">
          <div class="step-index">2</div>
          <div class="step-texts">
            <div class="step-label">√âtape 2</div>
            <div class="step-sub">Analyse</div>
          </div>
        </div>
      </div>

      <!-- Loader -->
      <div class="row hidden" id="loaderBox">
        <div class="loader">
          <div class="spinner"></div>
          <span id="loaderText">Chargement‚Ä¶</span>
        </div>
      </div>

      <!-- Status -->
      <div id="statusBox"></div>

      <!-- Onglet 1 -->
      <div id="tab1" class="tab-content">
        <div class="row btn-row-2">
          <label role="button" for="fileCam" class="ghost">üì∑ Prendre une photo</label>
          <label role="button" for="fileGal" class="ghost">üñºÔ∏è Depuis la galerie</label>
          <input id="fileCam" type="file" accept="image/*" capture="environment" style="display:none;" />
          <input id="fileGal" type="file" accept="image/*" style="display:none;" />
        </div>

        <div class="row">
          <img id="preview" class="hidden" alt="aper√ßu image" />
        </div>

        <div class="row">
          <button id="maskBtn" class="ghost" type="button" style="width:100%;">
            ‚úîÔ∏è Valider la photo
          </button>
        </div>
      </div>

      <!-- Onglet 2 -->
      <div id="tab2" class="tab-content hidden">
        <div class="grid-2">
          <div class="row">
            <label for="dateText">Date (JJ/MM/AAAA)</label>
            <input id="dateText" type="text" inputmode="numeric" placeholder="JJ/MM/AAAA" maxlength="10" required />
            <div class="hint">Pr√©remplie √† aujourd'hui</div>
          </div>
          <div class="row">
            <label for="club">Club</label>
            <input id="club" type="text" placeholder="ex: Fer7" required />
          </div>
        </div>

        <div class="grid-2">
          <div class="row">
            <label for="targetDist">Distance cible (m)</label>
            <input id="targetDist" type="number" step="1" min="0" value="100" required />
          </div>
        </div>

        <div class="row">
          <button id="analyzeBtn" class="primary" type="button" style="width:100%;" disabled>
            üß† Analyser l‚Äôimage
          </button>
        </div>
      </div>
    </div>

    <!-- R√©sultat -->
    <div class="row result hidden" id="resultCard">
      <h3>Distances</h3>

      <div class="kv">
        <div>Date</div>
        <div id="rDate">‚Äî</div>
      </div>

      <div class="kv">
        <div>Club</div>
        <div id="rClub">‚Äî</div>
      </div>

      <div class="kv">
        <div>Distance cible</div>
        <div id="rTarget">‚Äî</div>
      </div>

      <div class="kv">
        <div>Radar</div>
        <div id="rRadar">‚Äî</div>
      </div>

      <div class="result-subtitle">D√©tail des coups</div>
      <div id="shotsList" class="shots-list"></div>

      <div class="row" style="margin-top:12px;">
        <button id="saveToHistoryBtn" class="primary" type="button" style="width:100%;">
          üìä Ajouter √† mon historique
        </button>
      </div>
      <div class="row" style="margin-top:6px;">
        <button id="clearResultBtn" class="ghost" type="button" style="width:100%;">
          üßπ Effacer ce r√©sultat
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://todogolf-analyse.onrender.com";
    const HISTORY_KEY = "todogolf_lab_history";

    const $ = id => document.getElementById(id);

    const fileCam    = $("fileCam");
    const fileGal    = $("fileGal");
    const preview    = $("preview");
    const analyzeBtn = $("analyzeBtn");
    const maskBtn    = $("maskBtn");
    const resultCard = $("resultCard");
    const shotsList  = $("shotsList");

    const rDate   = $("rDate");
    const rClub   = $("rClub");
    const rTarget = $("rTarget");
    const rRadar  = $("rRadar");

    const dateText   = $("dateText");
    const club       = $("club");
    const targetDist = $("targetDist");

    const loaderBox  = $("loaderBox");
    const loaderText = $("loaderText");

    const step1El    = $("step1");
    const step2El    = $("step2");
    const tab1El     = $("tab1");
    const tab2El     = $("tab2");

    const saveToHistoryBtn = $("saveToHistoryBtn");
    const clearResultBtn   = $("clearResultBtn");

    let currentBlob   = null;
    let lastJson      = null;
    let maskValidated = false;
    let activeTab     = 1;
    let statusTimeoutId = null;

    function setStatus(msg, type = "info") {
      const box = $("statusBox");
      if (!box) return;
      box.textContent = msg;
      box.className = "";
      box.classList.add(type === "error" ? "status--error" : "status--info");
      box.style.display = "block";
      if (statusTimeoutId) clearTimeout(statusTimeoutId);
      statusTimeoutId = setTimeout(() => {
        box.className = "";
        box.style.display = "none";
      }, 10000);
    }

    function clampSize(w,h,max=1600){
      if(Math.max(w,h) <= max) return [w,h];
      const s = max / Math.max(w,h);
      return [Math.round(w*s), Math.round(h*s)];
    }

    function refreshSteps(){
      if (!step1El || !step2El) return;
      if (!maskValidated) {
        step2El.classList.add('step--disabled');
      } else {
        step2El.classList.remove('step--disabled');
      }
      if (activeTab === 1) {
        step1El.classList.add('step--active');
        step2El.classList.remove('step--active');
      } else {
        step2El.classList.add('step--active');
        step1El.classList.remove('step--active');
      }
    }

    function setActiveTab(n){
      if (n === 2 && !maskValidated) {
        setStatus("Validez d'abord la photo avant de passer √† l'√©tape 2.", "error");
        return;
      }
      activeTab = n;
      if (activeTab === 1) {
        tab1El.classList.remove('hidden');
        tab2El.classList.add('hidden');
        resultCard.classList.add("hidden");
      } else {
        tab1El.classList.add('hidden');
        tab2El.classList.remove('hidden');
        if (lastJson) {
          resultCard.classList.remove("hidden");
        }
      }
      refreshSteps();
    }

    function setLoading(isLoading, text) {
      if (!loaderBox) return;
      if (isLoading) {
        if (loaderText && text) loaderText.textContent = text;
        loaderBox.classList.remove("hidden");
      } else {
        loaderBox.classList.add("hidden");
      }
    }

    function todayStr(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }
    if(dateText && !dateText.value) dateText.value = todayStr();

    dateText?.addEventListener('input', e=>{
      let v = e.target.value.replace(/\D/g,'').slice(0,8);
      if(v.length>=5) v=v.replace(/^(\d{2})(\d{2})(\d{1,4})$/,'$1/$2/$3');
      else if(v.length>=3) v=v.replace(/^(\d{2})(\d{1,2})$/,'$1/$2');
      e.target.value=v;
    });

    function showPreview(fileOrBlob){
      if(!fileOrBlob){
        preview.classList.add("hidden");
        return;
      }
      const url = URL.createObjectURL(fileOrBlob);
      preview.src = url;
      preview.onload = ()=> URL.revokeObjectURL(url);
      preview.classList.remove("hidden");
    }

    async function ensureJpegFile(fileOrBlob){
      if(fileOrBlob && fileOrBlob.type === 'image/jpeg' && 'name' in fileOrBlob){
        return fileOrBlob;
      }
      try{
        const bmp = await createImageBitmap(fileOrBlob, { imageOrientation: 'from-image' });
        const [tw,th] = clampSize(bmp.width,bmp.height,1600);
        const canvas = document.createElement('canvas');
        canvas.width = tw;
        canvas.height = th;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bmp,0,0,tw,th);
        const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.9));
        return new File([blob], 'capture.jpg', {type:'image/jpeg'});
      }catch{
        return await new Promise(async (resolve)=>{
          const img = new Image();
          img.src = URL.createObjectURL(fileOrBlob);
          await img.decode();
          const [tw,th] = clampSize(img.naturalWidth,img.naturalHeight,1600);
          const canvas=document.createElement('canvas');
          canvas.width = tw;
          canvas.height= th;
          const ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0,tw,th);
          const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.9));
          URL.revokeObjectURL(img.src);
          resolve(new File([blob],'capture.jpg',{type:'image/jpeg'}));
        });
      }
    }

    function safe(v){
      if(v==null) return '';
      if(typeof v==='number' && !Number.isFinite(v)) return '';
      return String(v).replace(/[\n\r,]/g,' ');
    }

    function getRadarInfoFromJson(json){
      const dbg = json && json.debug ? json.debug : {};
      const ringReason   = (dbg.ring_reason || '').toLowerCase();
      const circleReason = (dbg.circle_reason || '').toLowerCase();
      const step         = dbg.ring_step_m;

      let usage = null;
      if (ringReason.includes('triangle')) {
        usage = 'Putting';
      } else if (ringReason.includes('carre') || ringReason.includes('square')) {
        usage = 'Petit jeu';
      } else if (circleReason) {
        usage = 'Long jeu';
      }

      if (!usage && (step === undefined || step === null || step === '')) {
        return '‚Äî';
      }
      if (usage && (step !== undefined && step !== null && step !== '')) {
        return usage + ' ‚Äì ' + step + ' m';
      }
      if (usage) return usage;
      return step + ' m';
    }

    function setMaskLoading(isLoading) {
      if (isLoading) {
        maskBtn.disabled = true;
        maskBtn.textContent = "‚è≥ Validation en cours...";
        analyzeBtn.disabled = true;
        setLoading(true, "Validation en cours‚Ä¶");
      } else {
        maskBtn.disabled = false;
        maskBtn.textContent = "‚úîÔ∏è Valider la photo";
        setLoading(false);
        analyzeBtn.disabled = !maskValidated;
      }
      refreshSteps();
    }

    function onPick(e){
      const file=e.target.files && e.target.files[0];
      if(!file) return;
      ensureJpegFile(file).then(f=>{
        currentBlob = f;
        setStatus('Image pr√™te : '+currentBlob.type+' ¬∑ '+Math.round(currentBlob.size/1024)+' KB');
        showPreview(currentBlob);
        if (activeTab === 2) {
          resultCard.classList.add("hidden");
        }
        lastJson = null;
        maskValidated = false;
        analyzeBtn.disabled = true;
        setActiveTab(1);
      }).catch(err=> setStatus('Erreur image : '+err.message, "error"));
    }

    fileCam.addEventListener('change', onPick);
    fileGal.addEventListener('change', onPick);

    async function analyze(){
      if(!maskValidated){
        setStatus('Validez d\'abord la photo avant de lancer l‚Äôanalyse.', "error");
        return;
      }
      if(!dateText.value || !club.value || !targetDist.value){
        setStatus('Remplissez la date, le club et la distance cible.', "error");
        return;
      }
      const file=currentBlob || fileCam.files?.[0] || fileGal.files?.[0];
      if(!file){
        setStatus("Ajoutez ou choisissez une photo d'abord.", "error");
        return;
      }

      const url = API_BASE + '/analyze';
      const fd  = new FormData();
      const imgFile = file instanceof File ? file : new File([file],'capture.jpg',{type:'image/jpeg'});

      fd.append('image', imgFile, imgFile.name);
      fd.append('file', imgFile, imgFile.name);
      fd.append('image_file', imgFile, imgFile.name);
      fd.append('date_text', dateText.value);
      fd.append('club', club.value);
      fd.append('centre_distance', targetDist.value);

      try{
        setLoading(true, "Analyse en cours‚Ä¶");
        const res = await fetch(url,{method:'POST',body:fd});
        if(!res.ok){
          let t='';
          try{ t = await res.text(); }catch(_){}
          throw new Error('HTTP '+res.status+(t?' ‚Äì '+t:''));
        }
        const data = await res.json();
        lastJson = data;

        const coups = Array.isArray(data.coups) ? data.coups : [];

        rDate.textContent   = dateText.value;
        rClub.textContent   = club.value;
        rTarget.textContent = targetDist.value + ' m';

        const radarInfo = getRadarInfoFromJson(data);
        rRadar.textContent = radarInfo;

        shotsList.innerHTML = '';
        if (coups.length === 0) {
          const line = document.createElement('div');
          line.textContent = 'Aucun coup d√©tect√©.';
          shotsList.appendChild(line);
        } else {
          coups.forEach((c, idx)=>{
            const row = document.createElement('div');
            row.className = 'shot-row';

            const left = document.createElement('div');
            left.className = 'shot-left';
            left.textContent = 'Coup ' + (idx+1);

            const right = document.createElement('div');
            right.className = 'shot-right';

            const parts = [];
            if (c.distance_totale_m !== undefined && c.distance_totale_m !== null) parts.push('Dist. ' + c.distance_totale_m + ' m');
            if (c.ecart_lateral_m  !== undefined && c.ecart_lateral_m  !== null)   parts.push('Lat. '  + c.ecart_lateral_m  + ' m');
            if (c.ecart_profondeur_m !== undefined && c.ecart_profondeur_m !== null) parts.push('Prof. ' + c.ecart_profondeur_m + ' m');

            right.textContent = parts.join(' ¬∑ ') || '‚Äî';
            row.appendChild(left);
            row.appendChild(right);
            shotsList.appendChild(row);
          });
        }

        resultCard.classList.remove("hidden");
        setStatus('Analyse termin√©e ‚úÖ V√©rifiez les coups avant de les ajouter √† votre historique.', "info");
        setActiveTab(2);
      }catch(err){
        setStatus('Analyse impossible : '+err.message, "error");
      } finally {
        setLoading(false);
      }
    }
    analyzeBtn.addEventListener('click', analyze);

    async function showMask(){
      const file=currentBlob || fileCam.files?.[0] || fileGal.files?.[0];
      if(!file){
        setStatus("Ajoutez ou choisissez une photo d'abord.", "error");
        return;
      }

      const url = API_BASE + '/mask';
      const fd  = new FormData();
      const imgFile = file instanceof File ? file : new File([file],'capture.jpg',{type:'image/jpeg'});
      fd.append('image', imgFile, imgFile.name);
      fd.append('file', imgFile, imgFile.name);
      fd.append('image_file', imgFile, imgFile.name);

      try{
        setMaskLoading(true);

        const res = await fetch(url,{method:'POST',body:fd});
        if(!res.ok){
          let t='';
          try{ t = await res.text(); }catch(_){}
          throw new Error('HTTP '+res.status+(t?' ‚Äì '+t:''));
        }
        const blob = await res.blob();
        showPreview(blob);
        maskValidated = true;
        setMaskLoading(false);
        setStatus(
          "Masque g√©n√©r√© ‚úÖ V√©rifiez bien la d√©tection : " +
          "‚Ä¢ les trois rep√®res sont entour√©s par des petits cercles, " +
          "‚Ä¢ chaque impact est marqu√© par un point vert sur les arcs rouges, " +
          "‚Ä¢ les cercles de distance suivent correctement les anneaux du radar. " +
          "Si tout est correct, passez √† l‚Äô√©tape 2 pour analyser le coup. " +
          "Sinon, retournez √† l‚Äô√©tape 1 et rechargez une nouvelle photo.",
          "info"
        );
        refreshSteps();
      }catch(err){
        maskValidated = false;
        setMaskLoading(false);
        analyzeBtn.disabled = true;
        refreshSteps();
        setStatus('Erreur dans le traitement de la photo, merci de la recharger.', "error");
      }
    }
    maskBtn.addEventListener('click', showMask);

    function addCurrentResultToHistory() {
      if (!lastJson) {
        setStatus("Aucun r√©sultat √† enregistrer. Faites d‚Äôabord une analyse.", "error");
        return;
      }
      const coups = Array.isArray(lastJson.coups) ? lastJson.coups : [];
      if (coups.length === 0) {
        setStatus("Aucun coup d√©tect√©, rien √† ajouter √† l‚Äôhistorique.", "error");
        return;
      }

      let history = [];
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (raw) history = JSON.parse(raw) || [];
      } catch (e) {
        history = [];
      }

      const radarInfo = getRadarInfoFromJson(lastJson);
      const dateVal   = dateText.value;
      const clubVal   = club.value;
      const cibleVal  = Number(targetDist.value);

      coups.forEach(c => {
        history.push({
          date_text: dateVal,
          club: clubVal,
          distance_cible_m: cibleVal,
          radar_info: radarInfo,
          distance_totale_m: c.distance_totale_m,
          ecart_lateral_m: c.ecart_lateral_m,
          ecart_profondeur_m: c.ecart_profondeur_m
        });
      });

      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        setStatus(`R√©sultat ajout√© √† votre historique (${coups.length} coup(s)).`, "info");
      } catch (e) {
        setStatus("Impossible d‚Äôenregistrer dans l‚Äôhistorique (quota navigateur atteint ?).", "error");
      }
    }

    function clearCurrentResult() {
      lastJson = null;
      resultCard.classList.add("hidden");
      shotsList.innerHTML = "";
      rDate.textContent   = "‚Äî";
      rClub.textContent   = "‚Äî";
      rTarget.textContent = "‚Äî";
      rRadar.textContent  = "‚Äî";
      setStatus("R√©sultat effac√©. Vous pouvez refaire une analyse avec une nouvelle photo.", "info");
    }

    saveToHistoryBtn.addEventListener('click', addCurrentResultToHistory);
    clearResultBtn.addEventListener('click', clearCurrentResult);

    step1El.addEventListener('click', ()=> setActiveTab(1));
    step2El.addEventListener('click', ()=> setActiveTab(2));

    // Init
    setActiveTab(1);
    refreshSteps();
  </script>

  <!-- Ping Render pour r√©veiller l'API en arri√®re-plan -->
  <script>
    (function() {
      try {
        fetch("https://todogolf-analyse.onrender.com/", {
          method: "HEAD",
          mode: "no-cors"
        }).catch(function(){});
      } catch (e) {}
    })();
  </script>
</body>
</html>
