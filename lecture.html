<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>ToDoGolf Lab ‚Äì Lecture Radar</title>
  <style>
    :root {
      --gap: 18px;
      --primary: #00503a;
      --bg: #050608;
      --card: #0f1419;
      --border: #182028;
      --text: #e7e8ea;
      --muted: #b8c0cc;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #06141a 0, #020309 55%, #000 100%);
      color: var(--text);
    }
    .hidden { display:none !important; }

    /* Topbar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 40;
      background: linear-gradient(to bottom, rgba(5,6,8,0.96), rgba(5,6,8,0.88));
      border-bottom: 1px solid #10151e;
      padding: 10px 16px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      backdrop-filter: blur(14px);
      gap:10px;
    }
    .top-left {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-dot {
      width:22px;
      height:22px;
      border-radius:999px;
      background:var(--primary);
      box-shadow:0 0 16px rgba(0,80,58,0.85);
    }
    .top-title {
      font-weight:600;
      font-size:16px;
    }
    .top-sub {
      font-size:11px;
      color:#8b9aaa;
    }
    .btn-top {
      border-radius:999px;
      border:1px solid #26303b;
      background:#0b1016;
      padding:6px 10px;
      font-size:12px;
      color:var(--text);
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:4px;
      flex-shrink:0;
      white-space:nowrap;
      transition: background 0.1s, border-color 0.1s;
    }
    .btn-top:hover { background:#101822; border-color:#323f4e; }

    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    .page-eyebrow {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:#6b7280;
      margin-bottom:4px;
    }
    .page-title {
      font-size:24px;
      font-weight:650;
      margin:6px 0 4px;
    }

    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,0.4);
    }
    .row { margin-top: var(--gap); }
    .grid-2 {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:var(--gap);
    }

    label {
      font-size: 13px;
      color:#cbd5e1;
      margin-bottom:6px;
      display:block;
      font-weight:600;
    }
    input[type=text],
    input[type=number],
    select {
      width:100%;
      padding:12px 14px;
      border:1px solid #26303b;
      border-radius:12px;
      font-size:15px;
      background:#05080c;
      color:var(--text);
      outline:none;
    }

    /* Select premium, align√© avec les autres champs */
    select {
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;

      background-color:#05080c;
      border:1px solid #26303b;
      border-radius:12px;

      padding:12px 38px 12px 14px;
      font-size:15px;
      font-weight:500;
      color:var(--text);
      line-height:1.3;

      background-image:
        linear-gradient(45deg, transparent 50%, #9ca3af 50%),
        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size:6px 6px, 6px 6px;
      background-repeat:no-repeat;
    }

    select:focus {
      border-color: rgba(0,80,58,0.9);
      box-shadow:0 0 0 1px rgba(0,80,58,0.7);
      background-color:#05080c;
    }

    select option {
      background:#020309;
      color:var(--text);
    }

    input:focus {
      border-color: rgba(0,80,58,0.9);
      box-shadow:0 0 0 1px rgba(0,80,58,0.7);
    }

    /* Groupes de champs premium (√©tapes 2 & 3) */
    .field-group {
      background:#0b1016;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.18);
      padding:12px 14px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,0.55);
    }
    .field-group label {
      margin-bottom:4px;
    }
    .field-group .hint {
      margin-top:4px;
    }

    /* === BOUTONS HARMONIS√âS === */
    button,
    label[role=button],
    .select-club-btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;

      padding:11px 16px;
      border-radius:999px;
      border:1px solid #26303b;

      background:#11171e;
      color:var(--text);

      font-weight:600;
      font-size:14px;
      letter-spacing:0.01em;

      cursor:pointer;
      transition:
        transform 0.08s ease,
        box-shadow 0.08s ease,
        background 0.1s,
        border-color 0.1s,
        color 0.1s;
    }

    button:hover:not(:disabled),
    label[role=button]:hover,
    .select-club-btn:hover {
      background:#151c24;
      border-color:#323f4e;
      box-shadow:0 4px 12px rgba(0,0,0,0.35);
      transform: translateY(-1px);
    }

    button:active,
    label[role=button]:active,
    .select-club-btn:active {
      transform: translateY(0);
      box-shadow:none;
    }
    button:disabled {
      opacity:0.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .primary {
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
      box-shadow:0 4px 14px rgba(0,80,58,0.5);
    }
    .primary:hover:not(:disabled) {
      background:#046046;
      border-color:#07a06c;
      box-shadow:0 8px 20px rgba(0,80,58,0.7);
    }

    .ghost {
      background:#0b1016;
    }

    /* Boutons de l'√©tape 1 : mise en page large */
    .btn-photo {
      width:100%;
      justify-content:center;
      padding:14px 18px;
      font-size:14px;
    }

    img {
      width: 100%;
      max-height: 60vh;
      object-fit: contain;
      background:#000;
      border-radius: 16px;
      border:1px solid #1b232c;
    }
    .hint {
      font-size: 12px;
      color:#9aa5b1;
      margin-top: 6px;
    }

    .result {
      background:var(--card);
      border:1px solid rgba(0,80,58,0.55);
      border-radius:18px;
      padding:18px 16px 16px;
      line-height:1.45;
      box-shadow: 0 14px 32px rgba(0,0,0,0.55);
      position:relative;
      overflow:hidden;
    }
    .result::before {
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at top left, rgba(0,80,58,0.18), transparent 60%);
      opacity:0.9;
      pointer-events:none;
    }
    .result-inner {
      position:relative;
      z-index:1;
    }
    .result h3 {
      margin: 0 0 4px 0;
      font-size: 18px;
      font-weight:650;
    }
    .result-intro {
      font-size:12px;
      color:#9aa5b1;
      margin-bottom:10px;
    }

    .result-summary {
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-bottom:12px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(8,12,16,0.95);
      border:1px solid rgba(0,80,58,0.5);
    }
    .result-summary-item {
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:13px;
    }
    .result-summary-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#94a3b8;
    }
    .result-summary-value {
      font-size:13px;
      font-weight:500;
      color:#e5e7eb;
      word-break:break-word;
    }

    .result-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color:#9aa5b1;
    }
    .shots-list {
      margin-top: 8px;
      padding-top:4px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:13px;
    }
    .shot-row {
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      padding:8px 10px;
      border-radius:10px;
      background:#101820;
      border:1px solid #1f2937;
    }
    .shot-left {
      font-weight:600;
      font-size:13px;
    }
    .shot-right {
      opacity:0.95;
      font-size:13px;
      text-align:right;
    }

    /* Stepper */
    .stepper {
      display:flex;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .step {
      flex:1;
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#0a0f13;
      color:#8b9aaa;
      border:1px solid #1a2530;
      cursor:pointer;
      user-select:none;
      transition: background 0.12s ease, border-color 0.12s ease, color 0.12s ease;
    }
    .step-index {
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid currentColor;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:700;
    }
    .step-texts { display:flex; flex-direction:column; gap:2px; }
    .step-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
    }
    .step-sub { font-size:12px; opacity:0.9; }
    .step--active {
      background:var(--primary);
      color: #ffffff;
      border-color:var(--primary);
    }

    .step-help {
      font-size:12px;
      color:#9aa5b1;
      margin-bottom:4px;
      line-height:1.5;
    }

    .tab-content { margin-top: var(--gap); }

    .btn-row-2 {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }

    /* Loader */
    #loaderBox {
      font-size:13px;
      color:#cbd5f5;
    }
    .loader {
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      background:#0b1016;
      border-radius:999px;
      border:1px solid #1b242f;
      width: fit-content;
    }
    .spinner {
      width:14px;
      height:14px;
      border-radius:50%;
      border:2px solid rgba(148,163,184,0.35);
      border-top-color:#f9fafb;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Status bar */
    #statusBox {
      font-size: 14px;
      padding: 14px 16px;
      border-radius: 10px;
      margin-top: 14px;
      line-height: 1.5;
      display: none;
      white-space: pre-line;
    }
    .status--info {
      display:block;
      background: rgba(0, 80, 58, 0.15);
      border: 1px solid #00503a;
      color: #b6f7d2;
    }
    .status--error {
      display:block;
      background: rgba(255, 80, 80, 0.12);
      border: 1px solid #ff6b6b;
      color: #ff9b9b;
    }

    /* S√©lecteur de club custom (h√©rite du style bouton, mais look champ) */
    .select-club-btn {
      width:100%;
      justify-content:space-between;
      text-align:left;

      background:#05080c;
      border:1px solid #26303b;

      border-radius:12px;
      padding:12px 38px 12px 14px;

      font-size:15px;
      font-weight:500;
    }
    .select-club-btn::after {
      content:"‚ñæ";
      font-size:11px;
      opacity:0.8;
    }
    .select-club-btn--filled {
      color:var(--text);
    }

    /* Modal (verre d√©poli) */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:120;
      backdrop-filter: blur(12px);
      padding:16px;
    }
    .modal-club {
      background: rgba(15,20,25,0.92);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.35);
      box-shadow: 0 24px 45px rgba(0,0,0,0.7);
      width:100%;
      max-width:380px;
      max-height:80vh;
      display:flex;
      flex-direction:column;
      animation: modalFade 0.16s ease-out;
    }
    @keyframes modalFade {
      from { opacity:0; transform:translateY(6px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .modal-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px 8px;
      border-bottom:1px solid rgba(31,41,55,0.8);
    }
    .modal-title {
      font-size:14px;
      font-weight:600;
    }
    .modal-close-btn {
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      background:#0b1016;
      border:1px solid #26303b;
      box-shadow:none;
    }
    .modal-close-btn:hover {
      background:#151c24;
      border-color:#323f4e;
      box-shadow:0 4px 10px rgba(0,0,0,0.35);
    }
    .modal-body {
      padding:10px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modal-search {
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #26303b;
      background:#05080c;
      color:var(--text);
      font-size:14px;
    }
    .modal-list {
      margin-top:4px;
      overflow-y:auto;
      max-height: calc(80vh - 120px);
    }
    .modal-item {
      padding:10px 12px;
      border-radius:10px;
      font-size:14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition: background 0.08s ease, transform 0.06s ease, border-color 0.08s ease;
      border:1px solid transparent;
    }
    .modal-item:hover {
      background:rgba(0,80,58,0.22);
      border-color:rgba(0,80,58,0.6);
      transform:translateY(-1px);
    }
    .modal-empty {
      padding:10px 12px;
      font-size:13px;
      color:#9ca3af;
    }

    /* Canvas de recadrage */
    #cropCanvas {
      width:100%;
      max-height:60vh;
      background:#000;
      border-radius:12px;
      border:1px solid #1b232c;
      touch-action:none;
    }

    /* Popup sauvegarde */
    .save-popup {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: #fff;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 8px 22px rgba(0,0,0,0.55);
      z-index: 200;

      max-width: calc(100% - 32px);
      text-align: center;
      box-sizing: border-box;
      white-space: normal;
    }

    @media (max-width:720px){
      .grid-2{grid-template-columns:1fr}
      img{max-height:50vh}
      .row > button,
      .row > label[role=button],
      .primary,
      .ghost{width:100%}
      .btn-row-2{grid-template-columns:1fr}
      .modal-club{
        max-width:none;
        max-height:none;
        height:100%;
        border-radius:0;
      }
      .modal-list{
        max-height:none;
        flex:1;
      }
      .modal-body{
        flex:1;
        display:flex;
        flex-direction:column;
      }
      .result-summary {
        grid-template-columns: 1fr;
      }

      /* Stepper en colonne sur mobile */
      .stepper {
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
      }
      .step {
        width: 100%;
        justify-content: flex-start;
      }
      .step-texts {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="top-left">
      <div class="brand-dot"></div>
      <div class="top-texts">
        <div class="top-title">ToDoGolf Lab ‚Äì Analyse & Performance</div>
        <div class="top-sub">Outils d‚Äôanalyse pour vos radars papier</div>
      </div>
    </div>
    <a href="index.html" class="btn-top">‚Üê Accueil</a>
  </header>

  <main class="wrap">
    <div class="page-eyebrow">Analyse radar</div>
    <h1 class="page-title">Lecture &amp; D√©tection</h1>

    <div class="card">
      <!-- Stepper -->
      <div class="stepper">
        <div id="step1" class="step">
          <div class="step-index">1</div>
          <div class="step-texts">
            <div class="step-label">√âtape 1</div>
            <div class="step-sub">Photo</div>
          </div>
        </div>
        <div id="step2" class="step">
          <div class="step-index">2</div>
          <div class="step-texts">
            <div class="step-label">√âtape 2</div>
            <div class="step-sub">Radar</div>
          </div>
        </div>
        <div id="step3" class="step">
          <div class="step-index">3</div>
          <div class="step-texts">
            <div class="step-label">√âtape 3</div>
            <div class="step-sub">Analyse</div>
          </div>
        </div>
      </div>

      <!-- Aide dynamique par √©tape -->
      <div id="stepHelp" class="step-help"></div>

      <!-- Loader -->
      <div class="row hidden" id="loaderBox">
        <div class="loader">
          <div class="spinner"></div>
          <span id="loaderText">Chargement‚Ä¶</span>
        </div>
      </div>

      <!-- Status -->
      <div id="statusBox"></div>

      <!-- Onglet 1 : Photo -->
      <div id="tab1" class="tab-content">
        <div class="row btn-row-2">
          <label role="button" for="fileCam" class="ghost btn-photo">üì∑ Prendre une photo</label>
          <label role="button" for="fileGal" class="ghost btn-photo">üñºÔ∏è Depuis la galerie</label>
          <input id="fileCam" type="file" accept="image/*" capture="environment" style="display:none;" />
          <input id="fileGal" type="file" accept="image/*" style="display:none;" />
        </div>

        <div class="row">
          <img id="preview" class="hidden" alt="aper√ßu image" />
        </div>

        <!-- Bouton recadrage -->
        <div class="row">
          <button id="openCropModalBtn" class="ghost btn-photo hidden" type="button">
            ‚úÇÔ∏è Recadrer la photo (avant d√©tection)
          </button>
        </div>
      </div>

      <!-- Onglet 2 : Radar -->
      <div id="tab2" class="tab-content hidden">
        <div class="grid-2">
          <div class="row field-group">
            <label for="radarUsage">Condition de jeu</label>
            <select id="radarUsage">
              <option value="">S√©lectionner‚Ä¶</option>
              <option value="practice">Practice</option>
              <option value="parcours">Parcours</option>
            </select>
            <div class="hint">Permet de d√©finir l‚Äôanalyse des coups.</div>
          </div>
          <div class="row field-group">
            <label for="radarScale">√âchelle du radar</label>
            <select id="radarScale">
              <option value="">S√©lectionner‚Ä¶</option>
              <option value="grand-jeu">Grand jeu ‚Äì 5 m / anneau</option>
              <option value="petit-jeu">Petit jeu ‚Äì 1 m / anneau</option>
              <option value="putting">Putting ‚Äì 0,3 m / anneau</option>
            </select>
            <div class="hint">D√©finit combien de m√®tres repr√©sente chaque anneau du radar.</div>
          </div>
        </div>
      </div>

      <!-- Onglet 3 : Analyse -->
      <div id="tab3" class="tab-content hidden">
        <div class="grid-2">
          <div class="row field-group">
            <label for="dateText">Date (JJ/MM/AAAA)</label>
            <input id="dateText" type="text" inputmode="numeric" placeholder="JJ/MM/AAAA" maxlength="10" required />
            <div class="hint">Pr√©remplie √† aujourd'hui</div>
          </div>
          <div class="row field-group">
            <label for="clubDisplay">Club</label>
            <button id="clubDisplay" type="button" class="select-club-btn">
              S√©lectionner un club‚Ä¶
            </button>
            <input id="club" type="hidden" />
            <div class="hint">Tapez pour filtrer et choisissez votre club.</div>
          </div>
        </div>

        <div class="grid-2">
          <div class="row field-group" id="targetRow">
            <label for="targetDist">Distance cible (m)</label>
            <input id="targetDist" type="number" step="1" min="0" value="100" required />
            <div class="hint">Utilis√©e uniquement en mode Practice.</div>
          </div>
        </div>

        <div class="row">
          <button id="analyzeBtn" class="primary" type="button" style="width:100%;" disabled>
            üß† Analyser l‚Äôimage
          </button>
        </div>
      </div>
    </div>

    <!-- R√©sultat -->
    <div class="row result hidden" id="resultCard">
      <div class="result-inner">
        <h3>R√©sultat de l‚Äôanalyse photo</h3>
        <div class="result-intro">
          V√©rifiez les informations de cette analyse avant de l‚Äôajouter √† votre historique.
        </div>

        <div class="result-summary">
          <div class="result-summary-item">
            <div class="result-summary-label">üìÖ Date</div>
            <div class="result-summary-value" id="rDate">‚Äî</div>
          </div>
          <div class="result-summary-item">
            <div class="result-summary-label">üèåÔ∏è Club</div>
            <div class="result-summary-value" id="rClub">‚Äî</div>
          </div>
          <div class="result-summary-item">
            <div class="result-summary-label">üéØ Distance cible</div>
            <div class="result-summary-value" id="rTarget">‚Äî</div>
          </div>
          <div class="result-summary-item">
            <div class="result-summary-label">üìç Condition</div>
            <div class="result-summary-value" id="rRadar">‚Äî</div>
          </div>
        </div>

        <div class="result-subtitle">D√©tail des coups</div>
        <div id="shotsList" class="shots-list"></div>

        <div class="row" style="margin-top:12px;">
          <button id="saveToHistoryBtn" class="primary" type="button" style="width:100%;">
            üìä Ajouter √† mon historique
          </button>
        </div>
        <div class="row" style="margin-top:6px;">
          <button id="clearResultBtn" class="ghost" type="button" style="width:100%;">
            üßπ Effacer ce r√©sultat
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal s√©lection de club -->
  <div id="clubModalBackdrop" class="modal-backdrop hidden">
    <div class="modal-club">
      <div class="modal-header">
        <div class="modal-title">S√©lectionner un club</div>
        <button id="closeClubModal" type="button" class="modal-close-btn">‚úï</button>
      </div>
      <div class="modal-body">
        <input id="clubSearch" type="text" class="modal-search" placeholder="Rechercher un club‚Ä¶" />
        <div id="clubList" class="modal-list"></div>
      </div>
    </div>
  </div>

  <!-- Modal recadrage -->
  <div id="cropModalBackdrop" class="modal-backdrop hidden">
    <div class="modal-club">
      <div class="modal-header">
        <div class="modal-title">Recadrer la photo</div>
        <button id="closeCropModal" type="button" class="modal-close-btn">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="hint">
          Tracez un rectangle sur la zone utile (feuille + rep√®res).<br>
          Vous pouvez aussi valider directement pour utiliser toute l‚Äôimage.
        </div>
        <canvas id="cropCanvas"></canvas>
        <div class="btn-row-2" style="margin-top:10px;">
          <button id="cancelCropBtn" type="button" class="ghost">Annuler</button>
          <button id="validateCropBtn" type="button" class="primary">Valider le recadrage</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup -->
  <div id="savePopup" class="save-popup hidden">
    Donn√©es enregistr√©es ‚úîÔ∏è
  </div>

  <script>
    const API_BASE = "https://todogolf-analyse.onrender.com";
    const HISTORY_KEY = "todogolf_lab_history";

    const RADAR_SCALES = {
      "grand-jeu": 5.0,
      "petit-jeu": 1.0,
      "putting": 0.3
    };
    const NB_RINGS = 4;

    function fetchWithTimeout(url, options = {}, timeout = 20000) {
      return Promise.race([
        fetch(url, options),
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error("Timeout")), timeout)
        )
      ]);
    }

    const $ = id => document.getElementById(id);

    const fileCam    = $("fileCam");
    const fileGal    = $("fileGal");
    const preview    = $("preview");
    const analyzeBtn = $("analyzeBtn");
    const resultCard = $("resultCard");
    const shotsList  = $("shotsList");

    const rDate   = $("rDate");
    const rClub   = $("rClub");
    const rTarget = $("rTarget");
    const rRadar  = $("rRadar");

    const dateText    = $("dateText");
    const club        = $("club");
    const clubDisplay = $("clubDisplay");
    const targetDist  = $("targetDist");
    const targetRow   = $("targetRow");

    const radarUsageSel = $("radarUsage");
    const radarScaleSel = $("radarScale");

    const loaderBox  = $("loaderBox");
    const loaderText = $("loaderText");

    const step1El    = $("step1");
    const step2El    = $("step2");
    const step3El    = $("step3");
    const tab1El     = $("tab1");
    const tab2El     = $("tab2");
    const tab3El     = $("tab3");

    const stepHelp   = $("stepHelp");

    const saveToHistoryBtn = $("saveToHistoryBtn");
    const clearResultBtn   = $("clearResultBtn");

    const clubModalBackdrop = $("clubModalBackdrop");
    const clubSearch        = $("clubSearch");
    const clubList          = $("clubList");
    const closeClubModal    = $("closeClubModal");

    const openCropModalBtn  = $("openCropModalBtn");
    const cropModalBackdrop = $("cropModalBackdrop");
    const cropCanvas        = $("cropCanvas");
    const closeCropModalBtn = $("closeCropModal");
    const cancelCropBtn     = $("cancelCropBtn");
    const validateCropBtn   = $("validateCropBtn");

    const CLUBS = [
      "Driver",
      "Bois 3",
      "Bois 5",
      "Bois 7",
      "Bois 9",
      "Hybride 2",
      "Hybride 3",
      "Hybride 4",
      "Hybride 5",
      "Fer 2",
      "Fer 3",
      "Fer 4",
      "Fer 5",
      "Fer 6",
      "Fer 7",
      "Fer 8",
      "Fer 9",
      "Wedge 50¬∞",
      "Wedge 52¬∞",
      "Wedge 54¬∞",
      "Wedge 56¬∞",
      "Wedge 58¬∞",
      "Wedge 60¬∞",
      "Wedge 62¬∞",
      "Wedge 64¬∞",
      "Putter",
      "Chipper"
    ];

    let currentBlob   = null;
    let lastJson      = null;
    let maskValidated = false;
    let activeTab     = 1;
    let statusTimeoutId = null;

    /* √âtat recadrage */
    let cropImg = null;
    let cropScaleX = 1;
    let cropScaleY = 1;
    let cropRect = null;
    let isCropping = false;
    let cropStartX = 0;
    let cropStartY = 0;

    function setStatus(msg, type = "info") {
      const box = $("statusBox");
      if (!box) return;
      box.innerHTML = msg.replace(/\n/g, "<br>");
      box.className = "";
      box.classList.add(type === "error" ? "status--error" : "status--info");
      box.style.display = "block";
      if (statusTimeoutId) clearTimeout(statusTimeoutId);
      statusTimeoutId = setTimeout(() => {
        box.className = "";
        box.style.display = "none";
      }, 10000);
    }

    function clampSize(w,h,max=1600){
      if(Math.max(w,h) <= max) return [w,h];
      const s = max / Math.max(w,h);
      return [Math.round(w*s), Math.round(h*s)];
    }

    // üîπ On n‚Äôaffiche plus le texte ‚ÄúPour une d√©tection fiable‚Ä¶‚Äù en dur ici
    function updateStepHelp() {
      if (!stepHelp) return;
      stepHelp.classList.add("hidden");
      stepHelp.innerHTML = "";
    }

    function refreshSteps(){
      if (!step1El || !step2El || !step3El) return;

      step1El.classList.remove('step--active');
      step2El.classList.remove('step--active');
      step3El.classList.remove('step--active');
      if (activeTab === 1) step1El.classList.add('step--active');
      else if (activeTab === 2) step2El.classList.add('step--active');
      else if (activeTab === 3) step3El.classList.add('step--active');

      updateStepHelp();
    }

    function setActiveTab(n){
  // √âtapes 2 et 3 n√©cessitent la d√©tection des rep√®res avant
  if ((n === 2 || n === 3) && !maskValidated) {
    setStatus("Lancez d‚Äôabord la d√©tection des rep√®res en validant le recadrage (√âtape 1).", "error");
    return;
  }
  activeTab = n;

  tab1El.classList.add('hidden');
  tab2El.classList.add('hidden');
  tab3El.classList.add('hidden');
  resultCard.classList.add("hidden");

  if (activeTab === 1) {
    tab1El.classList.remove('hidden');
  } else if (activeTab === 2) {
    tab2El.classList.remove('hidden');
  } else {
    tab3El.classList.remove('hidden');
    if (lastJson) resultCard.classList.remove("hidden");
  }

  // üîπ On masque le bloc d‚Äôinfo (vert / rouge / orange) quand on change d‚Äô√©tape
  const box = document.getElementById("statusBox");
  if (box) {
    if (statusTimeoutId) {
      clearTimeout(statusTimeoutId);
      statusTimeoutId = null;
    }
    box.className = "";
    box.style.display = "none";
  }

  refreshSteps();
}

    function setLoading(isLoading, text) {
      if (!loaderBox) return;
      if (isLoading) {
        if (loaderText && text) loaderText.textContent = text;
        loaderBox.classList.remove("hidden");
      } else {
        loaderBox.classList.add("hidden");
      }
    }

    function todayStr(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }
    if(dateText && !dateText.value) dateText.value = todayStr();

    dateText?.addEventListener('input', e=>{
      let v = e.target.value.replace(/\D/g,'').slice(0,8);
      if(v.length>=5) v=v.replace(/^(\d{2})(\d{2})(\d{1,4})$/,'$1/$2/$3');
      else if(v.length>=3) v=v.replace(/^(\d{2})(\d{1,2})$/,'$1/$2');
      e.target.value=v;
    });

    function showPreview(fileOrBlob){
      if(!fileOrBlob){
        preview.classList.add("hidden");
        openCropModalBtn.classList.add("hidden");
        return;
      }
      const url = URL.createObjectURL(fileOrBlob);
      preview.src = url;
      preview.onload = ()=> URL.revokeObjectURL(url);
      preview.classList.remove("hidden");
      openCropModalBtn.classList.remove("hidden");
    }

    async function ensureJpegFile(fileOrBlob){
      if(fileOrBlob && fileOrBlob.type === 'image/jpeg' && 'name' in fileOrBlob){
        return fileOrBlob;
      }
      try{
        const bmp = await createImageBitmap(fileOrBlob, { imageOrientation: 'from-image' });
        const [tw,th] = clampSize(bmp.width,bmp.height,1600);
        const canvas = document.createElement('canvas');
        canvas.width = tw;
        canvas.height = th;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bmp,0,0,tw,th);
        const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.9));
        return new File([blob], 'capture.jpg', {type:'image/jpeg'});
      }catch{
        return await new Promise(async (resolve)=>{
          const img = new Image();
          img.src = URL.createObjectURL(fileOrBlob);
          await img.decode();
          const [tw,th] = clampSize(img.naturalWidth,img.naturalHeight,1600);
          const canvas=document.createElement('canvas');
          canvas.width = tw;
          canvas.height= th;
          const ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0,tw,th);
          const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.9));
          URL.revokeObjectURL(img.src);
          resolve(new File([blob],'capture.jpg',{type:'image/jpeg'}));
        });
      }
    }

    function resetResultState() {
      lastJson = null;
      resultCard.classList.add("hidden");
      shotsList.innerHTML = "";
      rDate.textContent   = "‚Äî";
      rClub.textContent   = "‚Äî";
      rTarget.textContent = "‚Äî";
      rRadar.textContent  = "‚Äî";
    }

    function onPick(e){
      const file=e.target.files && e.target.files[0];
      if(!file) return;

      resetResultState();
      maskValidated = false;
      analyzeBtn.disabled = true;

      ensureJpegFile(file).then(f=>{
        currentBlob = f;
        setStatus(
          'Image pr√™te : '+Math.round(currentBlob.size/1024)+' KB\n' +
          'Recadrez la photo pour centrer la feuille avant la d√©tection des rep√®res, ou validez directement.',
          "info"
        );
        showPreview(currentBlob);
        activeTab = 1;
        setActiveTab(1);
      }).catch(err=> setStatus('Erreur image : '+err.message, "error"));
    }

    fileCam.addEventListener('change', onPick);
    fileGal.addEventListener('change', onPick);

    async function generateMask(){
      const file=currentBlob || fileCam.files?.[0] || fileGal.files?.[0];
      if(!file){
        setStatus("Ajoutez ou choisissez une photo d'abord.", "error");
        return;
      }
      const url = API_BASE + '/mask';
      const fd  = new FormData();
      const imgFile = file instanceof File ? file : new File([file],'capture.jpg',{type:'image/jpeg'});
      fd.append('image', imgFile, imgFile.name);
      fd.append('file', imgFile, imgFile.name);
      fd.append('image_file', imgFile, imgFile.name);

      try{
        setLoading(true, "D√©tection des rep√®res‚Ä¶");
        const res = await fetchWithTimeout(url,{method:'POST',body:fd}, 20000);
        if(!res.ok){
          let t='';
          try{ t = await res.text(); }catch(_){}
          throw new Error('HTTP '+res.status+(t?' ‚Äì '+t:'')); 
        }
        const blob = await res.blob();
        showPreview(blob);
        maskValidated = true;
        analyzeBtn.disabled = false;
        setStatus(
          "Rep√®res d√©tect√©s ‚úÖ\n\n" +
          "V√©rifiez la d√©tection :\n" +
          "‚Ä¢ le cercle ext√©rieur passe bien par les trois rep√®res\n" +
          "‚Ä¢ chaque rep√®re est marqu√© par une ic√¥ne au centre\n\n" +
          "Ensuite : passez √† l‚Äô√©tape 2 pour d√©finir la condition de jeu et l‚Äô√©chelle.",
          "info"
        );
      }catch(err){
        maskValidated = false;
        analyzeBtn.disabled = true;

        const msg = (err && err.message) ? err.message : "";
        if (msg === "Timeout") {
          setStatus(
            "üü° Le service d‚Äôanalyse ne r√©pond pas.\n" +
            "Il est peut-√™tre en cours de d√©marrage ou temporairement indisponible.\n" +
            "R√©essayez dans quelques secondes.",
            "error"
          );
        } else if (msg.includes("Failed to fetch") || msg.includes("NetworkError")) {
          setStatus(
            "üü° Le service d‚Äôanalyse est en cours de d√©marrage.\n" +
            "Patientez quelques secondes puis r√©essayez.",
            "error"
          );
        } else {
          setStatus('Erreur dans le traitement de la photo, merci de la recharger ou de recadrer diff√©remment.', "error");
        }
      }finally{
        setLoading(false);
      }
    }

    function getRadarInfoLabel(usage, scaleKey) {
      if (!usage && !scaleKey) return "‚Äî";
      let usageLabel = "";
      if (usage === "practice") usageLabel = "Practice";
      else if (usage === "parcours") usageLabel = "Parcours";
      else usageLabel = usage || "";

      let scaleLabel = "";
      if (scaleKey === "grand-jeu") scaleLabel = "Grand jeu ‚Äì 5 m / anneau";
      else if (scaleKey === "petit-jeu") scaleLabel = "Petit jeu ‚Äì 1 m / anneau";
      else if (scaleKey === "putting")  scaleLabel = "Putting ‚Äì 0,3 m / anneau";

      if (usageLabel && scaleLabel) return usageLabel + " ‚Äì " + scaleLabel;
      if (usageLabel) return usageLabel;
      if (scaleLabel) return scaleLabel;
      return "‚Äî";
    }

    function computeShotsWithMeters(data, usage, scaleKey, centreDistanceM) {
      const raw = Array.isArray(data.coups) ? data.coups : [];
      if (!raw.length) return [];

      const dbg = data.debug || {};
      const outerRadiusPx = dbg.outer_radius_px;
      if (!outerRadiusPx || outerRadiusPx <= 0) {
        return raw; // fallback
      }

      const ringStepM = RADAR_SCALES[scaleKey];
      if (!ringStepM) {
        return raw;
      }

      const maxDistanceM = NB_RINGS * ringStepM;
      const metersPerPixel = maxDistanceM / outerRadiusPx;

      const isPractice = (usage === "practice");
      const centreBase = isPractice ? (Number(centreDistanceM) || 0) : 0;

      return raw.map((c) => {
        if (c.dx_px === undefined || c.dy_px === undefined) {
          return c;
        }

        const dx_px = c.dx_px;
        const dy_px = c.dy_px;

        const ecart_lateral_m = dx_px * metersPerPixel;
        const ecart_profondeur_m = -dy_px * metersPerPixel; // haut = plus long

        let distance_totale_m = null;
        if (isPractice) {
          const distance_dans_laxe = centreBase + ecart_profondeur_m;
          distance_totale_m = Math.sqrt(
            distance_dans_laxe * distance_dans_laxe +
            ecart_lateral_m * ecart_lateral_m
          );
          distance_totale_m = Math.round(distance_totale_m * 2) / 2;
          distance_totale_m = Number(distance_totale_m.toFixed(1));
        }

        return {
          ...c,
          distance_totale_m: distance_totale_m,
          ecart_lateral_m: Number(ecart_lateral_m.toFixed(1)),
          ecart_profondeur_m: Number(ecart_profondeur_m.toFixed(1))
        };
      });
    }

    async function analyze(){
      if(!maskValidated){
        setStatus('Lancez d\'abord la d√©tection des rep√®res en validant le recadrage (√âtape 1).', "error");
        return;
      }
      const radarUsage = radarUsageSel.value;
      const radarScaleKey = radarScaleSel.value;
      if (!radarUsage || !radarScaleKey) {
        setStatus('S√©lectionnez la condition de jeu et l‚Äô√©chelle du radar (√âtape 2) avant de lancer l‚Äôanalyse.', "error");
        return;
      }

      const isPractice = (radarUsage === "practice");

      if(!dateText.value || !club.value || (isPractice && !targetDist.value)){
        setStatus('Remplissez la date, le club et, en mode Practice, la distance cible.', "error");
        return;
      }
      const file=currentBlob || fileCam.files?.[0] || fileGal.files?.[0];
      if(!file){
        setStatus("Ajoutez ou choisissez une photo d'abord.", "error");
        return;
      }

      const url = API_BASE + '/analyze';
      const fd  = new FormData();
      const imgFile = file instanceof File ? file : new File([file],'capture.jpg',{type:'image/jpeg'});

      fd.append('image', imgFile, imgFile.name);
      fd.append('file', imgFile, imgFile.name);
      fd.append('image_file', imgFile, imgFile.name);
      fd.append('date_text', dateText.value);
      fd.append('club', club.value);
      fd.append('centre_distance', isPractice ? (targetDist.value || "0") : "");

      try{
        setLoading(true, "Analyse des coups‚Ä¶");
        const res = await fetchWithTimeout(url,{method:'POST',body:fd}, 20000);
        if(!res.ok){
          let t='';
          try{ t = await res.text(); }catch(_){}
          throw new Error('HTTP '+res.status+(t?' ‚Äì '+t:'')); 
        }
        const data = await res.json();

        const centreDistanceM = isPractice ? Number(targetDist.value) || 0 : 0;
        const coups = computeShotsWithMeters(data, radarUsage, radarScaleKey, centreDistanceM);

        lastJson = {
          raw: data,
          coups,
          radarUsage,
          radarScaleKey,
          radarScaleM: RADAR_SCALES[radarScaleKey] || null,
          centreDistanceM
        };

        rDate.textContent   = dateText.value;
        rClub.textContent   = club.value || "‚Äî";
        rTarget.textContent = isPractice && targetDist.value ? (targetDist.value + " m") : "‚Äî";

        const radarInfo = getRadarInfoLabel(radarUsage, radarScaleKey);
        rRadar.textContent = radarInfo;

        shotsList.innerHTML = '';
        if (!coups.length) {
          const line = document.createElement('div');
          line.textContent = 'Aucun coup d√©tect√©.';
          shotsList.appendChild(line);
        } else {
          coups.forEach((c, idx)=>{
            const row = document.createElement('div');
            row.className = 'shot-row';

            const left = document.createElement('div');
            left.className = 'shot-left';
            left.textContent = 'Coup ' + (idx+1);

            const right = document.createElement('div');
            right.className = 'shot-right';

            const parts = [];
            if (c.distance_totale_m !== undefined && c.distance_totale_m !== null) parts.push('Dist. ' + c.distance_totale_m + ' m');
            if (c.ecart_lateral_m  !== undefined && c.ecart_lateral_m  !== null)   parts.push('Lat. '  + c.ecart_lateral_m  + ' m');
            if (c.ecart_profondeur_m !== undefined && c.ecart_profondeur_m !== null) parts.push('Prof. ' + c.ecart_profondeur_m + ' m');

            right.textContent = parts.join(' ¬∑ ') || '‚Äî';
            row.appendChild(left);
            row.appendChild(right);
            shotsList.appendChild(row);
          });
        }

        resultCard.classList.remove("hidden");
        setStatus('Analyse termin√©e ‚úÖ\nV√©rifiez les coups avant de les ajouter √† votre historique.', "info");
        setActiveTab(3);
      }catch(err){
        const msg = (err && err.message) ? err.message : "";
        if (msg === "Timeout") {
          setStatus(
            "üü° Le service d‚Äôanalyse ne r√©pond pas.\n" +
            "Il est peut-√™tre en cours de d√©marrage ou temporairement indisponible.\n" +
            "R√©essayez dans quelques secondes.",
            "error"
          );
        } else if (msg.includes("Failed to fetch") || msg.includes("NetworkError")) {
          setStatus(
            "üü° Service d‚Äôanalyse en cours de d√©marrage‚Ä¶\n" +
            "Attendez quelques secondes et relancez l‚Äôanalyse.",
            "error"
          );
        } else {
          setStatus("Analyse impossible : " + msg, "error");
        }
      } finally {
        setLoading(false);
      }
    }
    analyzeBtn.addEventListener('click', analyze);

    function showSavePopup(){
      const pop = $("savePopup");
      if(!pop) return;
      pop.classList.remove("hidden");
      setTimeout(()=>{ pop.classList.add("hidden"); }, 1200);
    }

    function generateSessionId(usage) {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm   = String(d.getMonth()+1).padStart(2,'0');
      const dd   = String(d.getDate()).padStart(2,'0');
      const hh   = String(d.getHours()).padStart(2,'0');
      const mi   = String(d.getMinutes()).padStart(2,'0');
      const suffix = Math.random().toString(36).slice(2,5);
      const u = usage || "unknown";
      return `${yyyy}${mm}${dd}-${hh}${mi}-${u}-${suffix}`;
    }

    function addCurrentResultToHistory() {
      if (!lastJson) {
        setStatus("Aucun r√©sultat √† enregistrer. Faites d‚Äôabord une analyse.", "error");
        return;
      }
      const coups = Array.isArray(lastJson.coups) ? lastJson.coups : [];
      if (coups.length === 0) {
        setStatus("Aucun coup d√©tect√©, rien √† ajouter √† l‚Äôhistorique.", "error");
        return;
      }

      let history = [];
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (raw) history = JSON.parse(raw) || [];
      } catch (e) {
        history = [];
      }

      const radarUsage   = radarUsageSel.value || lastJson.radarUsage || null;
      const radarScaleKey = radarScaleSel.value || lastJson.radarScaleKey || null;
      const radarScaleM  = RADAR_SCALES[radarScaleKey] || lastJson.radarScaleM || null;

      const radarInfo = getRadarInfoLabel(radarUsage, radarScaleKey);
      const dateVal   = dateText.value;
      const clubVal   = club.value;
      const cibleVal  = (radarUsage === "practice") ? (Number(targetDist.value) || null) : null;

      const sessionId = generateSessionId(radarUsage);

      coups.forEach(c => {
        history.push({
          session_id: sessionId,
          date_text: dateVal,
          radar_usage: radarUsage,
          radar_scale_key: radarScaleKey,
          radar_scale_m: radarScaleM,
          club: clubVal,
          distance_cible_m: cibleVal,
          radar_info: radarInfo,
          distance_totale_m: c.distance_totale_m,
          ecart_lateral_m: c.ecart_lateral_m,
          ecart_profondeur_m: c.ecart_profondeur_m
        });
      });

      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        showSavePopup();
        setTimeout(()=> {
          window.location.href = "index.html";
        }, 1300);
      } catch (e) {
        setStatus("Impossible d‚Äôenregistrer dans l‚Äôhistorique (quota navigateur atteint ?).", "error");
      }
    }

    function clearCurrentResult() {
      resetResultState();
      setStatus("R√©sultat effac√©.\nVous pouvez refaire une analyse avec une nouvelle photo.", "info");
      setTimeout(() => {
        window.location.href = "index.html";
      }, 1000);
    }

    saveToHistoryBtn.addEventListener('click', addCurrentResultToHistory);
    clearResultBtn.addEventListener('click', clearCurrentResult);

    step1El.addEventListener('click', ()=> setActiveTab(1));
    step2El.addEventListener('click', ()=> setActiveTab(2));
    step3El.addEventListener('click', ()=> setActiveTab(3));

    /* S√©lecteur de clubs */
    function renderClubList(query) {
      const q = (query || "").trim().toLowerCase();
      clubList.innerHTML = "";
      const filtered = CLUBS.filter(name => !q || name.toLowerCase().includes(q));
      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "modal-empty";
        empty.textContent = "Aucun club trouv√©.";
        clubList.appendChild(empty);
        return;
      }
      filtered.forEach(name => {
        const item = document.createElement("div");
        item.className = "modal-item";
        item.textContent = name;
        item.addEventListener("click", () => {
          club.value = name;
          clubDisplay.textContent = name;
          clubDisplay.classList.add("select-club-btn--filled");
          closeClubModalFn();
        });
        clubList.appendChild(item);
      });
    }

    function openClubModal() {
      clubModalBackdrop.classList.remove("hidden");
      clubSearch.value = "";
      renderClubList("");
    }

    function closeClubModalFn() {
      clubModalBackdrop.classList.add("hidden");
    }

    clubDisplay.addEventListener("click", openClubModal);
    closeClubModal.addEventListener("click", closeClubModalFn);
    clubModalBackdrop.addEventListener("click", (e)=>{
      if (e.target === clubModalBackdrop) {
        closeClubModalFn();
      }
    });
    clubSearch.addEventListener("input", (e)=>{
      renderClubList(e.target.value);
    });

    /* Changement type radar : gestion du champ distance cible */
    radarUsageSel.addEventListener("change", () => {
      const usage = radarUsageSel.value;
      if (usage === "practice") {
        targetRow.classList.remove("hidden");
      } else {
        targetRow.classList.add("hidden");
      }
    });

    /* Recadrage */

    function resetCropState() {
      cropImg = null;
      cropScaleX = 1;
      cropScaleY = 1;
      cropRect = null;
      isCropping = false;
      cropStartX = 0;
      cropStartY = 0;
      if (cropCanvas) {
        const ctx = cropCanvas.getContext("2d");
        ctx && ctx.clearRect(0,0,cropCanvas.width,cropCanvas.height);
      }
    }

    async function openCropModal() {
      if (!currentBlob) {
        setStatus("Ajoutez ou choisissez une photo d'abord.", "error");
        return;
      }
      resetCropState();
      cropModalBackdrop.classList.remove("hidden");

      try {
        const img = new Image();
        img.src = URL.createObjectURL(currentBlob);
        await img.decode();
        cropImg = img;

        const maxCanvasWidth = Math.min(800, window.innerWidth - 60);
        const ratio = img.naturalWidth / img.naturalHeight;
        let canvasWidth = maxCanvasWidth;
        let canvasHeight = Math.round(canvasWidth / ratio);

        const maxCanvasHeight = Math.min(500, window.innerHeight - 220);
        if (canvasHeight > maxCanvasHeight) {
          canvasHeight = maxCanvasHeight;
          canvasWidth = Math.round(canvasHeight * ratio);
        }

        cropCanvas.width = canvasWidth;
        cropCanvas.height = canvasHeight;

        cropScaleX = canvasWidth / img.naturalWidth;
        cropScaleY = canvasHeight / img.naturalHeight;

        cropRect = null;
        redrawCropCanvas();
      } catch (e) {
        setStatus("Impossible d‚Äôouvrir la photo pour recadrage.", "error");
        cropModalBackdrop.classList.add("hidden");
      }
    }

    function closeCropModalFn() {
      cropModalBackdrop.classList.add("hidden");
    }

    openCropModalBtn.addEventListener("click", openCropModal);
    closeCropModalBtn.addEventListener("click", closeCropModalFn);
    cancelCropBtn.addEventListener("click", closeCropModalFn);
    cropModalBackdrop.addEventListener("click", (e)=>{
      if (e.target === cropModalBackdrop) {
        closeCropModalFn();
      }
    });

    function redrawCropCanvas() {
      if (!cropImg || !cropCanvas) return;
      const ctx = cropCanvas.getContext("2d");

      ctx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
      ctx.drawImage(cropImg, 0, 0, cropCanvas.width, cropCanvas.height);

      if (cropRect && cropRect.w > 2 && cropRect.h > 2) {
        ctx.save();
        ctx.fillStyle = "rgba(0,0,0,0.20)";
        ctx.fillRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);
        ctx.strokeStyle = "rgba(255,255,255,0.9)";
        ctx.lineWidth = 2;
        ctx.strokeRect(
          cropRect.x + 1,
          cropRect.y + 1,
          cropRect.w - 2,
          cropRect.h - 2
        );
        ctx.restore();
      }
    }

    function getCanvasCoords(evt) {
      const rect = cropCanvas.getBoundingClientRect();
      const scaleX = cropCanvas.width / rect.width;
      const scaleY = cropCanvas.height / rect.height;
      const x = (evt.clientX - rect.left) * scaleX;
      const y = (evt.clientY - rect.top) * scaleY;
      return { x, y };
    }

    if (cropCanvas) {
      cropCanvas.addEventListener("pointerdown", (e)=>{
        if (!cropImg) return;
        cropCanvas.setPointerCapture(e.pointerId);
        const {x,y} = getCanvasCoords(e);
        isCropping = true;
        cropStartX = x;
        cropStartY = y;
        cropRect = { x, y, w: 0, h: 0 };
        redrawCropCanvas();
      });

      cropCanvas.addEventListener("pointermove", (e)=>{
        if (!isCropping || !cropImg) return;
        const {x,y} = getCanvasCoords(e);
        const x0 = Math.min(cropStartX, x);
        const y0 = Math.min(cropStartY, y);
        const w  = Math.abs(x - cropStartX);
        const h  = Math.abs(y - cropStartY);
        cropRect = {
          x: Math.max(0, Math.min(x0, cropCanvas.width)),
          y: Math.max(0, Math.min(y0, cropCanvas.height)),
          w: Math.max(0, Math.min(w, cropCanvas.width)),
          h: Math.max(0, Math.min(h, cropCanvas.height))
        };
        redrawCropCanvas();
      });

      cropCanvas.addEventListener("pointerup", (e)=>{
        if (!isCropping) return;
        isCropping = false;
        cropCanvas.releasePointerCapture(e.pointerId);
        redrawCropCanvas();
      });

      cropCanvas.addEventListener("pointercancel", (e)=>{
        if (!isCropping) return;
        isCropping = false;
        cropCanvas.releasePointerCapture(e.pointerId);
        redrawCropCanvas();
      });
    }

    async function validateCrop() {
      if (!cropImg) {
        setStatus("Impossible de recadrer : image introuvable.", "error");
        return;
      }

      try {
        let blob;

        if (!cropRect || cropRect.w < 5 || cropRect.h < 5) {
          // Pas de s√©lection : on utilise toute l‚Äôimage
          const canvas = document.createElement("canvas");
          canvas.width = cropImg.naturalWidth;
          canvas.height = cropImg.naturalHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(cropImg, 0, 0, canvas.width, canvas.height);

          blob = await new Promise((resolve, reject)=>{
            canvas.toBlob(b=>{
              if (!b) reject(new Error("toBlob a √©chou√©"));
              else resolve(b);
            }, "image/jpeg", 0.9);
          });

          setStatus("Recadrage non dessin√© : l‚Äôimage enti√®re sera utilis√©e.\nLancement de la d√©tection des rep√®res‚Ä¶", "info");
        } else {
          // Utilisation de la zone s√©lectionn√©e
          const sx = cropRect.x / cropScaleX;
          const sy = cropRect.y / cropScaleY;
          const sw = cropRect.w / cropScaleX;
          const sh = cropRect.h / cropScaleY;

          const outW = Math.round(sw);
          const outH = Math.round(sh);

          const canvas = document.createElement("canvas");
          canvas.width = outW;
          canvas.height = outH;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(
            cropImg,
            sx, sy, sw, sh,
            0, 0, outW, outH
          );

          blob = await new Promise((resolve, reject)=>{
            canvas.toBlob(b=>{
              if (!b) reject(new Error("toBlob a √©chou√©"));
              else resolve(b);
            }, "image/jpeg", 0.9);
          });

          setStatus("Photo recadr√©e ‚úÖ\nLancement de la d√©tection des rep√®res‚Ä¶", "info");
        }

        currentBlob = new File([blob], "capture_crop.jpg", { type: "image/jpeg" });

        resetResultState();
        maskValidated = false;
        analyzeBtn.disabled = true;

        showPreview(currentBlob);
        closeCropModalFn();
        await generateMask();
      } catch (e) {
        setStatus("Erreur pendant le recadrage de l‚Äôimage.", "error");
      }
    }

    validateCropBtn.addEventListener("click", validateCrop);

    /* Init */
    setActiveTab(1);
    refreshSteps();

    // Message d‚Äôinfo initial en vert (√©ph√©m√®re 10s) ‚Äî on le garde
    setStatus(
      "Pour une d√©tection fiable : prenez la photo bien √† la verticale au-dessus de la feuille, et v√©rifiez que les deux rep√®res du bas sont bien visibles et align√©s dans l‚Äôimage.",
      "info"
    );
  </script>

  <script>
    const RENDER_URL = "https://todogolf-analyse.onrender.com/";

    function pingRender() {
      try {
        fetch(RENDER_URL, {
          method: "HEAD",
          mode: "no-cors"
        }).catch(() => {});
      } catch (e) {}
    }

    pingRender();
    setInterval(pingRender, 5 * 60 * 1000);
  </script>
</body>
</html>
