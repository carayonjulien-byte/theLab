<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>ToDoGolf Lab â€“ Analyse</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --gap: 16px;
      --primary: #00503a;
      --primary-light: #00684b;
      --bg: #050608;
      --card: #0f1419;
      --border: #182028;
      --text: #e7e8ea;
      --muted: #9ca3af;
      --accent: #fbbf24; /* Jaune/Or pour les points */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #06141a 0, #020309 55%, #000 100%);
      color: var(--text);
      padding-bottom: 80px; /* Espace pour le scroll */
    }
    .hidden { display:none !important; }

    /* --- TOPBAR --- */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(to bottom, rgba(5,6,8,0.96), rgba(5,6,8,0.9));
      border-bottom: 1px solid #10151e;
      padding: 10px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      backdrop-filter: blur(12px);
    }
    .brand-dot {
      width:20px; height:20px;
      border-radius:50%;
      background:var(--primary);
      box-shadow:0 0 12px rgba(0,80,58,0.8);
    }
    .top-title { font-weight:700; font-size:16px; margin-left:10px; }
    .btn-close {
      text-decoration:none; color:var(--text); font-size:12px; 
      background:#111827; padding:6px 12px; border-radius:99px; border:1px solid #374151;
    }

    .wrap { max-width: 1120px; margin: 0 auto; padding: 16px; }

    /* --- KPIS (Haut de page) --- */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .kpi-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      text-align: center;
    }
    .kpi-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom:4px; }
    .kpi-value { font-size: 18px; font-weight: 700; color: #fff; }
    .kpi-sub { font-size: 10px; color: var(--primary); margin-top:2px; }

    /* --- NAVIGATION ONGLETS (Segmented Control) --- */
    .nav-tabs {
      display: flex;
      background: #0f1419;
      padding: 4px;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
      position: relative;
    }
    .nav-tab {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      z-index: 2;
      transition: color 0.2s ease;
      border-radius: 8px;
    }
    .nav-tab.active {
      color: #fff;
      background: var(--border); /* Fallback */
      background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      border: 1px solid #374151;
    }

    /* --- CONTENU DES ONGLETS --- */
    .tab-content {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform:translateY(5px); } to { opacity: 1; transform:translateY(0); } }

    /* CARD COMMUNE */
    .chart-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .card-title { font-size: 15px; font-weight: 600; display:flex; align-items:center; gap:6px; }

    /* INPUTS & FILTERS */
    select, input[type=number] {
      background: #05080c;
      color: #fff;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 13px;
      outline: none;
    }
    select:focus, input:focus { border-color: var(--primary); }

    /* CHART CONTAINERS */
    .chart-box {
      position: relative;
      height: 320px;
      width: 100%;
    }
    /* Pour le scroll horizontal du Bag Mapping */
    .scroll-chart-box {
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .scroll-chart-inner {
      min-width: 600px; /* Force la largeur pour le scroll */
      height: 300px;
    }

    /* --- CADDIE SPECIFIC --- */
    .caddie-input-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }
    .caddie-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }
    .caddie-result {
      text-align: center;
      padding: 20px;
      background: linear-gradient(180deg, rgba(0,80,58,0.1) 0%, rgba(0,0,0,0) 100%);
      border-radius: 16px;
      border: 1px solid var(--primary);
    }
    .rec-club { font-size: 32px; font-weight: 800; color: #fff; margin: 10px 0; text-shadow: 0 0 20px rgba(0,80,58,0.6); }
    .rec-meta { font-size: 12px; color: var(--muted); }
    .confidence-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 99px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }
    .conf-high { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid #059669; }
    .conf-med { background: rgba(251, 191, 36, 0.15); color: #fbbf24; border: 1px solid #b45309; }
    .conf-low { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid #b91c1c; }

  </style>
</head>
<body>

  <header class="topbar">
    <div style="display:flex; align-items:center;">
      <div class="brand-dot"></div>
      <div class="top-title">ToDoGolf Lab</div>
    </div>
    <a href="index.html" class="btn-close">Fermer</a>
  </header>

  <main class="wrap">
    
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">Total Coups</div>
        <div class="kpi-value" id="kpiCount">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Sessions</div>
        <div class="kpi-value" id="kpiSessions">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Club Favori</div>
        <div class="kpi-value" id="kpiFav" style="font-size:14px;">-</div>
      </div>
    </div>

    <nav class="nav-tabs">
      <div class="nav-tab active" onclick="switchTab('radar', this)">ðŸŽ¯ Radar</div>
      <div class="nav-tab" onclick="switchTab('mapping', this)">ðŸ“Š Mapping</div>
      <div class="nav-tab" onclick="switchTab('caddie', this)">ðŸ¤– Caddie</div>
    </nav>

    <div id="viewRadar" class="tab-content">
      <div class="chart-card">
        <div class="card-header">
          <div class="card-title">Dispersion & Heatmap</div>
          <select id="radarClubSelect" onchange="updateRadarChart()">
            <option value="all">Tous les clubs</option>
            </select>
        </div>
        <div class="chart-box">
          <canvas id="canvasRadar"></canvas>
        </div>
        <div style="margin-top:10px; font-size:11px; color:#6b7280; text-align:center;">
          Les points rouges = zones de forte densitÃ©.<br>Le centre (0,0) reprÃ©sente votre cible.
        </div>
      </div>
    </div>

    <div id="viewMapping" class="tab-content hidden">
      <div class="chart-card">
        <div class="card-header">
          <div class="card-title">Ã‰talonnage du sac</div>
        </div>
        <div class="scroll-chart-box">
          <div class="scroll-chart-inner" id="mappingInner">
            <canvas id="canvasMapping"></canvas>
          </div>
        </div>
        <div style="margin-top:10px; font-size:11px; color:#6b7280; text-align:center;">
          Barre = Distance Min Ã  Max. Point = Moyenne.<br>DÃ©filez horizontalement pour voir tous les clubs.
        </div>
      </div>
    </div>

    <div id="viewCaddie" class="tab-content hidden">
      <div class="chart-card">
        <div class="card-header">
          <div class="card-title">Assistant de choix</div>
        </div>
        
        <div class="caddie-input-row">
          <input type="number" id="caddieDist" placeholder="Dist. (m)" style="flex:1; padding:10px;" inputmode="numeric">
          <button class="caddie-btn" onclick="askCaddie()">Calculer</button>
        </div>

        <div id="caddieOutput" class="hidden">
          <div class="caddie-result">
            <div class="kpi-label">Conseil Lab</div>
            <div class="rec-club" id="recClubName">Fer 7</div>
            <div class="rec-meta">Moyenne : <span id="recClubAvg">135</span> m</div>
            <div class="rec-meta" style="margin-top:4px">Dispersion latÃ©rale : <span id="recClubDisp">Â±5</span> m</div>
            <div id="recConf" class="confidence-badge conf-high">Confiance : Ã‰levÃ©e</div>
          </div>
          <div style="margin-top:15px; font-size:12px; color:#9ca3af; line-height:1.4;">
            BasÃ© sur vos <strong><span id="recNbShots">0</span></strong> derniers coups avec ce club.<br>
            <em>La data bat l'ego, jouez la sÃ©curitÃ© !</em>
          </div>
        </div>
        
        <div id="caddieEmpty" style="text-align:center; padding:20px; color:#6b7280; font-size:13px;">
          Entrez une distance pour obtenir une recommandation basÃ©e sur vos stats.
        </div>
      </div>
    </div>

  </main>

  <script>
    // --- CONFIGURATION CHART.JS ---
    Chart.defaults.color = '#9ca3af';
    Chart.defaults.borderColor = '#1f2937';
    Chart.defaults.font.family = 'system-ui, sans-serif';

    const HISTORY_KEY = "todogolf_lab_history";
    let globalHistory = [];

    // --- CHARGEMENT DES DONNEES ---
    function loadData() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      } catch(e) { return []; }
    }

    // Tri des clubs (ordre logique)
    const CLUB_ORDER = [
      "Putter", "Chipper", 
      "Wedge 64Â°", "Wedge 62Â°", "Wedge 60Â°", "Wedge 58Â°", "Wedge 56Â°", "Wedge 54Â°", "Wedge 52Â°", "Wedge 50Â°",
      "SW", "PW", "AW", 
      "Fer 9", "Fer 8", "Fer 7", "Fer 6", "Fer 5", "Fer 4", "Fer 3", "Fer 2",
      "Hybride 5", "Hybride 4", "Hybride 3", "Hybride 2",
      "Bois 9", "Bois 7", "Bois 5", "Bois 3",
      "Driver"
    ];
    const getClubRank = c => {
      const idx = CLUB_ORDER.indexOf(c);
      return idx === -1 ? 999 : idx;
    };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      globalHistory = loadData();
      updateKPIs();
      initRadar();
      // Les autres inits se feront au clic onglet pour Ã©conomiser les ressources
    });

    // --- GESTION ONGLETS ---
    function switchTab(tabName, btnEl) {
      // Update boutons
      document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
      btnEl.classList.add('active');

      // Hide all contents
      document.getElementById('viewRadar').classList.add('hidden');
      document.getElementById('viewMapping').classList.add('hidden');
      document.getElementById('viewCaddie').classList.add('hidden');

      // Show selected
      if(tabName === 'radar') {
        document.getElementById('viewRadar').classList.remove('hidden');
        updateRadarChart(); // Refresh
      } else if(tabName === 'mapping') {
        document.getElementById('viewMapping').classList.remove('hidden');
        initMapping(); // Build chart if needed
      } else if(tabName === 'caddie') {
        document.getElementById('viewCaddie').classList.remove('hidden');
      }
    }

    // --- 1. KPIs ---
    function updateKPIs() {
      const count = globalHistory.length;
      const sessions = new Set(globalHistory.map(x => x.session_id || x.date_text)).size;
      
      const counts = {};
      globalHistory.forEach(x => { if(x.club) counts[x.club] = (counts[x.club]||0)+1; });
      let fav = "-", max = 0;
      for(let [c, n] of Object.entries(counts)){ if(n>max){ max=n; fav=c;} }

      document.getElementById('kpiCount').textContent = count;
      document.getElementById('kpiSessions').textContent = sessions;
      document.getElementById('kpiFav').textContent = fav;

      // Populate Club Select for Radar
      const clubSelect = document.getElementById('radarClubSelect');
      const uniqueClubs = Object.keys(counts).sort((a,b) => getClubRank(a) - getClubRank(b));
      uniqueClubs.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        clubSelect.appendChild(opt);
      });
      // Select favorite by default if exists
      if(fav !== "-") clubSelect.value = fav;
    }

    // --- 2. RADAR CHART (Scatter) ---
    let radarChart = null;

    function initRadar() {
      // Juste prÃ©pare le canvas, updateRadarChart fera le reste
      updateRadarChart();
    }

    function updateRadarChart() {
      const selectedClub = document.getElementById('radarClubSelect').value;
      
      // Filtrer les donnÃ©es
      // On exclut Putter pour le radar car les Ã©chelles sont trop diffÃ©rentes
      const dataPoints = globalHistory
        .filter(r => {
          if(r.club === 'Putter') return false;
          if(selectedClub !== 'all' && r.club !== selectedClub) return false;
          return (r.ecart_lateral_m != null && r.ecart_profondeur_m != null);
        })
        .map(r => ({
          x: Number(r.ecart_lateral_m),
          y: Number(r.ecart_profondeur_m)
        }));

      const ctx = document.getElementById('canvasRadar').getContext('2d');

      if(radarChart) radarChart.destroy();

      radarChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Impacts',
            data: dataPoints,
            // Heatmap trick: Transparence + Couleur vive (Rouge/Orange)
            // Quand ils se superposent, Ã§a devient foncÃ©
            backgroundColor: 'rgba(251, 191, 36, 0.4)', 
            borderColor: 'rgba(251, 191, 36, 0.8)',
            borderWidth: 1,
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: (c) => `Lat: ${c.parsed.x}m, Prof: ${c.parsed.y}m` }
            }
          },
          scales: {
            x: {
              title: { display:true, text:'Gauche (-) / Droite (+)', color:'#6b7280', font:{size:10} },
              grid: { color:'#374151', tickLength:5 },
              ticks: { color:'#9ca3af' },
              suggestedMin: -20, suggestedMax: 20
            },
            y: {
              title: { display:true, text:'Court (-) / Long (+)', color:'#6b7280', font:{size:10} },
              grid: { color:'#374151' },
              ticks: { color:'#9ca3af' },
              suggestedMin: -20, suggestedMax: 20
            }
          }
        }
      });
    }

    // --- 3. MAPPING CHART (Floating Bars) ---
    let mappingChart = null;

    function initMapping() {
      if(mappingChart) return; // DÃ©jÃ  crÃ©Ã©

      // 1. Calc stats per club
      const stats = {};
      globalHistory.forEach(r => {
        if(!r.club || r.club === 'Putter') return;
        const d = Number(r.distance_totale_m);
        if(!d || d < 5) return; // Filter noise

        if(!stats[r.club]) stats[r.club] = { min:9999, max:0, sum:0, count:0 };
        if(d < stats[r.club].min) stats[r.club].min = d;
        if(d > stats[r.club].max) stats[r.club].max = d;
        stats[r.club].sum += d;
        stats[r.club].count++;
      });

      // 2. Format for Chart.js
      // Floating bar data format: [min, max]
      const clubs = Object.keys(stats).sort((a,b) => getClubRank(a) - getClubRank(b));
      
      const dataBars = [];
      const dataAvgs = [];

      clubs.forEach(c => {
        const s = stats[c];
        const avg = s.sum / s.count;
        dataBars.push([s.min, s.max]);
        dataAvgs.push(avg); // For a line or dot
      });

      // Ajuster la largeur du container pour le scroll
      const box = document.getElementById('mappingInner');
      // Environ 50px par club, min 100%
      const width = Math.max(100, clubs.length * 50); 
      box.style.width = width + '%';
      if (clubs.length < 6) box.style.width = "100%"; // Pas de scroll si peu de clubs

      const ctx = document.getElementById('canvasMapping').getContext('2d');
      
      mappingChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: clubs,
          datasets: [
            {
              label: 'Plage (Min-Max)',
              data: dataBars,
              backgroundColor: 'rgba(0, 80, 58, 0.6)',
              borderColor: '#00503a',
              borderWidth: 1,
              borderSkipped: false,
              barPercentage: 0.6
            },
            {
              type: 'scatter',
              label: 'Moyenne',
              data: dataAvgs,
              backgroundColor: '#fbbf24',
              borderColor: '#fff',
              borderWidth: 1,
              pointRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.dataset.type === 'scatter') {
                    return `Moyenne: ${Math.round(context.raw)} m`;
                  }
                  return `Plage: ${context.raw[0]}m - ${context.raw[1]}m`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#1f2937' },
              title: { display:true, text:'Distance (m)' }
            },
            x: {
              grid: { display: false },
              ticks: { font: { size: 11 } }
            }
          }
        }
      });
    }

    // --- 4. SMART CADDIE ---
    function askCaddie() {
      const distInput = document.getElementById('caddieDist');
      const target = Number(distInput.value);

      if (!target || target <= 0) {
        alert("Entrez une distance valide.");
        return;
      }

      // 1. Calculate avg for all clubs
      const clubStats = {};
      globalHistory.forEach(r => {
        if(!r.club || r.club === 'Putter') return;
        const d = Number(r.distance_totale_m);
        const lat = Math.abs(Number(r.ecart_lateral_m) || 0);
        if(!d || d < 5) return;

        if(!clubStats[r.club]) clubStats[r.club] = { sum:0, count:0, sumLat:0 };
        clubStats[r.club].sum += d;
        clubStats[r.club].sumLat += lat;
        clubStats[r.club].count++;
      });

      let bestClub = null;
      let minDiff = 9999;

      Object.keys(clubStats).forEach(c => {
        const avg = clubStats[c].sum / clubStats[c].count;
        const diff = Math.abs(avg - target);
        // On cherche le club le plus proche
        if (diff < minDiff) {
          minDiff = diff;
          bestClub = c;
        }
      });

      if (!bestClub) {
        alert("Pas assez de donnÃ©es pour recommander un club.");
        return;
      }

      const s = clubStats[bestClub];
      const avgDist = Math.round(s.sum / s.count);
      const avgLat = s.sumLat / s.count;

      // Affichage
      document.getElementById('caddieEmpty').classList.add('hidden');
      document.getElementById('caddieOutput').classList.remove('hidden');

      document.getElementById('recClubName').textContent = bestClub;
      document.getElementById('recClubAvg').textContent = avgDist;
      document.getElementById('recClubDisp').textContent = "Â±" + Math.round(avgLat);
      document.getElementById('recNbShots').textContent = s.count;

      // Indice confiance (basÃ© sur dispersion latÃ©rale et nbr coups)
      const confBadge = document.getElementById('recConf');
      confBadge.className = "confidence-badge"; // reset
      
      let confidence = "Moyenne";
      let cssClass = "conf-med";

      // Logique arbitraire mais rÃ©aliste
      if (s.count < 5) {
        confidence = "Faible (peu de donnÃ©es)";
        cssClass = "conf-low";
      } else if (avgLat > 15) {
        confidence = "Faible (dispersion haute)";
        cssClass = "conf-low";
      } else if (avgLat < 8 && minDiff < 10) {
        confidence = "Ã‰levÃ©e";
        cssClass = "conf-high";
      } else {
        confidence = "Moyenne";
        cssClass = "conf-med";
      }

      confBadge.textContent = "Confiance : " + confidence;
      confBadge.classList.add(cssClass);
    }

  </script>
</body>
</html>
