<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>ToDoGolf Lab ‚Äì Statistiques</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --gap: 16px;
      --primary: #00503a;
      --bg: #050608;
      --card: #0f1419;
      --border: #182028;
      --text: #e7e8ea;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #06141a 0, #020309 55%, #000 100%);
      color: var(--text);
      padding-bottom: 80px;
    }
    .hidden { display:none !important; }

    /* --- TOPBAR --- */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(to bottom, rgba(5,6,8,0.96), rgba(5,6,8,0.9));
      border-bottom: 1px solid #10151e;
      padding: 10px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      backdrop-filter: blur(12px);
    }
    .brand-dot {
      width:20px; height:20px;
      border-radius:50%;
      background:var(--primary);
      box-shadow:0 0 12px rgba(0,80,58,0.8);
    }
    .top-title { font-weight:700; font-size:16px; margin-left:10px; }
    
    .btn-top {
      border-radius:999px;
      border:1px solid #26303b;
      background:#0b1016;
      padding:6px 12px;
      font-size:12px;
      color:var(--text);
      text-decoration:none;
      white-space:nowrap;
      display:flex; align-items:center; gap:4px;
    }
    .btn-top:hover { background:#101822; }

    .wrap { max-width: 1120px; margin: 0 auto; padding: 16px; }

    /* --- KPIS --- */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .kpi-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      text-align: center;
    }
    .kpi-label { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom:4px; }
    .kpi-value { font-size: 18px; font-weight: 700; color: #fff; }

    /* --- TABS --- */
    .nav-tabs {
      display: flex;
      background: #0f1419;
      padding: 4px;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .nav-tab {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .nav-tab.active {
      color: #fff;
      background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      border: 1px solid #374151;
    }

    .tab-content { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform:translateY(5px); } to { opacity: 1; transform:translateY(0); } }

    /* --- CARDS & FILTERS --- */
    .chart-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }
    .card-header {
      margin-bottom: 12px;
    }
    .card-title { font-size: 15px; font-weight: 600; margin-bottom: 10px; }
    
    /* Zone de filtres */
    .filters-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }
    .filters-row.full { grid-template-columns: 1fr; }

    select, input[type=date], input[type=number] {
      background: #05080c;
      color: #fff;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      width: 100%;
      outline: none;
    }
    
    .chart-box {
      position: relative;
      height: 350px; /* Un peu plus haut pour le mapping */
      width: 100%;
    }

    /* --- CADDIE --- */
    .caddie-input-row { display: flex; gap: 10px; margin-bottom: 20px; }
    .caddie-btn {
      background: var(--primary); color: #fff; border: none;
      padding: 0 20px; border-radius: 8px; font-weight: 600; cursor: pointer;
    }
    .caddie-result {
      text-align: center; padding: 20px;
      background: linear-gradient(180deg, rgba(0,80,58,0.1) 0%, rgba(0,0,0,0) 100%);
      border-radius: 16px; border: 1px solid var(--primary);
    }
    .rec-club { font-size: 32px; font-weight: 800; color: #fff; margin: 10px 0; text-shadow: 0 0 20px rgba(0,80,58,0.6); }
    .confidence-badge {
      display: inline-block; padding: 4px 10px; border-radius: 99px;
      font-size: 11px; font-weight: 600; margin-top: 8px;
    }
    .conf-high { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid #059669; }
    .conf-med { background: rgba(251, 191, 36, 0.15); color: #fbbf24; border: 1px solid #b45309; }
    .conf-low { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid #b91c1c; }

  </style>
</head>
<body>

  <header class="topbar">
    <div style="display:flex; align-items:center;">
      <div class="brand-dot"></div>
      <div class="top-title">ToDoGolf Lab</div>
    </div>
    <a href="index.html" class="btn-top">‚Üê Accueil</a>
  </header>

  <main class="wrap">
    
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">Coups</div>
        <div class="kpi-value" id="kpiCount">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Sessions</div>
        <div class="kpi-value" id="kpiSessions">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Favori</div>
        <div class="kpi-value" id="kpiFav" style="font-size:14px;">-</div>
      </div>
    </div>

    <nav class="nav-tabs">
      <div class="nav-tab active" onclick="switchTab('radar', this)">üéØ Radar</div>
      <div class="nav-tab" onclick="switchTab('mapping', this)">üìä Mapping</div>
      <div class="nav-tab" onclick="switchTab('caddie', this)">ü§ñ Caddie</div>
    </nav>

    <div id="viewRadar" class="tab-content">
      <div class="chart-card">
        <div class="card-header">
          <div class="card-title">Dispersion & Pr√©cision</div>
          
          <div class="filters-row">
            <input type="date" id="radarStart" onchange="updateRadarChart()">
            <input type="date" id="radarEnd" onchange="updateRadarChart()">
          </div>
          <div class="filters-row">
            <select id="radarContext" onchange="updateRadarChart()">
              <option value="all">Toutes conditions</option>
              <option value="practice">Practice</option>
              <option value="parcours">Parcours</option>
            </select>
            <select id="radarClubSelect" onchange="updateRadarChart()">
              <option value="all">Tous les clubs</option>
              </select>
          </div>
        </div>

        <div class="chart-box">
          <canvas id="canvasRadar"></canvas>
        </div>
        <div style="margin-top:10px; font-size:11px; color:#6b7280; text-align:center;">
          Centre (0,0) = Cible vis√©e.<br>L'√©chelle s'adapte automatiquement aux donn√©es.
        </div>
      </div>
    </div>

    <div id="viewMapping" class="tab-content hidden">
      <div class="chart-card">
        <div class="card-header">
          <div class="card-title">Vue A√©rienne (Trackman Style)</div>
          <div class="filters-row">
            <select id="mapContext" onchange="updateMappingChart()">
              <option value="all">Tout (Practice & Parcours)</option>
              <option value="practice">Seulement Practice</option>
            </select>
            <select id="mapType" onchange="updateMappingChart()">
              <option value="all">Tous types de coups</option>
              <option value="Normal">Normal</option>
              <option value="Draw">Draw</option>
              <option value="Fade">Fade</option>
            </select>
          </div>
        </div>

        <div class="chart-box">
          <canvas id="canvasMapping"></canvas>
        </div>
        <div style="margin-top:10px; font-size:11px; color:#6b7280; text-align:center;">
          Chaque couleur est un club diff√©rent.<br>
          Axe vertical = Distance Totale. Axe horizontal = Dispersion.
        </div>
      </div>
    </div>

    <div id="viewCaddie" class="tab-content hidden">
      <div class="chart-card">
        <div class="card-header">
          <div class="card-title">Assistant de choix</div>
        </div>
        
        <div class="caddie-input-row">
          <input type="number" id="caddieDist" placeholder="Distance (m)" style="flex:1; padding:12px;" inputmode="numeric">
          <button class="caddie-btn" onclick="askCaddie()">Calculer</button>
        </div>

        <div id="caddieOutput" class="hidden">
          <div class="caddie-result">
            <div class="kpi-label">Conseil Lab</div>
            <div class="rec-club" id="recClubName">-</div>
            <div style="font-size:12px; color:#9ca3af;">
              Moyenne : <span id="recClubAvg" style="color:#fff; font-weight:600;">-</span> m<br>
              Dispersion lat√©rale : <span id="recClubDisp" style="color:#fff; font-weight:600;">-</span> m
            </div>
            <div id="recConf" class="confidence-badge conf-med">Confiance : -</div>
          </div>
          <div style="margin-top:15px; font-size:12px; color:#9ca3af; line-height:1.4; text-align:center;">
            Bas√© sur vos <strong><span id="recNbShots">0</span></strong> derniers coups avec ce club.
          </div>
        </div>
        
        <div id="caddieEmpty" style="text-align:center; padding:40px 20px; color:#6b7280; font-size:13px;">
          Entrez une distance √† parcourir pour obtenir la meilleure recommandation.
        </div>
      </div>
    </div>

  </main>

  <script>
    // --- CONFIG CHART.JS ---
    Chart.defaults.color = '#9ca3af';
    Chart.defaults.borderColor = '#1f2937';
    Chart.defaults.font.family = 'system-ui, sans-serif';

    const HISTORY_KEY = "todogolf_lab_history";
    let globalHistory = [];

    // Palette de couleurs pour le Mapping (15 couleurs distinctes)
    const CLUB_COLORS = [
      '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', // Rouges/Jaunes
      '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', // Verts/Bleus
      '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef'  // Bleus/Violets
    ];

    const CLUB_ORDER = [
      "Putter", "Chipper", 
      "Wedge 64¬∞", "Wedge 62¬∞", "Wedge 60¬∞", "Wedge 58¬∞", "Wedge 56¬∞", "Wedge 54¬∞", "Wedge 52¬∞", "Wedge 50¬∞",
      "SW", "PW", "AW", 
      "Fer 9", "Fer 8", "Fer 7", "Fer 6", "Fer 5", "Fer 4", "Fer 3", "Fer 2",
      "Hybride 5", "Hybride 4", "Hybride 3", "Hybride 2",
      "Bois 9", "Bois 7", "Bois 5", "Bois 3",
      "Driver"
    ];
    const getClubRank = c => {
      const idx = CLUB_ORDER.indexOf(c);
      return idx === -1 ? 999 : idx;
    };

    // --- UTILS ---
    function loadData() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch(e) { return []; }
    }

    function formatDate(dateStr) {
      // Transforme YYYY-MM-DD ou DD/MM/YYYY en objet Date
      if(!dateStr) return null;
      if(dateStr.includes('-')) return new Date(dateStr); 
      const parts = dateStr.split('/');
      return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      globalHistory = loadData();
      updateKPIs();
      initRadar(); // Charge le graph 1 par d√©faut
    });

    function switchTab(tabName, btnEl) {
      document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
      btnEl.classList.add('active');

      document.getElementById('viewRadar').classList.add('hidden');
      document.getElementById('viewMapping').classList.add('hidden');
      document.getElementById('viewCaddie').classList.add('hidden');

      if(tabName === 'radar') {
        document.getElementById('viewRadar').classList.remove('hidden');
        updateRadarChart();
      } else if(tabName === 'mapping') {
        document.getElementById('viewMapping').classList.remove('hidden');
        updateMappingChart();
      } else if(tabName === 'caddie') {
        document.getElementById('viewCaddie').classList.remove('hidden');
      }
    }

    function updateKPIs() {
      const count = globalHistory.length;
      const sessions = new Set(globalHistory.map(x => x.session_id || x.date_text)).size;
      
      const counts = {};
      globalHistory.forEach(x => { if(x.club) counts[x.club] = (counts[x.club]||0)+1; });
      let fav = "-", max = 0;
      for(let [c, n] of Object.entries(counts)){ if(n>max){ max=n; fav=c;} }

      document.getElementById('kpiCount').textContent = count;
      document.getElementById('kpiSessions').textContent = sessions;
      document.getElementById('kpiFav').textContent = fav;

      // Remplir le selecteur de club du radar
      const clubSelect = document.getElementById('radarClubSelect');
      clubSelect.innerHTML = '<option value="all">Tous les clubs</option>';
      const uniqueClubs = Object.keys(counts).sort((a,b) => getClubRank(a) - getClubRank(b));
      uniqueClubs.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        clubSelect.appendChild(opt);
      });
    }

    // --- CHART 1 : RADAR (Dispersion) ---
    let radarChart = null;

    function initRadar() { updateRadarChart(); }

    function updateRadarChart() {
      const sClub = document.getElementById('radarClubSelect').value;
      const sContext = document.getElementById('radarContext').value;
      const sDateStart = document.getElementById('radarStart').valueAsDate;
      const sDateEnd = document.getElementById('radarEnd').valueAsDate;

      // Filtrage
      const filtered = globalHistory.filter(r => {
        // Putter inclus maintenant !
        if (!r.ecart_lateral_m || !r.ecart_profondeur_m) return false;
        
        if (sClub !== 'all' && r.club !== sClub) return false;
        if (sContext !== 'all' && r.radar_usage !== sContext) return false;
        
        if (sDateStart || sDateEnd) {
          const d = formatDate(r.date_text);
          if (d) {
            if (sDateStart && d < sDateStart) return false;
            if (sDateEnd && d > sDateEnd) return false;
          }
        }
        return true;
      });

      const dataPoints = filtered.map(r => ({
        x: Number(r.ecart_lateral_m),
        y: Number(r.ecart_profondeur_m)
      }));

      const ctx = document.getElementById('canvasRadar').getContext('2d');
      if(radarChart) radarChart.destroy();

      radarChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Impacts',
            data: dataPoints,
            backgroundColor: 'rgba(251, 191, 36, 0.5)', // Jaune transparent
            borderColor: 'rgba(251, 191, 36, 1)',
            borderWidth: 1,
            pointRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display:true, text:'Gauche (-) / Droite (+)', color:'#6b7280' },
              grid: { color:'#374151' },
              // MODIF : Pas de min/max forc√©, auto-scale
            },
            y: {
              title: { display:true, text:'Court (-) / Long (+)', color:'#6b7280' },
              grid: { color:'#374151' },
            }
          },
          plugins: { legend: { display:false } }
        }
      });
    }

    // --- CHART 2 : MAPPING (Vue A√©rienne) ---
    let mappingChart = null;

    function updateMappingChart() {
      const sContext = document.getElementById('mapContext').value;
      const sType = document.getElementById('mapType').value;

      // 1. Grouper par Club
      const clubsData = {};
      
      globalHistory.forEach(r => {
        if(!r.club) return;
        if(sContext !== 'all' && r.radar_usage !== sContext) return;
        if(sType !== 'all' && r.shot_type !== sType) return;
        
        const dist = Number(r.distance_totale_m);
        const lat = Number(r.ecart_lateral_m);
        
        // On a besoin de la distance totale pour ce graph
        if(!dist) return; 

        if(!clubsData[r.club]) clubsData[r.club] = [];
        clubsData[r.club].push({ x: lat || 0, y: dist });
      });

      // 2. Cr√©er les datasets (1 par club pour avoir des couleurs)
      const datasets = [];
      const sortedClubs = Object.keys(clubsData).sort((a,b) => getClubRank(a) - getClubRank(b));

      sortedClubs.forEach((clubName, index) => {
        // Couleur cyclique
        const color = CLUB_COLORS[index % CLUB_COLORS.length];
        
        datasets.push({
          label: clubName,
          data: clubsData[clubName],
          backgroundColor: color,
          borderColor: color,
          pointRadius: 4,
          pointHoverRadius: 6
        });
      });

      const ctx = document.getElementById('canvasMapping').getContext('2d');
      if(mappingChart) mappingChart.destroy();

      mappingChart = new Chart(ctx, {
        type: 'scatter',
        data: { datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              display: true,
              position: 'bottom',
              labels: { boxWidth: 10, font: { size: 10 }, color: '#9ca3af' }
            },
            tooltip: {
              callbacks: {
                label: (c) => `${c.dataset.label}: ${c.parsed.y}m (Lat: ${c.parsed.x}m)`
              }
            }
          },
          scales: {
            x: {
              title: { display:true, text:'Dispersion Lat√©rale (m)', color:'#6b7280' },
              grid: { color:'#374151' },
              suggestedMin: -30, suggestedMax: 30 // Garde une largeur coh√©rente pour le fairway
            },
            y: {
              title: { display:true, text:'Distance Totale (m)', color:'#6b7280' },
              grid: { color:'#374151' },
              beginAtZero: true
            }
          }
        }
      });
    }

    // --- CHART 3 : CADDIE ---
    function askCaddie() {
      const target = Number(document.getElementById('caddieDist').value);
      if(!target) return;

      // Calcul stats
      const clubStats = {};
      globalHistory.forEach(r => {
        if(!r.club || r.club === 'Putter') return;
        const d = Number(r.distance_totale_m);
        if(!d || d < 5) return;
        
        if(!clubStats[r.club]) clubStats[r.club] = { sum:0, count:0, sumLat:0 };
        clubStats[r.club].sum += d;
        clubStats[r.club].sumLat += Math.abs(Number(r.ecart_lateral_m)||0);
        clubStats[r.club].count++;
      });

      let best = null;
      let minDiff = 9999;

      for(let c in clubStats) {
        const avg = clubStats[c].sum / clubStats[c].count;
        const diff = Math.abs(avg - target);
        if(diff < minDiff) { minDiff = diff; best = c; }
      }

      if(!best) { alert("Pas assez de donn√©es."); return; }

      const s = clubStats[best];
      const avgD = Math.round(s.sum/s.count);
      const avgL = Math.round(s.sumLat/s.count);

      document.getElementById('caddieEmpty').classList.add('hidden');
      document.getElementById('caddieOutput').classList.remove('hidden');
      
      document.getElementById('recClubName').textContent = best;
      document.getElementById('recClubAvg').textContent = avgD;
      document.getElementById('recClubDisp').textContent = "¬±" + avgL;
      document.getElementById('recNbShots').textContent = s.count;

      // Confiance
      const badge = document.getElementById('recConf');
      badge.className = "confidence-badge";
      if(s.count < 5) { badge.textContent="Faible (Peu de donn√©es)"; badge.classList.add('conf-low'); }
      else if(avgL > 15) { badge.textContent="Moyenne (Dispersion)"; badge.classList.add('conf-med'); }
      else { badge.textContent="√âlev√©e"; badge.classList.add('conf-high'); }
    }

  </script>

  <script>
    const RENDER_URL = "https://todogolf-analyse.onrender.com/";
    function pingRender() { try { fetch(RENDER_URL, { method: "HEAD", mode: "no-cors" }).catch(() => {}); } catch (e) {} }
    pingRender(); setInterval(pingRender, 5*60*1000);
  </script>
</body>
</html>
