<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Lab by ToDoGolf ‚Äì Historique</title>
  <style>
    :root {
      --gap: 14px;
      --primary: #00503a;
      --bg: #050608;
      --card: #0f1419;
      --border: #182028;
      --text: #e7e8ea;
      --muted: #b8c0cc;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
    }
    .hidden { display:none !important; }

    /* Topbar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(to bottom, #050608, rgba(5,6,8,0.9));
      border-bottom: 1px solid #121822;
      padding: 10px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .top-left {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-dot {
      width:20px;
      height:20px;
      border-radius:999px;
      background:var(--primary);
      box-shadow:0 0 12px rgba(0,80,58,0.7);
    }
    .top-title {
      font-weight:600;
      font-size:15px;
    }
    .top-sub {
      font-size:11px;
      color:#8b9aaa;
    }
    .top-actions {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .btn-top {
      border-radius:999px;
      border:1px solid #26303b;
      background:#0b1016;
      padding:6px 10px;
      font-size:12px;
      color:var(--text);
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn-top:hover { background:#101822; }

    .export-warning {
      flex-basis:100%;
      text-align:right;
      font-size:11px;
      color:#facc15;
      margin-top:4px;
    }

    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 40px;
    }

    .page-title {
      font-size:22px;
      font-weight:600;
      margin:10px 0 6px;
    }
    .page-subtitle {
      font-size:13px;
      color:#9aa5b1;
      margin-bottom:14px;
    }

    .layout {
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:16px;
    }

    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,0.4);
    }

    .card-title {
      font-size:15px;
      font-weight:600;
      margin-bottom:10px;
    }
    .card-subtitle {
      font-size:12px;
      color:#9aa5b1;
      margin-bottom:10px;
    }

    label {
      font-size: 12px;
      color:#b8c0cc;
      margin-bottom:4px;
      display:block;
    }
    input[type=text],
    input[type=number],
    input[type=date],
    select {
      width:100%;
      padding:8px 10px;
      border:1px solid #26303b;
      border-radius:10px;
      font-size:13px;
      background:#05080c;
      color:var(--text);
      margin-bottom:8px;
    }

    button {
      display:inline-block;
      text-align:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #26303b;
      background:#11171e;
      color:var(--text);
      font-weight:600;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }
    button.primary {
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
      box-shadow:0 4px 12px rgba(0,80,58,0.45);
    }
    button.primary:hover {
      background:#046046;
    }
    button:disabled {
      opacity:0.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .filters-actions {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    table {
      width:100%;
      border-collapse: collapse;
      font-size:13px;
      margin-top:8px;
    }
    thead {
      background:#05080c;
    }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid #202833;
      text-align:left;
      vertical-align:middle;
    }
    th {
      font-size:12px;
      color:#9aa5b1;
      text-transform:uppercase;
      letter-spacing:0.04em;
      user-select:none;
    }
    .sortable {
      cursor:pointer;
    }
    tbody tr:nth-child(even) {
      background:#0b1117;
    }

    .tag {
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      background:#071015;
      border:1px solid #1c3b2f;
      color:#d1fae5;
    }

    .status-bar {
      font-size:12px;
      color:#9aa5b1;
      margin-top:6px;
    }

    .empty-state {
      font-size:13px;
      color:#9aa5b1;
      padding:8px 0;
    }

    /* Heatmap */
    .heatmap-grid {
      margin-top:8px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid #202833;
    }
    .heatmap-grid table {
      margin:0;
    }
    .heatmap-grid th,
    .heatmap-grid td {
      text-align:center;
    }
    .heatmap-grid thead {
      background:#05080c;
    }

    .heat-legend {
      margin-top:6px;
      font-size:11px;
      color:#9aa5b1;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Tabs (vue brutes / heatmap) */
    .view-tabs {
      display:inline-flex;
      border-radius:999px;
      background:#05080c;
      border:1px solid #202533;
      padding:2px;
      margin-bottom:10px;
    }
    .view-tab {
      border:none;
      background:transparent;
      padding:6px 12px;
      font-size:12px;
      border-radius:999px;
      color:#9aa5b1;
      cursor:pointer;
    }
    .view-tab--active {
      background:#0f172a;
      color:#e5f0ff;
    }

    /* Bouton de suppression */
    .delete-btn {
      border-radius:999px;
      border:1px solid #4b5563;
      background:#111827;
      color:#fca5a5;
      font-size:11px;
      padding:3px 8px;
      cursor:pointer;
      line-height:1;
    }
    .delete-btn:hover {
      background:#7f1d1d;
      border-color:#fca5a5;
      color:#fee2e2;
    }

    /* Popup suppression */
    .delete-popup-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:200;
    }
    .delete-popup-card {
      background:#0b1117;
      border-radius:16px;
      border:1px solid #374151;
      padding:16px 18px;
      max-width:320px;
      width:90%;
      box-shadow:0 18px 40px rgba(0,0,0,0.7);
    }
    .delete-title {
      font-size:15px;
      font-weight:600;
      margin-bottom:6px;
    }
    .delete-text {
      font-size:13px;
      color:#d1d5db;
      margin-bottom:14px;
    }
    .delete-actions {
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .btn-ghost {
      background:#020617;
      border-color:#374151;
      color:#e5e7eb;
    }
    .btn-ghost:hover {
      background:#111827;
    }

    @media (max-width:900px){
      .layout {
        grid-template-columns:1fr;
      }
    }

    @media (max-width:720px){
      .topbar {
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      .top-actions {
        width:100%;
        justify-content:flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="top-left">
      <div class="brand-dot"></div>
      <div>
        <div class="top-title">Lab by ToDoGolf</div>
        <div class="top-sub">Historique des coups & analyse</div>
      </div>
    </div>
    <div class="top-actions">
      <a href="index.html" class="btn-top">‚Üê Accueil</a>
      <button id="btnImport" class="btn-top">‚¨ÜÔ∏è Importer CSV</button>
      <button id="btnExport" class="btn-top">‚¨áÔ∏è Exporter CSV</button>
      <input type="file" id="importInput" accept=".csv,text/csv" style="display:none;">
      <div id="exportWarning" class="export-warning hidden"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="page-title">Historique de vos coups</div>
    <div class="page-subtitle">
      Les donn√©es affich√©es ici proviennent de votre navigateur (localStorage).<br>
      Vous pouvez filtrer, exporter ou r√©importer vos coups depuis un autre appareil.
    </div>

    <div class="layout">
      <!-- Filtres -->
      <div class="card">
        <div class="card-title">Filtres</div>
        <div class="card-subtitle">Ajustez les crit√®res pour analyser une partie pr√©cise de votre historique.</div>

        <label for="fDateFrom">Date min</label>
        <input type="date" id="fDateFrom">

        <label for="fDateTo">Date max</label>
        <input type="date" id="fDateTo">

        <label for="fClub">Club</label>
        <select id="fClub">
          <option value="">Tous les clubs</option>
        </select>

        <label for="fDistMin">Distance cible min (m)</label>
        <input type="number" id="fDistMin" placeholder="ex: 50">

        <label for="fDistMax">Distance cible max (m)</label>
        <input type="number" id="fDistMax" placeholder="ex: 120">

        <label for="fRadarType">Type de radar</label>
        <select id="fRadarType">
          <option value="all">Tous</option>
          <option value="putting">Putting</option>
          <option value="petit_jeu">Petit jeu</option>
          <option value="long_jeu">Long jeu</option>
        </select>

        <div class="filters-actions">
          <button id="btnApply" class="primary">Appliquer les filtres</button>
          <button id="btnReset">R√©initialiser</button>
        </div>

        <div id="filterInfo" class="status-bar"></div>
      </div>

      <!-- R√©sultats -->
      <div class="card">
        <div class="card-title">Vue des donn√©es</div>
        <div class="view-tabs">
          <button id="tabRawBtn"  class="view-tab view-tab--active" type="button">Donn√©es brutes</button>
          <button id="tabHeatBtn" class="view-tab" type="button">Heatmap</button>
        </div>

        <!-- Vue Donn√©es brutes -->
        <div id="viewRaw">
          <div class="card-subtitle">
            Chaque ligne correspond √† un coup enregistr√© dans votre historique.
          </div>

          <div id="rawTableContainer">
            <table>
              <thead id="rawHead">
                <tr>
                  <th data-sort="date_text" data-label="Date" class="sortable">Date</th>
                  <th data-sort="club" data-label="Club" class="sortable">Club</th>
                  <th data-sort="distance_cible_m" data-label="Dist. cible" class="sortable">Dist. cible</th>
                  <th data-sort="radar_info" data-label="Radar" class="sortable">Radar</th>
                  <th data-sort="distance_totale_m" data-label="Dist. totale" class="sortable">Dist. totale</th>
                  <th data-sort="ecart_lateral_m" data-label="√âcart lat." class="sortable">√âcart lat.</th>
                  <th data-sort="ecart_profondeur_m" data-label="√âcart prof." class="sortable">√âcart prof.</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="rawBody">
                <tr><td colspan="8" class="empty-state">Chargement‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Vue Heatmap -->
        <div id="viewHeat" class="hidden">
          <div class="card-subtitle">
            R√©partition des coups selon l‚Äô√©cart lat√©ral (gauche / droite) et profondeur (court / long).
          </div>

          <div class="heatmap-grid">
            <table>
              <thead>
                <tr>
                  <th></th>
                  <th>Gauche</th>
                  <th>Centre</th>
                  <th>Droite</th>
                </tr>
              </thead>
              <tbody id="heatBody">
                <!-- rempli en JS -->
              </tbody>
            </table>
          </div>

          <div class="heat-legend">
            <div>Profondeur (lignes) : haut = long, milieu = cible, bas = court</div>
            <div>Lat√©ral (colonnes) : gauche / centre / droite</div>
            <div id="heatInfo"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup suppression -->
  <div id="deletePopup" class="delete-popup-overlay hidden">
    <div class="delete-popup-card">
      <div class="delete-title">Supprimer ce coup ?</div>
      <div class="delete-text">
        √ätes-vous s√ªr de vouloir supprimer ce coup de votre historique ?<br>
        Cette action est d√©finitive.
      </div>
      <div class="delete-actions">
        <button id="deleteCancelBtn" class="btn-ghost">Annuler</button>
        <button id="deleteConfirmBtn" class="primary">Oui, supprimer</button>
      </div>
    </div>
  </div>

  <script>
    const HISTORY_KEY = "todogolf_lab_history";
    const EXPORT_META_KEY = "todogolf_lab_last_export_count";

    const $ = id => document.getElementById(id);

    const rawBody    = $("rawBody");
    const heatBody   = $("heatBody");
    const heatInfo   = $("heatInfo");
    const filterInfo = $("filterInfo");
    const exportWarning = $("exportWarning");

    const fDateFrom  = $("fDateFrom");
    const fDateTo    = $("fDateTo");
    const fClub      = $("fClub");
    const fDistMin   = $("fDistMin");
    const fDistMax   = $("fDistMax");
    const fRadarType = $("fRadarType");

    const btnApply   = $("btnApply");
    const btnReset   = $("btnReset");
    const btnImport  = $("btnImport");
    const btnExport  = $("btnExport");
    const importInput = $("importInput");

    const tabRawBtn  = $("tabRawBtn");
    const tabHeatBtn = $("tabHeatBtn");
    const viewRaw    = $("viewRaw");
    const viewHeat   = $("viewHeat");

    const deletePopup      = $("deletePopup");
    const deleteCancelBtn  = $("deleteCancelBtn");
    const deleteConfirmBtn = $("deleteConfirmBtn");

    const rawHead = $("rawHead");

    let allRows = [];
    let filteredRows = [];
    let pendingDeleteIndex = null; // index dans allRows

    let sortField = null;
    let sortDir = "asc";

    function setView(view) {
      if (view === "raw") {
        viewRaw.classList.remove("hidden");
        viewHeat.classList.add("hidden");
        tabRawBtn.classList.add("view-tab--active");
        tabHeatBtn.classList.remove("view-tab--active");
      } else {
        viewRaw.classList.add("hidden");
        viewHeat.classList.remove("hidden");
        tabHeatBtn.classList.add("view-tab--active");
        tabRawBtn.classList.remove("view-tab--active");
      }
    }

    function parseStoredHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch(e) {
        console.error("Erreur parse history", e);
        return [];
      }
    }

    function formatDateTextToISO(dateText) {
      if (!dateText || typeof dateText !== "string") return null;
      const parts = dateText.split("/");
      if (parts.length !== 3) return null;
      const [dd, mm, yyyy] = parts;
      if (!dd || !mm || !yyyy) return null;
      return `${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`;
    }

    function parseISODate(str) {
      if (!str) return null;
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d;
    }

    function getRadarTypeKey(radarInfo) {
      if (!radarInfo) return null;
      const s = String(radarInfo).toLowerCase();
      if (s.startsWith("putting")) return "putting";
      if (s.startsWith("petit jeu")) return "petit_jeu";
      if (s.startsWith("long jeu")) return "long_jeu";
      return null;
    }

    function loadHistory() {
      allRows = parseStoredHistory();
      populateClubFilter();
      applyFilters();
      updateExportWarning();
    }

    function populateClubFilter() {
      const clubs = new Set();
      allRows.forEach(r => {
        if (r.club) clubs.add(String(r.club));
      });
      const current = fClub.value;
      fClub.innerHTML = '<option value="">Tous les clubs</option>';
      Array.from(clubs).sort().forEach(club => {
        const opt = document.createElement("option");
        opt.value = club;
        opt.textContent = club;
        fClub.appendChild(opt);
      });
      if (current && clubs.has(current)) {
        fClub.value = current;
      }
    }

    function applyFilters() {
      const dfStr = fDateFrom.value;
      const dtStr = fDateTo.value;
      const df = parseISODate(dfStr);
      const dt = parseISODate(dtStr);
      const club = fClub.value;
      const radarType = fRadarType.value;

      const distMin = fDistMin.value ? Number(fDistMin.value) : null;
      const distMax = fDistMax.value ? Number(fDistMax.value) : null;

      filteredRows = allRows.filter(r => {
        if (df || dt) {
          const iso = formatDateTextToISO(r.date_text);
          const d = parseISODate(iso);
          if (!d) return false;
          if (df && d < df) return false;
          if (dt && d > dt) return false;
        }

        if (club && r.club !== club) return false;

        if (distMin !== null && Number(r.distance_cible_m) < distMin) return false;
        if (distMax !== null && Number(r.distance_cible_m) > distMax) return false;

        if (radarType && radarType !== "all") {
          const key = getRadarTypeKey(r.radar_info);
          if (key !== radarType) return false;
        }

        return true;
      });

      applySort();
      renderRawTable();
      renderHeatmap();
      updateFilterInfo();
      updateSortIndicators();
    }

    function updateFilterInfo() {
      const total = allRows.length;
      const n = filteredRows.length;
      if (!total) {
        filterInfo.textContent = "Aucune donn√©e enregistr√©e pour le moment.";
        return;
      }
      if (n === total) {
        filterInfo.textContent = `${n} coup(s) affich√©(s) ‚Äì aucun filtre appliqu√©.`;
      } else {
        filterInfo.textContent = `${n} coup(s) affich√©(s) sur ${total} au total (filtres actifs).`;
      }
    }

    function renderRawTable() {
      rawBody.innerHTML = "";
      if (!filteredRows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 8;
        td.className = "empty-state";
        td.textContent = "Aucun coup ne correspond aux filtres actuels.";
        tr.appendChild(td);
        rawBody.appendChild(tr);
        return;
      }

      filteredRows.forEach(r => {
        const tr = document.createElement("tr");

        const cDate = document.createElement("td");
        cDate.textContent = r.date_text || "‚Äî";

        const cClub = document.createElement("td");
        cClub.textContent = r.club || "‚Äî";

        const cDistCible = document.createElement("td");
        cDistCible.textContent = (r.distance_cible_m != null ? r.distance_cible_m + " m" : "‚Äî");

        const cRadar = document.createElement("td");
        if (r.radar_info) {
          const span = document.createElement("span");
          span.className = "tag";
          span.textContent = r.radar_info;
          cRadar.appendChild(span);
        } else {
          cRadar.textContent = "‚Äî";
        }

        const cDistTot = document.createElement("td");
        cDistTot.textContent = (r.distance_totale_m != null ? r.distance_totale_m + " m" : "‚Äî");

        const cLat = document.createElement("td");
        cLat.textContent = (r.ecart_lateral_m != null ? r.ecart_lateral_m + " m" : "‚Äî");

        const cProf = document.createElement("td");
        cProf.textContent = (r.ecart_profondeur_m != null ? r.ecart_profondeur_m + " m" : "‚Äî");

        const cDel = document.createElement("td");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "delete-btn";
        btn.textContent = "‚úï";
        const idxGlobal = allRows.indexOf(r);
        btn.dataset.index = idxGlobal >= 0 ? String(idxGlobal) : "";
        cDel.appendChild(btn);

        tr.appendChild(cDate);
        tr.appendChild(cClub);
        tr.appendChild(cDistCible);
        tr.appendChild(cRadar);
        tr.appendChild(cDistTot);
        tr.appendChild(cLat);
        tr.appendChild(cProf);
        tr.appendChild(cDel);

        rawBody.appendChild(tr);
      });
    }

    // Buckets : 3x3 (profondeur x lat√©ral)
    // Lat√©ral : 0 = gauche, 1 = centre, 2 = droite
    function bucketLat(x) {
      if (x == null || isNaN(x)) return null;
      if (x < -2) return 0;   // gauche
      if (x >  2) return 2;   // droite
      return 1;               // centre
    }

    // Profondeur (vertical) : 0 = long (haut), 1 = cible (milieu), 2 = court (bas)
    function bucketProf(y) {
      if (y == null || isNaN(y)) return null;
      if (y > 2)  return 0;   // long
      if (y < -2) return 2;   // court
      return 1;               // cible
    }

    function renderHeatmap() {
      const grid = [
        [0,0,0], // long
        [0,0,0], // cible
        [0,0,0]  // court
      ];

      filteredRows.forEach(r => {
        const x = Number(r.ecart_lateral_m);
        const y = Number(r.ecart_profondeur_m);
        const i = bucketProf(y);
        const j = bucketLat(x);
        if (i === null || j === null) return;
        grid[i][j] += 1;
      });

      const labelsRows = ["Long", "Cible", "Court"];

      let maxCount = 0;
      grid.forEach(row => row.forEach(v => { if (v > maxCount) maxCount = v; }));

      heatBody.innerHTML = "";

      for (let i = 0; i < 3; i++) {
        const tr = document.createElement("tr");

        const th = document.createElement("th");
        th.textContent = labelsRows[i];
        tr.appendChild(th);

        for (let j = 0; j < 3; j++) {
          const count = grid[i][j];
          const td = document.createElement("td");

          if (count === 0) {
            td.style.background = "#05080c";
            td.style.color = "#64748b";
          } else {
            const ratio = maxCount > 0 ? (count / maxCount) : 0;
            const hue = 120 - 120 * ratio; // 120 = vert, 0 = rouge
            const saturation = 80;
            const lightness = 45;
            td.style.background = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            td.style.color = "#f9fafb";
            td.style.fontWeight = "600";
          }

          td.textContent = count;
          tr.appendChild(td);
        }
        heatBody.appendChild(tr);
      }

      if (!filteredRows.length) {
        heatInfo.textContent = "Aucune donn√©e pour construire la heatmap.";
      } else {
        heatInfo.textContent = maxCount > 0
          ? `Cellule la plus dense : ${maxCount} coup(s).`
          : "Aucune donn√©e mesurable (√©carts non renseign√©s).";
      }
    }

    function resetFilters() {
      fDateFrom.value = "";
      fDateTo.value   = "";
      fClub.value     = "";
      fDistMin.value  = "";
      fDistMax.value  = "";
      fRadarType.value = "all";
      applyFilters();
    }

    function downloadCSV(filename, content) {
      const blob = new Blob([content], {type: "text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportHistory() {
      if (!allRows.length) {
        alert("Aucune donn√©e √† exporter.");
        return;
      }
      const headers = [
        "date_text",
        "club",
        "distance_cible_m",
        "radar_info",
        "distance_totale_m",
        "ecart_lateral_m",
        "ecart_profondeur_m"
      ];

      const rows = [headers.join(",")];
      allRows.forEach(r => {
        const line = headers.map(h => {
          const v = r[h] != null ? String(r[h]) : "";
          return v.replace(/"/g,'""');
        }).join(",");
        rows.push(line);
      });

      const csv = rows.join("\n");
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");

      // Mise √† jour de la "photo" d'export
      try {
        localStorage.setItem(EXPORT_META_KEY, String(allRows.length));
      } catch (e) {}

      downloadCSV(`todogolf-historique-${yyyy}-${mm}-${dd}.csv`, csv);
      updateExportWarning();
    }

    // Cl√© unique pour √©viter les doublons √† l'import
    function rowKey(r) {
      return [
        r.date_text || "",
        r.club || "",
        r.distance_cible_m ?? "",
        r.radar_info || "",
        r.distance_totale_m ?? "",
        r.ecart_lateral_m ?? "",
        r.ecart_profondeur_m ?? ""
      ].join("|");
    }

    function importCSVText(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (!lines.length) return;
      const headerLine = lines[0];
      const headers = headerLine.split(",");
      const idx = {
        date_text: headers.indexOf("date_text"),
        club: headers.indexOf("club"),
        distance_cible_m: headers.indexOf("distance_cible_m"),
        radar_info: headers.indexOf("radar_info"),
        distance_totale_m: headers.indexOf("distance_totale_m"),
        ecart_lateral_m: headers.indexOf("ecart_lateral_m"),
        ecart_profondeur_m: headers.indexOf("ecart_profondeur_m")
      };

      if (idx.date_text === -1 || idx.club === -1) {
        alert("Le fichier CSV ne contient pas les colonnes attendues (au minimum date_text et club).");
        return;
      }

      const existing = parseStoredHistory();
      const existingKeys = new Set(existing.map(rowKey));

      const imported = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const cols = line.split(",");
        if (!cols.length || cols.every(c => !c.trim())) continue;

        const row = {
          date_text: cols[idx.date_text] || "",
          club: cols[idx.club] || "",
          distance_cible_m: idx.distance_cible_m >= 0 ? Number(cols[idx.distance_cible_m] || "") : null,
          radar_info: idx.radar_info >= 0 ? (cols[idx.radar_info] || "") : "",
          distance_totale_m: idx.distance_totale_m >= 0 ? Number(cols[idx.distance_totale_m] || "") : null,
          ecart_lateral_m: idx.ecart_lateral_m >= 0 ? Number(cols[idx.ecart_lateral_m] || "") : null,
          ecart_profondeur_m: idx.ecart_profondeur_m >= 0 ? Number(cols[idx.ecart_profondeur_m] || "") : null
        };

        const k = rowKey(row);
        if (existingKeys.has(k)) {
          // doublon ‚Üí on ignore
          continue;
        }
        existingKeys.add(k);
        imported.push(row);
      }

      if (!imported.length) {
        alert("Aucune nouvelle donn√©e √† ajouter (les coups semblent d√©j√† pr√©sents dans votre historique).");
        return;
      }

      const merged = existing.concat(imported);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(merged));
      loadHistory();
      alert(`${imported.length} ligne(s) import√©e(s) et ajout√©e(s) √† votre historique.`);
    }

    // Suppression
    function openDeletePopup(globalIndex) {
      if (globalIndex == null || globalIndex < 0 || globalIndex >= allRows.length) return;
      pendingDeleteIndex = globalIndex;
      deletePopup.classList.remove("hidden");
    }

    function closeDeletePopup() {
      pendingDeleteIndex = null;
      deletePopup.classList.add("hidden");
    }

    function confirmDelete() {
      if (pendingDeleteIndex == null || pendingDeleteIndex < 0 || pendingDeleteIndex >= allRows.length) {
        closeDeletePopup();
        return;
      }
      allRows.splice(pendingDeleteIndex, 1);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(allRows));
      closeDeletePopup();
      loadHistory(); // rafra√Æchit la table + heatmap + filtres + warning
    }

    // Tri
    function applySort() {
      if (!sortField) return;
      const numericFields = new Set([
        "distance_cible_m",
        "distance_totale_m",
        "ecart_lateral_m",
        "ecart_profondeur_m"
      ]);

      filteredRows.sort((a, b) => {
        let va, vb;

        if (sortField === "date_text") {
          const da = parseISODate(formatDateTextToISO(a.date_text)) || new Date(0);
          const db = parseISODate(formatDateTextToISO(b.date_text)) || new Date(0);
          va = da.getTime();
          vb = db.getTime();
        } else if (numericFields.has(sortField)) {
          va = a[sortField];
          vb = b[sortField];
          va = (va == null || isNaN(Number(va))) ? NaN : Number(va);
          vb = (vb == null || isNaN(Number(vb))) ? NaN : Number(vb);
        } else {
          va = a[sortField] != null ? String(a[sortField]) : "";
          vb = b[sortField] != null ? String(b[sortField]) : "";
        }

        let cmp = 0;
        if (sortField === "date_text" || numericFields.has(sortField)) {
          if (isNaN(va) && isNaN(vb)) cmp = 0;
          else if (isNaN(va)) cmp = 1;
          else if (isNaN(vb)) cmp = -1;
          else cmp = va - vb;
        } else {
          cmp = va.localeCompare(vb, "fr", { sensitivity: "base" });
        }

        return sortDir === "asc" ? cmp : -cmp;
      });
    }

    function updateSortIndicators() {
      if (!rawHead) return;
      const ths = rawHead.querySelectorAll("th");
      ths.forEach(th => {
        const field = th.dataset.sort;
        const base = th.dataset.label || th.textContent.replace(/[‚ñ≤‚ñº]\s*$/, "").trim();
        if (!field) {
          th.textContent = base;
          return;
        }
        if (field === sortField) {
          const arrow = sortDir === "asc" ? " ‚ñ≤" : " ‚ñº";
          th.textContent = base + arrow;
        } else {
          th.textContent = base;
        }
      });
    }

    function updateExportWarning() {
      if (!exportWarning) return;
      const total = allRows.length;
      let lastCount = 0;
      try {
        const val = localStorage.getItem(EXPORT_META_KEY);
        if (val) lastCount = Number(val) || 0;
      } catch (e) {
        lastCount = 0;
      }
      const diff = total - lastCount;
      if (diff > 0) {
        exportWarning.textContent = `‚ö†Ô∏è ${diff} coup(s) non export√©(s). Pensez √† t√©l√©charger votre CSV.`;
        exportWarning.classList.remove("hidden");
      } else {
        exportWarning.textContent = "";
        exportWarning.classList.add("hidden");
      }
    }

    // Listeners
    btnApply.addEventListener("click", applyFilters);
    btnReset.addEventListener("click", resetFilters);

    btnExport.addEventListener("click", exportHistory);
    btnImport.addEventListener("click", () => importInput.click());
    importInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        importCSVText(ev.target.result);
        importInput.value = "";
      };
      reader.readAsText(file, "utf-8");
    });

    tabRawBtn.addEventListener("click", () => setView("raw"));
    tabHeatBtn.addEventListener("click", () => setView("heat"));

    // Click sur la croix de suppression (d√©l√©gation)
    rawBody.addEventListener("click", (e) => {
      const btn = e.target.closest(".delete-btn");
      if (!btn) return;
      const idxStr = btn.dataset.index;
      if (idxStr === undefined || idxStr === "") return;
      const idx = Number(idxStr);
      if (Number.isNaN(idx)) return;
      openDeletePopup(idx);
    });

    deleteCancelBtn.addEventListener("click", closeDeletePopup);
    deleteConfirmBtn.addEventListener("click", confirmDelete);

    // Tri par clic sur les en-t√™tes
    if (rawHead) {
      rawHead.addEventListener("click", (e) => {
        const th = e.target.closest("th");
        if (!th) return;
        const field = th.dataset.sort;
        if (!field) return;
        if (sortField === field) {
          sortDir = (sortDir === "asc") ? "desc" : "asc";
        } else {
          sortField = field;
          sortDir = "asc";
        }
        applySort();
        renderRawTable();
        updateSortIndicators();
      });
    }

    // Init
    setView("raw");
    loadHistory();
  </script>

  <script>
    const RENDER_URL = "https://todogolf-analyse.onrender.com/";

    // Fonction ping Render
    function pingRender() {
      fetch(RENDER_URL, {
        method: "HEAD",
        mode: "no-cors"
      }).catch(() => {});
    }

    // üî∏ Ping au chargement de la page
    pingRender();

    // üî∏ Ping toutes les 5 minutes
    setInterval(pingRender, 5 * 60 * 1000);
  </script>
</body>
</html>
