<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>ToDoGolf Lab – Historique</title>
  <style>
    /* --- CSS D'ORIGINE CONSERVÉ --- */
    :root {
      --gap: 14px;
      --primary: #00503a;
      --bg: #050608;
      --card: #0f1419;
      --border: #182028;
      --text: #e7e8ea;
      --muted: #b8c0cc;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #06141a 0, #020309 55%, #000 100%);
      color: var(--text);
    }
    .hidden { display:none !important; }

    /* Topbar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(to bottom, rgba(5,6,8,0.96), rgba(5,6,8,0.88));
      border-bottom: 1px solid #10151e;
      padding: 10px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      backdrop-filter: blur(14px);
      gap:8px;
    }
    .top-left {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-dot {
      width:22px;
      height:22px;
      border-radius:999px;
      background:var(--primary);
      box-shadow:0 0 16px rgba(0,80,58,0.85);
    }
    .top-title {
      font-weight:600;
      font-size:16px;
    }
    .top-sub {
      font-size:11px;
      color:#8b9aaa;
    }

    .top-actions {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .btn-top {
      border-radius:999px;
      border:1px solid #26303b;
      background:#0b1016;
      padding:6px 10px;
      font-size:12px;
      color:var(--text);
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-top:hover { background:#101822; }

    .export-warning {
      font-size:11px;
      color:#fbbf24;
      background:rgba(251,191,36,0.06);
      border-radius:999px;
      border:1px solid rgba(251,191,36,0.4);
      padding:4px 8px;
      white-space:nowrap;
    }

    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 40px;
    }

    .page-title {
      font-size:22px;
      font-weight:600;
      margin:10px 0 6px;
    }
    .page-subtitle {
      font-size:13px;
      color:#9aa5b1;
      margin-bottom:14px;
    }

    .layout {
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:16px;
    }

    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,0.4);
    }

    .card-title {
      font-size:15px;
      font-weight:600;
      margin-bottom:10px;
    }
    .card-subtitle {
      font-size:12px;
      color:#9aa5b1;
      margin-bottom:10px;
    }

    label {
      font-size: 12px;
      color:#b8c0cc;
      margin-bottom:4px;
      display:block;
    }
    input[type=text],
    input[type=number],
    input[type=date],
    select {
      width:100%;
      padding:8px 10px;
      border:1px solid #26303b;
      border-radius:10px;
      font-size:13px;
      background:#05080c;
      color:var(--text);
      margin-bottom:8px;
    }

    button {
      display:inline-block;
      text-align:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #26303b;
      background:#11171e;
      color:var(--text);
      font-weight:600;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }
    button.primary {
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
      box-shadow:0 4px 12px rgba(0,80,58,0.45);
    }
    button.primary:hover {
      background:#046046;
    }
    button:disabled {
      opacity:0.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .filters-actions {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    table {
      width:100%;
      border-collapse: collapse;
      font-size:13px;
      margin-top:8px;
    }
    thead {
      background:#05080c;
    }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid #202833;
      text-align:left;
      vertical-align:middle;
    }
    th {
      font-size:12px;
      color:#9aa5b1;
      text-transform:uppercase;
      letter-spacing:0.04em;
      cursor:pointer;
    }
    th.sort-asc::after {
      content:" ↑";
      font-size:10px;
      opacity:0.8;
    }
    th.sort-desc::after {
      content:" ↓";
      font-size:10px;
      opacity:0.8;
    }
    tbody tr:nth-child(even) {
      background:#0b1117;
    }

    .tag {
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      background:#071015;
      border:1px solid #1c3b2f;
      color:#d1fae5;
    }

    .status-bar {
      font-size:12px;
      color:#9aa5b1;
      margin-top:6px;
    }

    .empty-state {
      font-size:13px;
      color:#9aa5b1;
      padding:8px 0;
    }

    /* Tabs (brutes / heatmap) */
    .view-tabs {
      display:inline-flex;
      border-radius:999px;
      background:#05080c;
      border:1px solid #202533;
      padding:2px;
      margin-bottom:10px;
    }
    .view-tab {
      border:none;
      background:transparent;
      padding:6px 12px;
      font-size:12px;
      border-radius:999px;
      color:#9aa5b1;
      cursor:pointer;
    }
    .view-tab--active {
      background:#0f172a;
      color:#e5f0ff;
    }

    /* Bouton suppression */
    .delete-btn {
      border-radius:999px;
      border:1px solid #4b5563;
      background:#111827;
      color:#fca5a5;
      font-size:11px;
      padding:3px 8px;
      cursor:pointer;
      line-height:1;
    }
    .delete-btn:hover {
      background:#7f1d1d;
      border-color:#fca5a5;
      color:#fee2e2;
    }

    /* Pagination */
    .pagination {
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:#9aa5b1;
      gap:8px;
      flex-wrap:wrap;
    }
    .pagination-buttons {
      display:flex;
      gap:6px;
    }
    .pagination button {
      padding:4px 8px;
      font-size:12px;
    }

    /* Popup suppression */
    .delete-popup-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:200;
    }
    .delete-popup-card {
      background:#0b1117;
      border-radius:16px;
      border:1px solid #374151;
      padding:16px 18px;
      max-width:320px;
      width:90%;
      box-shadow:0 18px 40px rgba(0,0,0,0.7);
    }
    .delete-title {
      font-size:15px;
      font-weight:600;
      margin-bottom:6px;
    }
    .delete-text {
      font-size:13px;
      color:#d1d5db;
      margin-bottom:14px;
    }
    .delete-actions {
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .btn-ghost {
      background:#020617;
      border-color:#374151;
      color:#e5e7eb;
    }
    .btn-ghost:hover {
      background:#111827;
    }
    
    @media (max-width:900px){
      .layout {
        grid-template-columns:1fr;
      }
    }

    @media (max-width:720px){
      .topbar {
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      .top-actions {
        width:100%;
        justify-content:flex-start;
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="top-left">
      <div class="brand-dot"></div>
      <div>
        <div class="top-title">ToDoGolf Lab – Analyse & Performance</div>
        <div class="top-sub">Outils d’analyse pour vos radars papier</div>
      </div>
    </div>
    <div class="top-actions">
      <a href="index.html" class="btn-top">← Accueil</a>
      <span id="exportWarning" class="export-warning hidden">
        ⚠️ Des coups n’ont pas encore été exportés
      </span>
      <button id="btnImport" class="btn-top">⬆️ Importer CSV</button>
      <button id="btnExport" class="btn-top">⬇️ Exporter CSV</button>
      <input type="file" id="importInput" accept=".csv,text/csv" style="display:none;">
    </div>
  </header>

  <main class="wrap">
    <div class="page-title">Historique de vos coups</div>
    <div class="page-subtitle">
      Les données affichées ici proviennent de votre navigateur (<strong>localStorage</strong>).<br>
      Vous pouvez filtrer, trier, paginer, exporter ou réimporter vos coups depuis un autre appareil.
    </div>

    <div class="layout">
      <section class="card">
        <div class="card-title">Filtres</div>
        <div class="card-subtitle">
          Commencez par choisir un type de radar, puis ajustez les autres critères et cliquez sur « Appliquer les filtres ».
        </div>

        <label for="fRadarType">Condition</label>
        <select id="fRadarType">
          <option value="">— Toutes —</option>
        </select>

        <label for="fDateFrom">Date min</label>
        <input type="date" id="fDateFrom">

        <label for="fDateTo">Date max</label>
        <input type="date" id="fDateTo">

        <label for="fClub">Club</label>
        <select id="fClub">
          <option value="">Tous les clubs</option>
        </select>

        <label for="fDistMin">Distance cible min (m)</label>
        <input type="number" id="fDistMin" placeholder="ex: 50">

        <label for="fDistMax">Distance cible max (m)</label>
        <input type="number" id="fDistMax" placeholder="ex: 120">

        <div class="filters-actions">
          <button id="btnApply" class="primary" type="button">Appliquer les filtres</button>
          <button id="btnReset" type="button">Réinitialiser</button>
        </div>

        <div id="filterInfo" class="status-bar"></div>
      </section>

      <section class="card">
        <div class="card-title">Vue des données</div>
        <div id="viewRaw">
          <div class="card-subtitle">
            Chaque ligne correspond à un coup enregistré dans votre historique.
          </div>

          <div id="rawTableContainer">
            <table>
              <thead>
                <tr>
                  <th data-sort="date">Date</th>
                  <th data-sort="club">Club</th>
                  <th data-sort="dist_cible">Dist. cible</th>
                  <th data-sort="radar">Condition</th>
                  <th data-sort="dist_totale">Dist. totale</th>
                  <th data-sort="lat">Écart lat.</th>
                  <th data-sort="prof">Écart prof.</th>
                  <th data-sort="none"></th>
                </tr>
              </thead>
              <tbody id="rawBody">
                <tr><td colspan="8" class="empty-state">Chargement…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="pagination">
            <div id="paginationInfo">Page 1 / 1</div>
            <div class="pagination-buttons">
              <button id="prevPageBtn" type="button">Précédent</button>
              <button id="nextPageBtn" type="button">Suivant</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div id="deletePopup" class="delete-popup-overlay hidden">
    <div class="delete-popup-card">
      <div class="delete-title">Supprimer ce coup ?</div>
      <div class="delete-text">
        Êtes-vous sûr de vouloir supprimer ce coup de votre historique ?<br>
        Cette action est définitive.
      </div>
      <div class="delete-actions">
        <button id="deleteCancelBtn" class="btn-ghost" type="button">Annuler</button>
        <button id="deleteConfirmBtn" class="primary" type="button">Oui, supprimer</button>
      </div>
    </div>
  </div>

  <script>
    const HISTORY_KEY = "todogolf_lab_history";
    const LAST_EXPORT_COUNT_KEY = "todogolf_lab_last_export_count";

    const $ = id => document.getElementById(id);

    const rawBody   = $("rawBody");
    const filterInfo = $("filterInfo");
    const exportWarning = $("exportWarning");

    const fDateFrom = $("fDateFrom");
    const fDateTo   = $("fDateTo");
    const fClub     = $("fClub");
    const fDistMin  = $("fDistMin");
    const fDistMax  = $("fDistMax");
    const fRadarType= $("fRadarType");

    const btnApply  = $("btnApply");
    const btnReset  = $("btnReset");
    const btnImport = $("btnImport");
    const btnExport = $("btnExport");
    const importInput = $("importInput");

    const deletePopup       = $("deletePopup");
    const deleteCancelBtn   = $("deleteCancelBtn");
    const deleteConfirmBtn = $("deleteConfirmBtn");

    const paginationInfo = $("paginationInfo");
    const prevPageBtn = $("prevPageBtn");
    const nextPageBtn = $("nextPageBtn");

    const ROWS_PER_PAGE = 30;

    let allRows = [];
    let filteredRows = [];
    let currentPage = 1;
    let totalPages = 1;

    let sortState = { column: "date", direction: "asc" };

    let pendingDeleteIndex = null;

    function parseStoredHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch(e) {
        console.error("Erreur parse history", e);
        return [];
      }
    }

    function formatDateTextToISO(dateText) {
      if (!dateText || typeof dateText !== "string") return null;
      const parts = dateText.split("/");
      if (parts.length !== 3) return null;
      const [dd, mm, yyyy] = parts;
      if (!dd || !mm || !yyyy) return null;
      return `${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`;
    }

    function parseISODate(str) {
      if (!str) return null;
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d;
    }

    function loadHistory() {
      allRows = parseStoredHistory();
      populateClubFilter();
      populateRadarFilter(); // AJOUTÉ : Charge les radars disponibles
      applyFilters(); 
      updateExportWarning();
    }

    function populateClubFilter() {
      const clubs = new Set();
      allRows.forEach(r => {
        if (r.club) clubs.add(String(r.club));
      });
      const current = fClub.value;
      fClub.innerHTML = '<option value="">Tous les clubs</option>';
      Array.from(clubs).sort().forEach(club => {
        const opt = document.createElement("option");
        opt.value = club;
        opt.textContent = club;
        fClub.appendChild(opt);
      });
      if (current && clubs.has(current)) {
        fClub.value = current;
      }
    }

    // NOUVELLE FONCTION : Remplit la liste des radars
    function populateRadarFilter() {
      const radars = new Set();
      allRows.forEach(r => {
        if (r.radar_info) radars.add(String(r.radar_info));
      });
      
      const current = fRadarType.value;
      fRadarType.innerHTML = '<option value="">— Tous les radars —</option>';
      
      Array.from(radars).sort().forEach(info => {
        const opt = document.createElement("option");
        opt.value = info;
        opt.textContent = info;
        fRadarType.appendChild(opt);
      });

      if (current && radars.has(current)) {
        fRadarType.value = current;
      }
    }

    function applyFilters() {
      const dfStr = fDateFrom.value;
      const dtStr = fDateTo.value;
      const df = parseISODate(dfStr);
      const dt = parseISODate(dtStr);
      const club = fClub.value;
      const radarType = fRadarType.value;

      const distMin = fDistMin.value ? Number(fDistMin.value) : null;
      const distMax = fDistMax.value ? Number(fDistMax.value) : null;

      filteredRows = allRows.filter(r => {
        if (df || dt) {
          const iso = formatDateTextToISO(r.date_text);
          const d = parseISODate(iso);
          if (!d) return false;
          if (df && d < df) return false;
          if (dt && d > dt) return false;
        }

        if (club && r.club !== club) return false;

        if (distMin !== null && Number(r.distance_cible_m) < distMin) return false;
        if (distMax !== null && Number(r.distance_cible_m) > distMax) return false;

        // MODIFIÉ : Comparaison directe avec radar_info
        if (radarType && r.radar_info !== radarType) return false;

        return true;
      });

      currentPage = 1;
      sortFilteredRows();
      renderRawTable();
      updateFilterInfo();
    }

    function updateFilterInfo() {
      const total = allRows.length;
      const n = filteredRows.length;
      if (!total) {
        filterInfo.textContent = "Aucune donnée enregistrée pour le moment.";
        return;
      }
      if (n === total) {
        filterInfo.textContent = `${n} coup(s) affiché(s) – aucun filtre appliqué.`;
      } else {
        filterInfo.textContent = `${n} coup(s) affiché(s) sur ${total} au total (filtres actifs).`;
      }
    }

    function compareValues(a, b) {
      if (a == null && b == null) return 0;
      if (a == null) return -1;
      if (b == null) return 1;
      if (typeof a === "number" && typeof b === "number") {
        return a - b;
      }
      const sa = String(a);
      const sb = String(b);
      return sa.localeCompare(sb);
    }

    function sortFilteredRows() {
      const col = sortState.column;
      const dir = sortState.direction === "asc" ? 1 : -1;
      filteredRows.sort((r1, r2) => {
        let v1, v2;
        switch(col) {
          case "date":
            v1 = parseISODate(formatDateTextToISO(r1.date_text));
            v2 = parseISODate(formatDateTextToISO(r2.date_text));
            break;
          case "club":
            v1 = r1.club || "";
            v2 = r2.club || "";
            break;
          case "dist_cible":
            v1 = Number(r1.distance_cible_m);
            v2 = Number(r2.distance_cible_m);
            break;
          case "radar":
            v1 = r1.radar_info || "";
            v2 = r2.radar_info || "";
            break;
          case "dist_totale":
            v1 = Number(r1.distance_totale_m);
            v2 = Number(r2.distance_totale_m);
            break;
          case "lat":
            v1 = Number(r1.ecart_lateral_m);
            v2 = Number(r2.ecart_lateral_m);
            break;
          case "prof":
            v1 = Number(r1.ecart_profondeur_m);
            v2 = Number(r2.ecart_profondeur_m);
            break;
          default:
            v1 = 0; v2 = 0;
        }
        return compareValues(v1, v2) * dir;
      });
    }

    function renderRawTable() {
      rawBody.innerHTML = "";
      if (!filteredRows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 8;
        td.className = "empty-state";
        td.textContent = "Aucun coup ne correspond aux filtres actuels.";
        tr.appendChild(td);
        rawBody.appendChild(tr);
        paginationInfo.textContent = "Page 0 / 0";
        prevPageBtn.disabled = true;
        nextPageBtn.disabled = true;
        return;
      }

      totalPages = Math.max(1, Math.ceil(filteredRows.length / ROWS_PER_PAGE));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * ROWS_PER_PAGE;
      const end = start + ROWS_PER_PAGE;
      const pageRows = filteredRows.slice(start, end);

      pageRows.forEach(r => {
        const tr = document.createElement("tr");

        const cDate = document.createElement("td");
        cDate.textContent = r.date_text || "—";

        const cClub = document.createElement("td");
        cClub.textContent = r.club || "—";

        const cDistCible = document.createElement("td");
        cDistCible.textContent = (r.distance_cible_m != null ? r.distance_cible_m + " m" : "—");

        const cRadar = document.createElement("td");
        if (r.radar_info) {
          const span = document.createElement("span");
          span.className = "tag";
          span.textContent = r.radar_info;
          cRadar.appendChild(span);
        } else {
          cRadar.textContent = "—";
        }

        const cDistTot = document.createElement("td");
        cDistTot.textContent = (r.distance_totale_m != null ? r.distance_totale_m + " m" : "—");

        const cLat = document.createElement("td");
        cLat.textContent = (r.ecart_lateral_m != null ? r.ecart_lateral_m + " m" : "—");

        const cProf = document.createElement("td");
        cProf.textContent = (r.ecart_profondeur_m != null ? r.ecart_profondeur_m + " m" : "—");

        const cDel = document.createElement("td");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "delete-btn";
        btn.textContent = "✕";
        const idxGlobal = allRows.indexOf(r);
        btn.dataset.index = idxGlobal >= 0 ? String(idxGlobal) : "";
        cDel.appendChild(btn);

        tr.appendChild(cDate);
        tr.appendChild(cClub);
        tr.appendChild(cDistCible);
        tr.appendChild(cRadar);
        tr.appendChild(cDistTot);
        tr.appendChild(cLat);
        tr.appendChild(cProf);
        tr.appendChild(cDel);

        rawBody.appendChild(tr);
      });

      paginationInfo.textContent = `Page ${currentPage} / ${totalPages}`;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
      updateSortHeaders();
    }

    function resetFilters() {
      fRadarType.value = ""; // Reset à vide pour 'tous les radars'
      fDateFrom.value = "";
      fDateTo.value   = "";
      fClub.value     = "";
      fDistMin.value  = "";
      fDistMax.value  = "";
      applyFilters();
    }

    function downloadCSV(filename, content) {
      const blob = new Blob([content], {type: "text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportHistory() {
      if (!allRows.length) {
        alert("Aucune donnée à exporter.");
        return;
      }
      const headers = [
        "session_id", "date_text", "club", "distance_cible_m",
        "radar_info", "distance_totale_m", "ecart_lateral_m", "ecart_profondeur_m"
      ];

      const rows = [headers.join(",")];
      allRows.forEach(r => {
        const line = headers.map(h => {
          const v = r[h] != null ? String(r[h]) : "";
          return v.replace(/"/g,'""');
        }).join(",");
        rows.push(line);
      });

      const csv = rows.join("\n");
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      downloadCSV(`todogolf-historique-${yyyy}-${mm}-${dd}.csv`, csv);

      try {
        localStorage.setItem(LAST_EXPORT_COUNT_KEY, String(allRows.length));
        updateExportWarning();
      } catch(e) {}
    }

    function importCSVText(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (!lines.length) return;
      
      const headerLine = lines[0];
      const headers = headerLine.split(",");
      
      // On map les index des colonnes
      const idx = {
        session_id: headers.indexOf("session_id"),
        date_text: headers.indexOf("date_text"),
        club: headers.indexOf("club"),
        distance_cible_m: headers.indexOf("distance_cible_m"),
        radar_info: headers.indexOf("radar_info"),
        distance_totale_m: headers.indexOf("distance_totale_m"),
        ecart_lateral_m: headers.indexOf("ecart_lateral_m"),
        ecart_profondeur_m: headers.indexOf("ecart_profondeur_m")
      };

      if (Object.values(idx).includes(-1)) {
        alert("Le fichier CSV ne contient pas les colonnes attendues.");
        return;
      }

      // Petite fonction pour éviter que "vide" devienne 0
      const parseNum = (val) => {
        if (!val || val.trim() === "") return null;
        const n = Number(val);
        return isNaN(n) ? null : n;
      };

      const imported = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const cols = line.split(",");
        
        if (!cols.length || cols.every(c => !c.trim())) continue;

        const row = {
          session_id: cols[idx.session_id] || "",
          date_text: cols[idx.date_text] || "",
          club: cols[idx.club] || "",
          distance_cible_m: idx.distance_cible_m >= 0 ? parseNum(cols[idx.distance_cible_m]) : null,
          radar_info: idx.radar_info >= 0 ? (cols[idx.radar_info] || "") : "",
          distance_totale_m: idx.distance_totale_m >= 0 ? parseNum(cols[idx.distance_totale_m]) : null,
          ecart_lateral_m: idx.ecart_lateral_m >= 0 ? parseNum(cols[idx.ecart_lateral_m]) : null,
          ecart_profondeur_m: idx.ecart_profondeur_m >= 0 ? parseNum(cols[idx.ecart_profondeur_m]) : null
        };

        const uniqueKey = [
          row.session_id, 
          row.date_text, 
          row.club, 
          row.distance_cible_m,
          row.radar_info, 
          row.distance_totale_m, 
          row.ecart_lateral_m, 
          row.ecart_profondeur_m
        ].join("|");

        const existing = parseStoredHistory();
        const existingKeys = new Set(
          existing.map(r => {
            return [
              r.session_id, 
              r.date_text, 
              r.club, 
              r.distance_cible_m,
              r.radar_info, 
              r.distance_totale_m, 
              r.ecart_lateral_m, 
              r.ecart_profondeur_m
            ].join("|");
          })
        );

        if (!existingKeys.has(uniqueKey)) {
          imported.push(row);
        }
      }

      if (!imported.length) {
        alert("Aucune nouvelle donnée détectée (les doublons sont ignorés).");
        return;
      }

      const existing = parseStoredHistory();
      const merged = [...existing, ...imported];

      localStorage.setItem(HISTORY_KEY, JSON.stringify(merged));
      loadHistory();
      alert(`${imported.length} ligne(s) ajoutée(s) à votre historique.`);
    }

    // Listeners
    function openDeletePopup(index) {
      pendingDeleteIndex = index;
      deletePopup.classList.remove("hidden");
    }

    function closeDeletePopup() {
      pendingDeleteIndex = null;
      deletePopup.classList.add("hidden");
    }

    function confirmDelete() {
      if (pendingDeleteIndex === null) return;
      allRows.splice(pendingDeleteIndex, 1);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(allRows));
      applyFilters(); 
      updateExportWarning();
      closeDeletePopup();
    }

    function updateExportWarning() {
      try {
        const lastCount = parseInt(localStorage.getItem(LAST_EXPORT_COUNT_KEY) || "0", 10);
        const currentCount = allRows.length;
        if (currentCount > lastCount) {
          exportWarning.classList.remove("hidden");
        } else {
          exportWarning.classList.add("hidden");
        }
      } catch(e) {
        console.error(e);
      }
    }

    function updateSortHeaders() {
      document.querySelectorAll("thead th[data-sort]").forEach(th => {
        th.classList.remove("sort-asc", "sort-desc");
        const col = th.getAttribute("data-sort");
        if (col === sortState.column) {
          th.classList.add(sortState.direction === "asc" ? "sort-asc" : "sort-desc");
        }
      });
    }

    btnApply.addEventListener("click", applyFilters);
    btnReset.addEventListener("click", resetFilters);

    btnExport.addEventListener("click", exportHistory);
    btnImport.addEventListener("click", () => importInput.click());
    importInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        importCSVText(ev.target.result);
        importInput.value = "";
      };
      reader.readAsText(file, "utf-8");
    });

    rawBody.addEventListener("click", (e) => {
      const btn = e.target.closest(".delete-btn");
      if (!btn) return;
      const idxStr = btn.dataset.index;
      if (idxStr === undefined || idxStr === "") return;
      const idx = Number(idxStr);
      if (Number.isNaN(idx)) return;
      openDeletePopup(idx);
    });

    deleteCancelBtn.addEventListener("click", closeDeletePopup);
    deleteConfirmBtn.addEventListener("click", confirmDelete);

    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderRawTable();
      }
    });
    nextPageBtn.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderRawTable();
      }
    });

    document.querySelectorAll("thead th[data-sort]").forEach(th => {
      const col = th.getAttribute("data-sort");
      if (col === "none") return;
      th.addEventListener("click", () => {
        if (sortState.column === col) {
          sortState.direction = sortState.direction === "asc" ? "desc" : "asc";
        } else {
          sortState.column = col;
          sortState.direction = "asc";
        }
        sortFilteredRows();
        currentPage = 1;
        renderRawTable();
      });
    });

    loadHistory();
  </script>

  <script>
    const RENDER_URL = "https://todogolf-analyse.onrender.com/";

    function pingRender() {
      try {
        fetch(RENDER_URL, {
          method: "HEAD",
          mode: "no-cors"
        }).catch(() => {});
      } catch (e) {}
    }

    pingRender();
    setInterval(pingRender, 5 * 60 * 1000);
  </script>
</body>
</html>
