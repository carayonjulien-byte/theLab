<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Lab by ToDoGolf – Historique</title>
  <style>
    :root {
      --gap: 14px;
      --primary: #00503a;
      --bg: #050608;
      --card: #0f1419;
      --border: #182028;
      --text: #e7e8ea;
      --muted: #b8c0cc;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
    }
    .hidden { display:none !important; }

    /* Topbar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(to bottom, #050608, rgba(5,6,8,0.9));
      border-bottom: 1px solid #121822;
      padding: 10px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
    }
    .top-left {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-dot {
      width:20px;
      height:20px;
      border-radius:999px;
      background:var(--primary);
      box-shadow:0 0 12px rgba(0,80,58,0.7);
    }
    .top-title {
      font-weight:600;
      font-size:15px;
    }
    .top-sub {
      font-size:11px;
      color:#8b9aaa;
    }
    .top-actions {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .btn-top {
      border-radius:999px;
      border:1px solid #26303b;
      background:#0b1016;
      padding:6px 10px;
      font-size:12px;
      color:var(--text);
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn-top:hover { background:#101822; }

    .export-notice {
      font-size:11px;
      color:#fbbf24;
      background:rgba(250,204,21,0.06);
      border-radius:999px;
      padding:4px 10px;
      border:1px solid rgba(250,204,21,0.35);
      white-space:nowrap;
    }

    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 40px;
    }

    .page-title {
      font-size:22px;
      font-weight:600;
      margin:10px 0 6px;
    }
    .page-subtitle {
      font-size:13px;
      color:#9aa5b1;
      margin-bottom:14px;
    }

    .layout {
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:16px;
    }

    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,0.4);
    }

    .card-title {
      font-size:15px;
      font-weight:600;
      margin-bottom:10px;
    }
    .card-subtitle {
      font-size:12px;
      color:#9aa5b1;
      margin-bottom:10px;
    }

    label {
      font-size: 12px;
      color:#b8c0cc;
      margin-bottom:4px;
      display:block;
    }
    input[type=text],
    input[type=number],
    input[type=date],
    select {
      width:100%;
      padding:8px 10px;
      border:1px solid #26303b;
      border-radius:10px;
      font-size:13px;
      background:#05080c;
      color:var(--text);
      margin-bottom:8px;
    }

    button {
      display:inline-block;
      text-align:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #26303b;
      background:#11171e;
      color:var(--text);
      font-weight:600;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }
    button.primary {
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
      box-shadow:0 4px 12px rgba(0,80,58,0.45);
    }
    button.primary:hover {
      background:#046046;
    }
    button:disabled {
      opacity:0.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .filters-actions {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    table {
      width:100%;
      border-collapse: collapse;
      font-size:13px;
      margin-top:8px;
    }
    thead {
      background:#05080c;
    }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid #202833;
      text-align:left;
      vertical-align:middle;
    }
    th {
      font-size:12px;
      color:#9aa5b1;
      text-transform:uppercase;
      letter-spacing:0.04em;
      cursor:pointer;
      user-select:none;
    }
    th.sort-active {
      color:#e5f0ff;
    }
    tbody tr:nth-child(even) {
      background:#0b1117;
    }

    .tag {
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      background:#071015;
      border:1px solid #1c3b2f;
      color:#d1fae5;
    }

    .status-bar {
      font-size:12px;
      color:#9aa5b1;
      margin-top:6px;
    }

    .empty-state {
      font-size:13px;
      color:#9aa5b1;
      padding:8px 0;
    }

    /* Tabs (vue brutes / heatmap / œil du pro) */
    .view-tabs {
      display:inline-flex;
      border-radius:999px;
      background:#05080c;
      border:1px solid #202533;
      padding:2px;
      margin-bottom:10px;
    }
    .view-tab {
      border:none;
      background:transparent;
      padding:6px 12px;
      font-size:12px;
      border-radius:999px;
      color:#9aa5b1;
      cursor:pointer;
    }
    .view-tab--active {
      background:#0f172a;
      color:#e5f0ff;
    }

    /* Bouton de suppression */
    .delete-btn {
      border-radius:999px;
      border:1px solid #4b5563;
      background:#111827;
      color:#fca5a5;
      font-size:11px;
      padding:3px 8px;
      cursor:pointer;
      line-height:1;
    }
    .delete-btn:hover {
      background:#7f1d1d;
      border-color:#fca5a5;
      color:#fee2e2;
    }

    /* Popup suppression */
    .delete-popup-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:200;
    }
    .delete-popup-card {
      background:#0b1117;
      border-radius:16px;
      border:1px solid #374151;
      padding:16px 18px;
      max-width:320px;
      width:90%;
      box-shadow:0 18px 40px rgba(0,0,0,0.7);
    }
    .delete-title {
      font-size:15px;
      font-weight:600;
      margin-bottom:6px;
    }
    .delete-text {
      font-size:13px;
      color:#d1d5db;
      margin-bottom:14px;
    }
    .delete-actions {
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .btn-ghost {
      background:#020617;
      border-color:#374151;
      color:#e5e7eb;
    }
    .btn-ghost:hover {
      background:#111827;
    }

    /* Pagination */
    .pagination {
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:#9aa5b1;
    }
    .pagination-controls {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .page-btn {
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      font-size:11px;
      cursor:pointer;
    }
    .page-btn:disabled {
      opacity:0.4;
      cursor:not-allowed;
    }

    /* Heatmap radar */
    .heat-controls {
      margin-bottom:10px;
      font-size:12px;
      color:#9aa5b1;
    }
    .heat-controls label {
      margin-bottom:2px;
    }
    #focusSlider {
      width:100%;
    }
    .heat-focus-label {
      margin-top:4px;
      font-size:11px;
      color:#cbd5e1;
    }
    .heatmap-radar {
      margin-top:8px;
      display:flex;
      justify-content:center;
    }
    #heatCanvas {
      background:#020617;
      border-radius:16px;
      border:1px solid #1f2937;
      max-width:100%;
      height:auto;
    }
    .heat-legend {
      margin-top:6px;
      font-size:11px;
      color:#9aa5b1;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Œil du pro */
    .pro-grid {
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:6px;
    }
    .pro-card {
      background:#05080c;
      border-radius:12px;
      border:1px solid #1f2933;
      padding:10px 12px;
      font-size:12px;
    }
    .pro-label {
      color:#9ca3af;
      margin-bottom:4px;
    }
    .pro-value {
      font-size:16px;
      font-weight:600;
    }
    .pro-hint {
      margin-top:3px;
      font-size:11px;
      color:#6b7280;
    }

    @media (max-width:900px){
      .layout {
        grid-template-columns:1fr;
      }
    }

    @media (max-width:720px){
      .topbar {
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      .top-actions {
        width:100%;
        justify-content:flex-start;
      }
      .pro-grid {
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="top-left">
      <div class="brand-dot"></div>
      <div>
        <div class="top-title">Lab by ToDoGolf</div>
        <div class="top-sub">Historique des coups & analyse</div>
      </div>
    </div>
    <div class="top-actions">
      <span id="exportNotice" class="export-notice hidden"></span>
      <a href="index.html" class="btn-top">← Accueil</a>
      <button id="btnImport" class="btn-top">⬆️ Importer CSV</button>
      <button id="btnExport" class="btn-top">⬇️ Exporter CSV</button>
      <input type="file" id="importInput" accept=".csv,text/csv" style="display:none;">
    </div>
  </div>

  <div class="wrap">
    <div class="page-title">Historique de vos coups</div>
    <div class="page-subtitle">
      Les données affichées ici proviennent de votre navigateur (localStorage).<br>
      Vous pouvez filtrer, exporter ou réimporter vos coups depuis un autre appareil.
    </div>

    <div class="layout">
      <!-- Filtres -->
      <div class="card">
        <div class="card-title">Filtres</div>
        <div class="card-subtitle">Ajustez les critères pour analyser une partie précise de votre historique.</div>

        <label for="fDateFrom">Date min</label>
        <input type="date" id="fDateFrom">

        <label for="fDateTo">Date max</label>
        <input type="date" id="fDateTo">

        <label for="fClub">Club</label>
        <select id="fClub">
          <option value="">Tous les clubs</option>
        </select>

        <label for="fDistMin">Distance cible min (m)</label>
        <input type="number" id="fDistMin" placeholder="ex: 50">

        <label for="fDistMax">Distance cible max (m)</label>
        <input type="number" id="fDistMax" placeholder="ex: 120">

        <label for="fRadarType">Type de radar</label>
        <select id="fRadarType">
          <option value="all">Tous</option>
          <option value="putting">Putting</option>
          <option value="petit_jeu">Petit jeu</option>
          <option value="long_jeu">Long jeu</option>
        </select>

        <div class="filters-actions">
          <button id="btnApply" class="primary">Appliquer les filtres</button>
          <button id="btnReset">Réinitialiser</button>
        </div>

        <div id="filterInfo" class="status-bar"></div>
      </div>

      <!-- Résultats -->
      <div class="card">
        <div class="card-title">Vue des données</div>
        <div class="view-tabs">
          <button id="tabRawBtn"  class="view-tab view-tab--active" type="button">Données brutes</button>
          <button id="tabHeatBtn" class="view-tab" type="button">Heatmap</button>
          <button id="tabProBtn"  class="view-tab" type="button">L’œil du pro</button>
        </div>

        <!-- Vue Données brutes -->
        <div id="viewRaw">
          <div class="card-subtitle">
            Chaque ligne correspond à un coup enregistré dans votre historique.
          </div>

          <div id="rawTableContainer">
            <table>
              <thead>
                <tr>
                  <th data-sort="date">Date</th>
                  <th data-sort="club">Club</th>
                  <th data-sort="dist_cible">Dist. cible</th>
                  <th data-sort="radar">Radar</th>
                  <th data-sort="dist_totale">Dist. totale</th>
                  <th data-sort="ecart_lat">Écart lat.</th>
                  <th data-sort="ecart_prof">Écart prof.</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="rawBody">
                <tr><td colspan="8" class="empty-state">Chargement…</td></tr>
              </tbody>
            </table>
          </div>

          <div id="pagination" class="pagination hidden">
            <div id="paginationInfo"></div>
            <div class="pagination-controls">
              <button id="prevPage" class="page-btn">Préc.</button>
              <button id="nextPage" class="page-btn">Suiv.</button>
            </div>
          </div>
        </div>

        <!-- Vue Heatmap -->
        <div id="viewHeat" class="hidden">
          <div class="card-subtitle">
            Répartition des coups selon l’écart latéral (gauche/droite) et la profondeur (court/long),
            autour d’une distance cible donnée.
          </div>

          <div class="heat-controls">
            <label for="focusSlider">Distance cible focale (m)</label>
            <input type="range" id="focusSlider" min="0" max="200" step="1" />
            <div id="focusLabel" class="heat-focus-label">
              Aucune distance cible disponible.
            </div>
          </div>

          <div class="heatmap-radar">
            <canvas id="heatCanvas" width="320" height="320"></canvas>
          </div>

          <div class="heat-legend">
            <div>Vertical : haut = long, bas = court.</div>
            <div>Horizontal : gauche = balle à gauche, droite = balle à droite.</div>
            <div id="heatInfo"></div>
          </div>
        </div>

        <!-- Vue L’œil du pro -->
        <div id="viewPro" class="hidden">
          <div class="card-subtitle">
            Synthèse des coups actuellement filtrés : tendances générales, biais et fenêtre jouable potentielle.
          </div>
          <div id="proContent" class="pro-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup suppression -->
  <div id="deletePopup" class="delete-popup-overlay hidden">
    <div class="delete-popup-card">
      <div class="delete-title">Supprimer ce coup ?</div>
      <div class="delete-text">
        Êtes-vous sûr de vouloir supprimer ce coup de votre historique ?<br>
        Cette action est définitive.
      </div>
      <div class="delete-actions">
        <button id="deleteCancelBtn" class="btn-ghost">Annuler</button>
        <button id="deleteConfirmBtn" class="primary">Oui, supprimer</button>
      </div>
    </div>
  </div>

  <script>
    const HISTORY_KEY = "todogolf_lab_history";
    const EXPORT_COUNT_KEY = "todogolf_lab_last_export_count";
    const PAGE_SIZE = 30;
    const FOCUS_TOLERANCE = 5; // ±5m autour de la distance cible sélectionnée

    const $ = id => document.getElementById(id);

    const rawBody   = $("rawBody");
    const heatBody  = $("heatBody");  // plus utilisé mais on garde la ref éventuelle
    const heatInfo  = $("heatInfo");
    const filterInfo = $("filterInfo");

    const fDateFrom = $("fDateFrom");
    const fDateTo   = $("fDateTo");
    const fClub     = $("fClub");
    const fDistMin  = $("fDistMin");
    const fDistMax  = $("fDistMax");
    const fRadarType= $("fRadarType");

    const btnApply  = $("btnApply");
    const btnReset  = $("btnReset");
    const btnImport = $("btnImport");
    const btnExport = $("btnExport");
    const importInput = $("importInput");

    const tabRawBtn  = $("tabRawBtn");
    const tabHeatBtn = $("tabHeatBtn");
    const tabProBtn  = $("tabProBtn");
    const viewRaw    = $("viewRaw");
    const viewHeat   = $("viewHeat");
    const viewPro    = $("viewPro");

    const deletePopup      = $("deletePopup");
    const deleteCancelBtn  = $("deleteCancelBtn");
    const deleteConfirmBtn = $("deleteConfirmBtn");

    const paginationEl     = $("pagination");
    const paginationInfo   = $("paginationInfo");
    const prevPageBtn      = $("prevPage");
    const nextPageBtn      = $("nextPage");

    const exportNotice     = $("exportNotice");

    const focusSlider = $("focusSlider");
    const focusLabel  = $("focusLabel");
    const heatCanvas  = $("heatCanvas");
    const proContent  = $("proContent");

    let heatCtx = null;
    if (heatCanvas && heatCanvas.getContext) {
      heatCtx = heatCanvas.getContext("2d");
    }

    let allRows = [];
    let filteredRows = [];
    let pendingDeleteIndex = null; // index dans allRows

    let currentPage = 1;
    let sortConfig = { key: null, direction: "asc" };

    function setView(view) {
      if (view === "raw") {
        viewRaw.classList.remove("hidden");
        viewHeat.classList.add("hidden");
        viewPro.classList.add("hidden");
        tabRawBtn.classList.add("view-tab--active");
        tabHeatBtn.classList.remove("view-tab--active");
        tabProBtn.classList.remove("view-tab--active");
      } else if (view === "heat") {
        viewRaw.classList.add("hidden");
        viewHeat.classList.remove("hidden");
        viewPro.classList.add("hidden");
        tabHeatBtn.classList.add("view-tab--active");
        tabRawBtn.classList.remove("view-tab--active");
        tabProBtn.classList.remove("view-tab--active");
        renderHeatmap();
      } else {
        viewRaw.classList.add("hidden");
        viewHeat.classList.add("hidden");
        viewPro.classList.remove("hidden");
        tabProBtn.classList.add("view-tab--active");
        tabRawBtn.classList.remove("view-tab--active");
        tabHeatBtn.classList.remove("view-tab--active");
        renderProView();
      }
    }

    function parseStoredHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch(e) {
        console.error("Erreur parse history", e);
        return [];
      }
    }

    function formatDateTextToISO(dateText) {
      if (!dateText || typeof dateText !== "string") return null;
      const parts = dateText.split("/");
      if (parts.length !== 3) return null;
      const [dd, mm, yyyy] = parts;
      if (!dd || !mm || !yyyy) return null;
      return `${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`;
    }

    function parseISODate(str) {
      if (!str) return null;
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d;
    }

    function getRadarTypeKey(radarInfo) {
      if (!radarInfo) return null;
      const s = String(radarInfo).toLowerCase();
      if (s.startsWith("putting")) return "putting";
      if (s.startsWith("petit jeu")) return "petit_jeu";
      if (s.startsWith("long jeu")) return "long_jeu";
      return null;
    }

    function updateExportNotice() {
      if (!exportNotice) return;
      const total = allRows.length;
      const lastExportRaw = localStorage.getItem(EXPORT_COUNT_KEY);
      const lastExportCount = lastExportRaw ? Number(lastExportRaw) : 0;
      const diff = total - lastExportCount;
      if (diff > 0) {
        exportNotice.textContent = `⚠️ ${diff} coup(s) ajouté(s) depuis le dernier export`;
        exportNotice.classList.remove("hidden");
      } else {
        exportNotice.textContent = "";
        exportNotice.classList.add("hidden");
      }
    }

    function loadHistory() {
      allRows = parseStoredHistory();
      populateClubFilter();
      applyFilters();
      updateExportNotice();
    }

    function populateClubFilter() {
      const clubs = new Set();
      allRows.forEach(r => {
        if (r.club) clubs.add(String(r.club));
      });
      const current = fClub.value;
      fClub.innerHTML = '<option value="">Tous les clubs</option>';
      Array.from(clubs).sort().forEach(club => {
        const opt = document.createElement("option");
        opt.value = club;
        opt.textContent = club;
        fClub.appendChild(opt);
      });
      if (current && clubs.has(current)) {
        fClub.value = current;
      }
    }

    function applyFilters() {
      const dfStr = fDateFrom.value;
      const dtStr = fDateTo.value;
      const df = parseISODate(dfStr);
      const dt = parseISODate(dtStr);
      const club = fClub.value;
      const radarType = fRadarType.value;

      const distMin = fDistMin.value ? Number(fDistMin.value) : null;
      const distMax = fDistMax.value ? Number(fDistMax.value) : null;

      filteredRows = allRows.filter(r => {
        if (df || dt) {
          const iso = formatDateTextToISO(r.date_text);
          const d = parseISODate(iso);
          if (!d) return false;
          if (df && d < df) return false;
          if (dt && d > dt) return false;
        }

        if (club && r.club !== club) return false;

        if (distMin !== null && Number(r.distance_cible_m) < distMin) return false;
        if (distMax !== null && Number(r.distance_cible_m) > distMax) return false;

        if (radarType && radarType !== "all") {
          const key = getRadarTypeKey(r.radar_info);
          if (key !== radarType) return false;
        }

        return true;
      });

      sortFilteredRows();
      currentPage = 1;
      renderRawTable();
      updateFocusSliderRange();
      renderHeatmap();
      renderProView();
      updateFilterInfo();
    }

    function resetFilters() {
      fDateFrom.value = "";
      fDateTo.value   = "";
      fClub.value     = "";
      fDistMin.value  = "";
      fDistMax.value  = "";
      fRadarType.value = "all";
      applyFilters();
    }

    function updateFilterInfo() {
      const total = allRows.length;
      const n = filteredRows.length;
      if (!total) {
        filterInfo.textContent = "Aucune donnée enregistrée pour le moment.";
        return;
      }
      if (n === total) {
        filterInfo.textContent = `${n} coup(s) affiché(s) – aucun filtre appliqué.`;
      } else {
        filterInfo.textContent = `${n} coup(s) affiché(s) sur ${total} au total (filtres actifs).`;
      }
    }

    /* Tri des colonnes */
    function sortFilteredRows() {
      if (!sortConfig.key) return;
      const dir = sortConfig.direction === "asc" ? 1 : -1;

      filteredRows.sort((a,b) => {
        let va, vb;

        switch (sortConfig.key) {
          case "date":
            va = parseISODate(formatDateTextToISO(a.date_text))?.getTime() || 0;
            vb = parseISODate(formatDateTextToISO(b.date_text))?.getTime() || 0;
            break;
          case "club":
            va = (a.club || "").toLowerCase();
            vb = (b.club || "").toLowerCase();
            break;
          case "dist_cible":
            va = Number(a.distance_cible_m) || 0;
            vb = Number(b.distance_cible_m) || 0;
            break;
          case "radar":
            va = (a.radar_info || "").toLowerCase();
            vb = (b.radar_info || "").toLowerCase();
            break;
          case "dist_totale":
            va = Number(a.distance_totale_m) || 0;
            vb = Number(b.distance_totale_m) || 0;
            break;
          case "ecart_lat":
            va = Number(a.ecart_lateral_m);
            vb = Number(b.ecart_lateral_m);
            if (isNaN(va)) va = 0;
            if (isNaN(vb)) vb = 0;
            break;
          case "ecart_prof":
            va = Number(a.ecart_profondeur_m);
            vb = Number(b.ecart_profondeur_m);
            if (isNaN(va)) va = 0;
            if (isNaN(vb)) vb = 0;
            break;
          default:
            va = 0; vb = 0;
        }

        if (va < vb) return -1 * dir;
        if (va > vb) return  1 * dir;
        return 0;
      });
    }

    function renderRawTable() {
      rawBody.innerHTML = "";
      if (!filteredRows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 8;
        td.className = "empty-state";
        td.textContent = "Aucun coup ne correspond aux filtres actuels.";
        tr.appendChild(td);
        rawBody.appendChild(tr);

        paginationEl.classList.add("hidden");
        return;
      }

      const total = filteredRows.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage - 1) * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, total);
      const slice = filteredRows.slice(start, end);

      slice.forEach(r => {
        const tr = document.createElement("tr");

        const cDate = document.createElement("td");
        cDate.textContent = r.date_text || "—";

        const cClub = document.createElement("td");
        cClub.textContent = r.club || "—";

        const cDistCible = document.createElement("td");
        cDistCible.textContent = (r.distance_cible_m != null ? r.distance_cible_m + " m" : "—");

        const cRadar = document.createElement("td");
        if (r.radar_info) {
          const span = document.createElement("span");
          span.className = "tag";
          span.textContent = r.radar_info;
          cRadar.appendChild(span);
        } else {
          cRadar.textContent = "—";
        }

        const cDistTot = document.createElement("td");
        cDistTot.textContent = (r.distance_totale_m != null ? r.distance_totale_m + " m" : "—");

        const cLat = document.createElement("td");
        cLat.textContent = (r.ecart_lateral_m != null ? r.ecart_lateral_m + " m" : "—");

        const cProf = document.createElement("td");
        cProf.textContent = (r.ecart_profondeur_m != null ? r.ecart_profondeur_m + " m" : "—");

        const cDel = document.createElement("td");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "delete-btn";
        btn.textContent = "✕";
        const idxGlobal = allRows.indexOf(r);
        btn.dataset.index = idxGlobal >= 0 ? String(idxGlobal) : "";
        cDel.appendChild(btn);

        tr.appendChild(cDate);
        tr.appendChild(cClub);
        tr.appendChild(cDistCible);
        tr.appendChild(cRadar);
        tr.appendChild(cDistTot);
        tr.appendChild(cLat);
        tr.appendChild(cProf);
        tr.appendChild(cDel);

        rawBody.appendChild(tr);
      });

      renderPagination();
      updateSortHeadersUI();
    }

    function renderPagination() {
      const total = filteredRows.length;
      if (!total) {
        paginationEl.classList.add("hidden");
        return;
      }
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      paginationEl.classList.remove("hidden");

      paginationInfo.textContent = `Page ${currentPage} / ${totalPages} – ${total} coup(s)`;

      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
    }

    function updateSortHeadersUI() {
      const ths = document.querySelectorAll("th[data-sort]");
      ths.forEach(th => {
        const key = th.dataset.sort;
        if (sortConfig.key === key) {
          th.classList.add("sort-active");
          const arrow = sortConfig.direction === "asc" ? " ▲" : " ▼";
          const label = th.textContent.replace(/[\u25B2\u25BC▲▼]\s*$/,"").replace(/\s*[▲▼]$/,"");
          th.textContent = label + arrow;
        } else {
          th.classList.remove("sort-active");
          th.textContent = th.textContent.replace(/[\u25B2\u25BC▲▼]\s*$/,"").replace(/\s*[▲▼]$/,"");
        }
      });
    }

    /* Heatmap : radar + slider de distance */
    function updateFocusSliderRange() {
      const distValues = filteredRows
        .map(r => Number(r.distance_cible_m))
        .filter(v => !Number.isNaN(v));

      if (!distValues.length) {
        focusSlider.min = "0";
        focusSlider.max = "0";
        focusSlider.value = "0";
        focusSlider.disabled = true;
        focusLabel.textContent = "Aucune distance cible disponible pour les filtres actuels.";
        return;
      }

      const minDist = Math.min(...distValues);
      const maxDist = Math.max(...distValues);
      focusSlider.disabled = false;
      focusSlider.min = String(Math.floor(minDist));
      focusSlider.max = String(Math.ceil(maxDist));

      let current = Number(focusSlider.value);
      if (isNaN(current) || current < minDist || current > maxDist) {
        current = Math.round((minDist + maxDist) / 2);
      }
      focusSlider.value = String(current);
      updateFocusLabel();
    }

    function updateFocusLabel() {
      if (focusSlider.disabled) {
        focusLabel.textContent = "Aucune distance cible disponible pour les filtres actuels.";
        return;
      }
      const val = Number(focusSlider.value);
      focusLabel.textContent = `Distance focale : ${val} m (fenêtre ±${FOCUS_TOLERANCE} m)`;
    }

    function getRowsForHeatmap() {
      if (!filteredRows.length) return [];
      const focusVal = Number(focusSlider.value || 0);
      if (focusSlider.disabled || isNaN(focusVal)) return [];
      return filteredRows.filter(r => {
        const d = Number(r.distance_cible_m);
        if (Number.isNaN(d)) return false;
        return Math.abs(d - focusVal) <= FOCUS_TOLERANCE;
      });
    }

    function clearCanvas() {
      if (!heatCtx || !heatCanvas) return;
      heatCtx.clearRect(0,0,heatCanvas.width, heatCanvas.height);
    }

    function drawRadarBase(ctx, w, h, maxRadiusPx) {
      const cx = w / 2;
      const cy = h / 2;

      ctx.clearRect(0,0,w,h);

      // Fond
      ctx.fillStyle = "#020617";
      ctx.fillRect(0,0,w,h);

      // Cercles
      ctx.lineWidth = 1;
      ctx.strokeStyle = "#1f2937";
      const rings = 4;
      for (let i=1; i<=rings; i++) {
        const r = (maxRadiusPx * i) / rings;
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI*2);
        ctx.stroke();
      }

      // Croix centrale
      ctx.strokeStyle = "#334155";
      ctx.beginPath();
      ctx.moveTo(cx - maxRadiusPx - 4, cy);
      ctx.lineTo(cx + maxRadiusPx + 4, cy);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(cx, cy - maxRadiusPx - 4);
      ctx.lineTo(cx, cy + maxRadiusPx + 4);
      ctx.stroke();

      // Centre
      ctx.fillStyle = "#e5f0ff";
      ctx.beginPath();
      ctx.arc(cx, cy, 3, 0, Math.PI*2);
      ctx.fill();
    }

    function renderHeatmap() {
      if (!heatCtx || !heatCanvas) return;

      const w = heatCanvas.width;
      const h = heatCanvas.height;
      const maxRadiusPx = Math.min(w,h) * 0.38;

      const rows = getRowsForHeatmap();
      drawRadarBase(heatCtx, w, h, maxRadiusPx);

      if (!filteredRows.length) {
        heatInfo.textContent = "Aucune donnée disponible pour les filtres actuels.";
        return;
      }

      if (!rows.length) {
        const val = Number(focusSlider.value || 0);
        heatInfo.textContent = `Aucun coup dans la fenêtre de distance actuelle (${val} m ± ${FOCUS_TOLERANCE} m).`;
        return;
      }

      // Préparation : positions + buckets pour densité
      const points = [];
      let maxR = 0;

      rows.forEach(r => {
        const x = Number(r.ecart_lateral_m);
        const y = Number(r.ecart_profondeur_m);
        if (isNaN(x) || isNaN(y)) return;
        const dist = Math.sqrt(x*x + y*y);
        if (dist > maxR) maxR = dist;
        points.push({ x, y });
      });

      if (!points.length) {
        heatInfo.textContent = "Aucune donnée mesurable (écarts non renseignés).";
        return;
      }

      const cx = w / 2;
      const cy = h / 2;
      const scale = maxR > 0 ? (maxRadiusPx / maxR) : 1;

      // Buckets (pour densité locale)
      const bucketCounts = new Map();
      let maxBucket = 0;
      points.forEach(p => {
        const bx = Math.round(p.x);
        const by = Math.round(p.y);
        const key = bx + "," + by;
        const current = bucketCounts.get(key) || 0;
        const next = current + 1;
        bucketCounts.set(key, next);
        if (next > maxBucket) maxBucket = next;
      });

      // Dessin des points
      points.forEach(p => {
        const bx = Math.round(p.x);
        const by = Math.round(p.y);
        const key = bx + "," + by;
        const count = bucketCounts.get(key) || 1;
        const ratio = maxBucket > 0 ? count / maxBucket : 0;

        const hue = 120 - 120 * ratio; // vert -> rouge
        const saturation = 80;
        const lightness = 50;
        heatCtx.fillStyle = `hsla(${hue}, ${saturation}%, ${lightness}%, 0.85)`;

        const px = cx + p.x * scale;
        const py = cy - p.y * scale; // y positif = long vers le haut

        const radius = 4 + 2 * ratio;
        heatCtx.beginPath();
        heatCtx.arc(px, py, radius, 0, Math.PI*2);
        heatCtx.fill();
      });

      const val = Number(focusSlider.value || 0);
      heatInfo.textContent = `${rows.length} coup(s) dans la fenêtre de distance ${val} m ± ${FOCUS_TOLERANCE} m.`;
    }

    /* Œil du pro */
    function renderProView() {
      proContent.innerHTML = "";
      const n = filteredRows.length;
      if (!n) {
        const div = document.createElement("div");
        div.className = "empty-state";
        div.textContent = "Aucun coup à analyser avec les filtres actuels.";
        proContent.appendChild(div);
        return;
      }

      let sumTarget = 0, countTarget = 0;
      let sumTotal = 0,  countTotal = 0;
      let sumLat = 0, sumAbsLat = 0, countLat = 0;
      let sumProf = 0, sumAbsProf = 0, countProf = 0;
      let playable = 0;
      const WINDOW_LAT = 10;
      const WINDOW_PROF = 10;

      filteredRows.forEach(r => {
        const dCible = Number(r.distance_cible_m);
        if (!isNaN(dCible)) { sumTarget += dCible; countTarget++; }

        const dTot = Number(r.distance_totale_m);
        if (!isNaN(dTot)) { sumTotal += dTot; countTotal++; }

        const x = Number(r.ecart_lateral_m);
        const y = Number(r.ecart_profondeur_m);

        if (!isNaN(x)) { sumLat += x; sumAbsLat += Math.abs(x); countLat++; }
        if (!isNaN(y)) { sumProf += y; sumAbsProf += Math.abs(y); countProf++; }

        if (!isNaN(x) && !isNaN(y)) {
          if (Math.abs(x) <= WINDOW_LAT && Math.abs(y) <= WINDOW_PROF) {
            playable++;
          }
        }
      });

      const avgTarget    = countTarget ? (sumTarget / countTarget) : null;
      const avgTotal     = countTotal ? (sumTotal / countTotal) : null;
      const avgLat       = countLat ? (sumLat / countLat) : null;
      const avgAbsLat    = countLat ? (sumAbsLat / countLat) : null;
      const avgProf      = countProf ? (sumProf / countProf) : null;
      const avgAbsProf   = countProf ? (sumAbsProf / countProf) : null;
      const playableRate = n ? (playable / n * 100) : null;

      function fmt(v, digits=1) {
        if (v == null || isNaN(v)) return "—";
        return v.toFixed(digits);
      }

      const cards = [
        {
          label: "Nombre de coups analysés",
          value: `${n}`,
          hint: "Après filtres (date, club, radar, etc.)."
        },
        {
          label: "Distance cible moyenne (m)",
          value: fmt(avgTarget),
          hint: "Moyenne des distances ciblées sur les coups filtrés."
        },
        {
          label: "Distance totale moyenne (m)",
          value: fmt(avgTotal),
          hint: "Portée moyenne réellement obtenue."
        },
        {
          label: "Biais latéral moyen (m)",
          value: fmt(avgLat),
          hint: "Négatif = plutôt à gauche, positif = plutôt à droite."
        },
        {
          label: "Dispersion latérale moyenne (|m|)",
          value: fmt(avgAbsLat),
          hint: "Écart latéral moyen en valeur absolue."
        },
        {
          label: "Biais profondeur moyen (m)",
          value: fmt(avgProf),
          hint: "Négatif = plutôt court, positif = plutôt long."
        },
        {
          label: "Dispersion profondeur moyenne (|m|)",
          value: fmt(avgAbsProf),
          hint: "Écart profondeur moyen en valeur absolue."
        },
        {
          label: "Fenêtre jouable estimée",
          value: playableRate != null ? fmt(playableRate,1) + " %" : "—",
          hint: `Part des coups dans une zone ±${WINDOW_LAT} m en latéral et ±${WINDOW_PROF} m en profondeur.`
        }
      ];

      cards.forEach(c => {
        const card = document.createElement("div");
        card.className = "pro-card";

        const lab = document.createElement("div");
        lab.className = "pro-label";
        lab.textContent = c.label;

        const val = document.createElement("div");
        val.className = "pro-value";
        val.textContent = c.value;

        const hint = document.createElement("div");
        hint.className = "pro-hint";
        hint.textContent = c.hint;

        card.appendChild(lab);
        card.appendChild(val);
        card.appendChild(hint);

        proContent.appendChild(card);
      });
    }

    /* Export / Import CSV */
    function downloadCSV(filename, content) {
      const blob = new Blob([content], {type: "text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportHistory() {
      if (!allRows.length) {
        alert("Aucune donnée à exporter.");
        return;
      }
      const headers = [
        "date_text",
        "club",
        "distance_cible_m",
        "radar_info",
        "distance_totale_m",
        "ecart_lateral_m",
        "ecart_profondeur_m"
      ];

      const rows = [headers.join(",")];
      allRows.forEach(r => {
        const line = headers.map(h => {
          const v = r[h] != null ? String(r[h]) : "";
          return v.replace(/"/g,'""');
        }).join(",");
        rows.push(line);
      });

      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      downloadCSV(`todogolf-historique-${yyyy}-${mm}-${dd}.csv`, rows.join("\n"));

      // On mémorise le nombre de coups exportés
      localStorage.setItem(EXPORT_COUNT_KEY, String(allRows.length));
      updateExportNotice();
    }

    function importCSVText(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (!lines.length) return;
      const headerLine = lines[0];
      const headers = headerLine.split(",");
      const idx = {
        date_text: headers.indexOf("date_text"),
        club: headers.indexOf("club"),
        distance_cible_m: headers.indexOf("distance_cible_m"),
        radar_info: headers.indexOf("radar_info"),
        distance_totale_m: headers.indexOf("distance_totale_m"),
        ecart_lateral_m: headers.indexOf("ecart_lateral_m"),
        ecart_profondeur_m: headers.indexOf("ecart_profondeur_m")
      };

      if (idx.date_text === -1 || idx.club === -1) {
        alert("Le fichier CSV ne contient pas les colonnes attendues (au minimum date_text et club).");
        return;
      }

      const imported = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const cols = line.split(",");
        if (!cols.length || cols.every(c => !c.trim())) continue;

        const row = {
          date_text: cols[idx.date_text] || "",
          club: cols[idx.club] || "",
          distance_cible_m: idx.distance_cible_m >= 0 ? Number(cols[idx.distance_cible_m] || "") : null,
          radar_info: idx.radar_info >= 0 ? (cols[idx.radar_info] || "") : "",
          distance_totale_m: idx.distance_totale_m >= 0 ? Number(cols[idx.distance_totale_m] || "") : null,
          ecart_lateral_m: idx.ecart_lateral_m >= 0 ? Number(cols[idx.ecart_lateral_m] || "") : null,
          ecart_profondeur_m: idx.ecart_profondeur_m >= 0 ? Number(cols[idx.ecart_profondeur_m] || "") : null
        };
        imported.push(row);
      }

      if (!imported.length) {
        alert("Aucune donnée exploitable trouvée dans ce CSV.");
        return;
      }

      const existing = parseStoredHistory();

      function rowKey(r) {
        return [
          r.date_text || "",
          r.club || "",
          r.distance_cible_m ?? "",
          r.radar_info || "",
          r.distance_totale_m ?? "",
          r.ecart_lateral_m ?? "",
          r.ecart_profondeur_m ?? ""
        ].join("||");
      }

      const seen = new Set(existing.map(rowKey));
      let added = 0;

      imported.forEach(r => {
        const k = rowKey(r);
        if (!seen.has(k)) {
          seen.add(k);
          existing.push(r);
          added++;
        }
      });

      localStorage.setItem(HISTORY_KEY, JSON.stringify(existing));
      loadHistory();
      alert(`${added} nouvelle(s) ligne(s) ajoutée(s) à votre historique.`);
    }

    // Suppression
    function openDeletePopup(globalIndex) {
      if (globalIndex == null || globalIndex < 0 || globalIndex >= allRows.length) return;
      pendingDeleteIndex = globalIndex;
      deletePopup.classList.remove("hidden");
    }

    function closeDeletePopup() {
      pendingDeleteIndex = null;
      deletePopup.classList.add("hidden");
    }

    function confirmDelete() {
      if (pendingDeleteIndex == null || pendingDeleteIndex < 0 || pendingDeleteIndex >= allRows.length) {
        closeDeletePopup();
        return;
      }
      allRows.splice(pendingDeleteIndex, 1);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(allRows));
      closeDeletePopup();
      loadHistory(); // rafraîchit table + heatmap + œil du pro + filtres
    }

    // Listeners
    btnApply.addEventListener("click", applyFilters);
    btnReset.addEventListener("click", resetFilters);

    btnExport.addEventListener("click", exportHistory);
    btnImport.addEventListener("click", () => importInput.click());
    importInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        importCSVText(ev.target.result);
        importInput.value = "";
      };
      reader.readAsText(file, "utf-8");
    });

    tabRawBtn.addEventListener("click", () => setView("raw"));
    tabHeatBtn.addEventListener("click", () => setView("heat"));
    tabProBtn.addEventListener("click", () => setView("pro"));

    // Tri en cliquant sur les en-têtes
    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.dataset.sort;
        if (!key) return;
        if (sortConfig.key === key) {
          sortConfig.direction = (sortConfig.direction === "asc" ? "desc" : "asc");
        } else {
          sortConfig.key = key;
          sortConfig.direction = "asc";
        }
        sortFilteredRows();
        currentPage = 1;
        renderRawTable();
      });
    });

    // Click sur la croix de suppression (délégation)
    rawBody.addEventListener("click", (e) => {
      const btn = e.target.closest(".delete-btn");
      if (!btn) return;
      const idxStr = btn.dataset.index;
      if (idxStr === undefined || idxStr === "") return;
      const idx = Number(idxStr);
      if (Number.isNaN(idx)) return;
      openDeletePopup(idx);
    });

    deleteCancelBtn.addEventListener("click", closeDeletePopup);
    deleteConfirmBtn.addEventListener("click", confirmDelete);

    // Pagination
    prevPageBtn.addEventListener("click", () => {
      if (currentPage <= 1) return;
      currentPage--;
      renderRawTable();
    });
    nextPageBtn.addEventListener("click", () => {
      const total = filteredRows.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (currentPage >= totalPages) return;
      currentPage++;
      renderRawTable();
    });

    // Slider focus
    focusSlider.addEventListener("input", () => {
      updateFocusLabel();
      renderHeatmap();
    });

    // Init
    setView("raw");
    loadHistory();
  </script>

  <script>
    const RENDER_URL = "https://todogolf-analyse.onrender.com/";

    function pingRender() {
      try {
        fetch(RENDER_URL, {
          method: "HEAD",
          mode: "no-cors"
        }).catch(() => {});
      } catch (e) {}
    }

    pingRender();
    setInterval(pingRender, 5 * 60 * 1000);
  </script>
</body>
</html>
